<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anonim Telegram Sohbet</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0f2f5; min-height: 100vh; padding: 20px; }
        .container-app { max-width: 800px; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); margin: 50px auto; }
        .profile-img { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; }
        .chat-container { margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px; }
        .message-box { max-height: 450px; overflow-y: auto; padding: 15px; background-color: #f9f9f9; border-radius: 8px; }
        .system-message { font-size: 0.8em; color: #888; text-align: center; margin: 5px 0; }
        .message-row strong { color: #007bff; }
    </style>
</head>
<body>

<div class="container container-app">
    <div id="loading-screen" class="text-center">
        <h2 class="text-primary">Telegram Verileri YÃ¼kleniyor...</h2>
        <div class="spinner-border text-primary mt-4" role="status">
          <span class="visually-hidden">YÃ¼kleniyor...</span>
        </div>
        <p id="error-message" class="text-danger mt-3" style="display: none;">Hata: Bu siteyi yalnÄ±zca Telegram Web View iÃ§inde aÃ§Ä±n.</p>
    </div>

    <div id="main-screen" style="display: none;">
        <div class="d-flex justify-content-between align-items-center pb-3 border-bottom">
            <h3 class="mb-0 text-success">Anasayfa</h3>
            <div class="d-flex align-items-center">
                <span id="user-name" class="fw-bold me-2 text-info"></span>
                <img id="user-photo" class="profile-img" alt="Profil Resmi">
            </div>
        </div>
        
        <div id="control-panel" class="row mt-4 g-3">
            <div class="col-md-6">
                <button id="create-room-btn" class="btn btn-primary w-100 py-2">âž• Yeni Anonim Oda OluÅŸtur</button>
            </div>
            <div class="col-md-6">
                <div class="input-group">
                    <input type="text" id="room-code-input" class="form-control form-control-lg" placeholder="6 Karakterli Oda Kodunu Girin..." maxlength="6">
                    <button class="btn btn-success btn-lg" type="button" id="join-room-btn">KatÄ±l</button>
                </div>
            </div>
        </div>

        <div id="chat-room" class="chat-container" style="display: none;">
            <h4 id="room-title" class="text-center mb-3 p-2 bg-light rounded"></h4>
            <div class="message-box mb-3" id="messages">
                </div>
            <div class="input-group">
                <input type="text" id="message-input" class="form-control" placeholder="Anonim mesajÄ±nÄ±zÄ± yazÄ±n..." disabled>
                <button class="btn btn-info" type="button" id="send-message-btn" disabled>GÃ¶nder</button>
            </div>
            <button id="leave-room-btn" class="btn btn-danger btn-sm mt-2 w-100">Odadan GÃ¼venle AyrÄ±l</button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
<script src="https://telegram.org/js/telegram-web-app.js"></script> 

<script>
    // âœ… KESÄ°NLEÅžMÄ°Åž RENDER URL'Ä°NÄ°Z
    const BACKEND_URL = "https://chatio-zllq.onrender.com"; 
    
    let user = null;
    let currentRoomCode = null;
    let socket = null;
    let anonimUserName = null; 

    // Uygulama baÅŸlatÄ±ldÄ±ÄŸÄ±nda veya yÃ¼klendiÄŸinde Web View verilerini yakala
    function initApp() {
        const loadingScreen = document.getElementById('loading-screen');
        const errorMessage = document.getElementById('error-message');

        if (window.Telegram && window.Telegram.WebApp) {
            const initData = Telegram.WebApp.initData;
            
            if (!initData) {
                 loadingScreen.style.display = 'none';
                 errorMessage.textContent = 'Hata: Telegram baÅŸlangÄ±Ã§ verisi (initData) eksik.';
                 errorMessage.style.display = 'block';
                 return;
            }

            // initData'yÄ± Arka UÃ§'a doÄŸrulamaya gÃ¶nder
            fetch(`${BACKEND_URL}/api/auth`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ initData: initData }) 
            })
            .then(response => response.json())
            .then(data => {
                loadingScreen.style.display = 'none';
                if (data.success) {
                    user = data.user;
                    initializeMainScreen();
                } else {
                    errorMessage.textContent = 'Yetkilendirme BaÅŸarÄ±sÄ±z: ' + data.message;
                    errorMessage.style.display = 'block';
                }
            })
            .catch(error => {
                loadingScreen.style.display = 'none';
                errorMessage.textContent = 'AÄŸ HatasÄ±: Sunucuya ulaÅŸÄ±lamadÄ±. CORS veya Render ayarlarÄ±nÄ±zÄ± kontrol edin.';
                errorMessage.style.display = 'block';
                console.error('GiriÅŸ Hata:', error);
            });

        } else {
            // Web View dÄ±ÅŸÄ±nda aÃ§Ä±lmÄ±ÅŸsa
            loadingScreen.style.display = 'none';
            errorMessage.textContent = 'Bu uygulama sadece Telegram Web View (Mini App) iÃ§inde Ã§alÄ±ÅŸÄ±r.';
            errorMessage.style.display = 'block';
        }
    }

    document.addEventListener('DOMContentLoaded', initApp);

    function initializeMainScreen() {
        document.getElementById('loading-screen').style.display = 'none';
        document.getElementById('main-screen').style.display = 'block';

        document.getElementById('user-name').textContent = user.first_name || `ID: ${user.id}`;
        document.getElementById('user-photo').src = user.photo_url || 'https://via.placeholder.com/45/007bff/ffffff?text=U';
        
        document.getElementById('create-room-btn').onclick = createRoom;
        document.getElementById('join-room-btn').onclick = () => {
            const code = document.getElementById('room-code-input').value.trim().toUpperCase();
            if (code.length === 6) joinRoom(code);
            else alert('LÃ¼tfen 6 karakterli geÃ§erli bir oda kodu girin.');
        };
    }

    function createRoom() {
        fetch(`${BACKEND_URL}/api/create-room`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ telegramId: user.id })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                joinRoom(data.roomCode);
            } else {
                alert('Oda oluÅŸturulamadÄ±. Sunucu hatasÄ±.');
            }
        })
        .catch(error => console.error('Oda OluÅŸturma Hata:', error));
    }

    function joinRoom(roomCode) {
        if (socket && socket.connected) {
            alert('Ã–ncelikle mevcut odadan ayrÄ±lmalÄ±sÄ±nÄ±z.');
            return;
        }

        currentRoomCode = roomCode;
        
        anonimUserName = `Anonim-${user.first_name || user.id}`.slice(0, 10) + Math.floor(Math.random() * 100);

        document.getElementById('room-title').textContent = `Anonim Oda: ${currentRoomCode}`;
        document.getElementById('chat-room').style.display = 'block';
        document.getElementById('control-panel').style.display = 'none';
        document.getElementById('messages').innerHTML = ''; 
        document.getElementById('message-input').disabled = false;
        document.getElementById('send-message-btn').disabled = false;

        
        socket = io(BACKEND_URL);

        socket.on('connect', () => {
            addSystemMessage('Sunucuya baÄŸlanÄ±ldÄ±. Odaya giriÅŸ yapÄ±lÄ±yor...');
            socket.emit('joinRoom', { roomCode: currentRoomCode, telegramId: user.id, anonName: anonimUserName });
        });
        
        socket.on('roomMessages', (messages) => {
            messages.forEach(displayMessage);
        });

        socket.on('message', displayMessage);

        socket.on('userJoined', (name) => {
            addSystemMessage(`ðŸ‘¤ ${name} odaya katÄ±ldÄ±.`);
        });
        socket.on('userLeft', (name) => {
            addSystemMessage(`ðŸ‘‹ ${name} odadan ayrÄ±ldÄ±.`);
        });
        socket.on('error', (err) => {
            addSystemMessage(`âŒ Hata: ${err}`, 'text-danger');
            leaveRoom();
        });
        socket.on('disconnect', () => {
             addSystemMessage('BaÄŸlantÄ± kesildi. Odadan ayrÄ±ldÄ±nÄ±z.');
             resetChatUI();
        });

        document.getElementById('send-message-btn').onclick = sendMessage;
        document.getElementById('leave-room-btn').onclick = leaveRoom;
        document.getElementById('message-input').onkeyup = (e) => {
             if (e.key === 'Enter') sendMessage();
        };
    }

    function displayMessage(msg) {
        const messagesDiv = document.getElementById('messages');
        const isSelf = msg.anonName === anonimUserName;
        const nameColor = isSelf ? 'text-primary' : 'text-success';
        
        messagesDiv.innerHTML += `
            <p class="mb-1 message-row">
                <strong class="${nameColor}">${msg.anonName}</strong> 
                <span class="text-muted small">(${msg.timestamp}):</span>
                <span class="text-dark">${msg.text}</span>
            </p>`;
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function sendMessage() {
        const input = document.getElementById('message-input');
        const message = input.value.trim();
        if (message && socket && currentRoomCode) {
            socket.emit('sendMessage', { roomCode: currentRoomCode, telegramId: user.id, message });
            input.value = '';
        }
    }
    
    function leaveRoom() {
        if (socket) {
            socket.disconnect();
        } else {
            resetChatUI();
        }
    }

    function resetChatUI() {
        currentRoomCode = null;
        anonimUserName = null;
        document.getElementById('chat-room').style.display = 'none';
        document.getElementById('control-panel').style.display = 'flex';
        document.getElementById('message-input').disabled = true;
        document.getElementById('send-message-btn').disabled = true;
        document.getElementById('messages').innerHTML = '';
    }
    
    function addSystemMessage(text, className = 'text-muted fst-italic') {
        const messagesDiv = document.getElementById('messages');
        messagesDiv.innerHTML += `<p class="system-message ${className}">${text}</p>`;
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
</script>

</body>
</html>
