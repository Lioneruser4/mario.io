<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Az…ôrbaycan Damasƒ± | Professional Edition 2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        /* --- Dama Taxtasƒ± CSS --- */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        
        .board {
            display: grid;
            /* H√ºceyr…ô √∂l√ß√ºl…ôrini adaptiv saxla, maksimum 60px */
            grid-template-columns: repeat(8, min(12vw, 60px));
            grid-template-rows: repeat(8, min(12vw, 60px));
            border: 8px solid #334155; /* Slate-700 */
            box-shadow: 0 15px 25px rgba(0, 0, 0, 0.7);
            border-radius: 12px;
            overflow: hidden;
            touch-action: manipulation;
            margin: 0 auto;
        }
        .cell {
            width: min(12vw, 60px);
            height: min(12vw, 60px);
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.2s;
        }
        .piece {
            width: 85%;
            height: 85%;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: min(4.5vw, 1.8rem);
            font-weight: 900;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
            border: 3px solid;
            cursor: pointer;
            user-select: none;
            transition: transform 0.1s;
        }
        .piece-white { background-color: #f3f4f6; color: #1f2937; border-color: #9ca3af; }
        .piece-black { background-color: #1f2937; color: #f3f4f6; border-color: #4b5563; }
        
        /* Dama (King) effekti */
        @keyframes king-glow {
            0%, 100% { text-shadow: 0 0 10px #fde047, 0 0 5px #000; }
            50% { text-shadow: 0 0 20px #fde047, 0 0 10px #000; }
        }
        .piece-king { animation: king-glow 1.5s ease-in-out infinite alternate; }
        .piece-king-white { background: linear-gradient(135deg, #fde047, #fef08a); color: #1f2937; }
        .piece-king-black { background: linear-gradient(135deg, #374151, #4b5563); color: #fde047; }
        
        /* Vurƒüulama (Highlight) CSS */
        .selected { border: 4px solid #ef4444; transform: scale(1.05); } /* Red-500 */
        .possible-move { background-color: #10b981 !important; cursor: pointer; } /* Emerald-500 */
        .possible-move:hover { background-color: #059669 !important; }
        .mandatory-jump { border: 4px solid #f97316; } /* Orange-500 */

        /* Animasiyalar */
        @keyframes pulse-fast {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-pulse-fast { animation: pulse-fast 0.5s infinite alternate; }
        .title-glow { text-shadow: 0 0 10px #3b82f6, 0 0 20px #3b82f6; } /* Blue-500 */
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { 'primary-dark': '#0f172a', 'secondary-dark': '#1e293b', 'accent': '#3b82f6' },
                }
            }
        }
    </script>
</head>
<body class="bg-primary-dark text-white font-['Inter'] min-h-screen flex flex-col items-center justify-center p-4">

    <header class="text-center mb-6 w-full max-w-4xl">
        <h1 class="text-4xl font-black title-glow text-accent mb-2">AZ∆èRBAYCAN DAMA OYUNU</h1>
        <div id="user-info-display" class="text-xs text-gray-400">
            <span id="user-name-display">ƒ∞stifad…ô√ßi: Y√ºkl…ônir...</span> |
            <span id="current-user-id-display">ID: ...</span>
        </div>
        <div id="connection-status" class="text-sm font-semibold mt-2 text-red-500 animate-pulse-fast">Server…ô qo≈üulur...</div>
    </header>

    <div id="message-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden flex items-center justify-center z-50">
        <div class="bg-secondary-dark p-8 rounded-xl shadow-2xl max-w-sm w-full text-center border-t-4 border-accent">
            <p id="modal-message" class="text-lg font-semibold mb-4 text-white"></p>
            <button id="modal-close-btn" class="w-full bg-accent hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Baƒüla</button>
        </div>
    </div>

    <div id="loader" class="flex flex-col items-center justify-center h-48">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-accent"></div>
        <p class="mt-4 text-lg text-gray-400">Y√ºkl…ônir...</p>
    </div>

    <div id="lobby-screen" class="hidden w-full max-w-md bg-secondary-dark p-6 rounded-xl shadow-2xl">
        <h2 class="text-2xl font-bold text-center text-white mb-4">Oyun Lobisi</h2>
        <p id="lobi-status-message" class="text-center text-sm mb-6 text-gray-300">Oyun rejimi se√ßin.</p>

        <div class="space-y-4">
            <button id="dereceli-btn" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-extrabold py-3 rounded-xl transition duration-300 shadow-lg">
                üèÜ Reytinqli Oyna (Axtar)
            </button>
            <button id="deregeli-cancel-btn" class="hidden w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 rounded-xl transition duration-300">
                Axtarƒ±≈üƒ± L…ôƒüv Et
            </button>

            <div class="relative flex items-center py-2">
                <div class="flex-grow border-t border-gray-600"></div>
                <span class="flex-shrink mx-4 text-gray-500">V∆è YA</span>
                <div class="flex-grow border-t border-gray-600"></div>
            </div>

            <button id="create-room-btn" class="w-full bg-accent hover:bg-blue-700 text-white font-bold py-3 rounded-xl transition duration-300">
                ‚ûï Dostla Oyna (Otaq Yarat)
            </button>
            <div class="text-center text-sm text-gray-400">
                Otaq Kodu: <span id="room-code-output" class="font-mono text-xl text-yellow-400">....</span>
                <button id="copy-code-btn" class="ml-2 text-green-400 hover:text-green-300 text-xs">Kopyala</button>
            </div>

            <div class="flex space-x-2 pt-2">
                <input type="text" id="join-room-input" placeholder="Otaq kodu (4 r…ôq…ôm)" maxlength="4" class="flex-grow p-3 rounded-xl bg-gray-700 text-white placeholder-gray-400 border border-gray-600 focus:border-accent focus:ring-1 focus:ring-accent outline-none">
                <button id="join-room-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-xl transition duration-300">
                    Qo≈üul
                </button>
            </div>
        </div>
    </div>

    <main id="game-screen" class="hidden w-full max-w-4xl flex flex-col items-center justify-center p-4">
        
        <div class="flex flex-col md:flex-row items-start justify-center w-full space-y-6 md:space-y-0 md:space-x-8">
            
            <div class="flex flex-col items-center space-y-4 order-1 md:order-1 w-full max-w-xs">
                <div class="w-full bg-secondary-dark p-3 rounded-xl shadow-lg border-b-4 border-gray-400">
                    <p class="text-sm text-gray-400 font-semibold mb-1">R…ôqib (Aƒü)</p>
                    <div class="flex justify-between items-center">
                        <p id="opponent-name-display" class="font-bold text-lg text-gray-200">G√∂zl…ônilir...</p>
                        <p id="white-timer" class="p-2 rounded-lg font-mono text-2xl text-white shadow-md bg-gray-700 min-w-[80px] text-center">2:00</p>
                    </div>
                </div>
            </div>

            <div id="board-container" class="order-2 md:order-2">
                <div id="board" class="board bg-gray-700">
                    </div>
            </div>

            <div class="flex flex-col items-center space-y-4 order-3 w-full max-w-xs">
                
                <div id="current-turn-display" class="text-lg font-bold p-3 rounded-xl bg-yellow-600 text-white shadow-xl transition duration-300 w-full text-center animate-pulse">
                    Y√ºkl…ônir...
                </div>

                <div id="action-info" class="text-sm text-center text-blue-300 p-2 rounded-lg bg-gray-700 w-full">
                    Da≈üƒ±nƒ±zƒ± se√ßin v…ô h…ôr…ôk…ôt etm…ôk ist…ôdiyiniz xanaya klikl…ôyin.
                </div>

                <div class="w-full bg-secondary-dark p-3 rounded-xl shadow-lg border-b-4 border-black">
                    <p class="text-sm text-gray-400 font-semibold mb-1">Siz (Qara)</p>
                    <div class="flex justify-between items-center">
                        <p id="my-name-display" class="font-bold text-lg text-gray-200">Siz</p>
                        <p id="black-timer" class="p-2 rounded-lg font-mono text-2xl text-white shadow-md bg-gray-700 min-w-[80px] text-center">2:00</p>
                    </div>
                </div>
                
                <button id="leave-game-btn" class="w-full bg-red-700 hover:bg-red-800 text-white font-bold py-2 rounded-xl transition duration-300 mt-4 shadow-xl">
                    Oyunu T…ôrk Et (Uduz)
                </button>
            </div>
        </div>
        
    </main>

    <script>
        // --- Sabitl…ôr v…ô Global D…ôyi≈ü…ônl…ôr ---
        
        // üö® Dƒ∞QQ∆èT: Bu placeholder-i √ñZ RENDER.COM SERVERƒ∞Nƒ∞Zƒ∞N √úNVANI ƒ∞L∆è ∆èV∆èZ EDƒ∞N!
        const SERVER_URL = "YOUR_RENDER_SERVER_URL_HERE"; 

        const BOARD_SIZE = 8;
        
        let socket;
        let currentUserId = null;
        let currentUserName = null;
        let currentRoomId = null;
        let isMyTurn = false;
        let myColor = null; // 'black' v…ô ya 'white'
        
        let boardState = null;
        let selectedPiece = null; // {r, c}
        let mandatoryCapture = null; // {r, c} (√ßoxlu z…ôncird…ô qalmƒ±≈ü da≈ü)
        let possibleMoves = []; // Cari se√ßilmi≈ü da≈ü √º√ß√ºn icaz…ô veril…ôn h…ôr…ôk…ôtl…ôrin siyahƒ±sƒ±

        // --- UI Elementl…ôri ---
        const loader = document.getElementById('loader');
        const lobbyScreen = document.getElementById('lobby-screen');
        const gameScreen = document.getElementById('game-screen');
        const dereceliBtn = document.getElementById('dereceli-btn');
        const deregeliCancelBtn = document.getElementById('deregeli-cancel-btn');
        const boardElement = document.getElementById('board');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        
        // --- Yardƒ±m√ßƒ± Funksiyalar ---

        function getTelegramUser() {
            // Telegram WebApp parametrl…ôrini yoxla
            const urlParams = new URLSearchParams(window.location.search);
            const tgUserId = urlParams.get('tg_user_id') || urlParams.get('id');
            const tgUsername = urlParams.get('tg_username') || urlParams.get('name');

            return {
                id: tgUserId || 'anon_' + Math.random().toString(36).substring(2, 9),
                name: tgUsername ? decodeURIComponent(tgUsername).replace(/<\/?script>/ig, "") : 'Anonim ƒ∞stifad…ô√ßi',
            };
        }

        function showModal(message, callback = null) {
            document.getElementById('modal-message').textContent = message;
            document.getElementById('message-modal').classList.remove('hidden');
            modalCloseBtn.onclick = () => {
                document.getElementById('message-modal').classList.add('hidden');
                if (callback) callback();
            };
        }

        function showScreen(screen) {
            loader.classList.add('hidden');
            lobbyScreen.classList.add('hidden');
            gameScreen.classList.add('hidden');
            deregeliCancelBtn.classList.add('hidden');
            dereceliBtn.classList.remove('hidden');
            
            // Timeri dayandƒ±r
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = null;

            if (screen === 'lobby') {
                lobbyScreen.classList.remove('hidden');
                document.getElementById('lobi-status-message').textContent = 'Oyun rejimi se√ßin.';
                document.getElementById('room-code-output').textContent = '....';
                currentRoomId = null;
                selectedPiece = null;
            } else if (screen === 'game') {
                gameScreen.classList.remove('hidden');
            } else if (screen === 'searching') {
                lobbyScreen.classList.remove('hidden');
                deregeliCancelBtn.classList.remove('hidden');
                dereceliBtn.classList.add('hidden');
                document.getElementById('lobi-status-message').textContent = 'üèÜ Reytinqli R…ôqib axtarƒ±lƒ±r... L√ºtf…ôn g√∂zl…ôyin.';
            } else {
                loader.classList.remove('hidden');
            }
        }

        function formatTime(seconds) {
            const min = Math.floor(seconds / 60);
            const sec = Math.max(0, seconds % 60);
            return `${min}:${sec.toString().padStart(2, '0')}`;
        }
        
        function getPiecePlayer(pieceValue) {
            if (pieceValue === 1 || pieceValue === 3) return 'white';
            if (pieceValue === 2 || pieceValue === 4) return 'black';
            return null;
        }

        function getPieceSymbol(pieceValue) {
            if (pieceValue === 1 || pieceValue === 2) return '‚óè';
            if (pieceValue === 3 || pieceValue === 4) return '‚ôõ';
            return '';
        }

        // --- Dama M…ôntiqi (Yalnƒ±z UI √º√ß√ºn) ---

        function isValidCell(r, c) { return r >= 0 && r < BOARD_SIZE && c >= 0 && c < BOARD_SIZE; }

        /** Da≈üƒ±n t…ôk yem…ô h…ôr…ôk…ôtl…ôrini tapƒ±r. (Serverd…ô daha detallƒ± yoxlama aparƒ±lƒ±r) */
        function findJumps(board, r, c, player) {
            const piece = board[r][c];
            const isKingPiece = piece === 3 || piece === 4;
            const jumps = [];
            
            // Sad…ôc…ô 2 addƒ±m diaqonal (Az…ôrbaycan damasƒ±nda da≈ü king kimi 4 t…ôr…ôf…ô yey…ô bil…ôr)
            const directions = isKingPiece ? [[-1, -1], [-1, 1], [1, -1], [1, 1]] :
                player === 'white' ? [[1, -1], [1, 1]] : [[-1, -1], [-1, 1]];

            for (const [dr, dc] of directions) {
                const capturedR = r + dr;
                const capturedC = c + dc;
                const landR = r + 2 * dr;
                const landC = c + 2 * dc;

                if (isValidCell(landR, landC) && board[landR][landC] === 0) {
                    const capturedPieceValue = board[capturedR]?.[capturedC];
                    const capturedPlayer = getPiecePlayer(capturedPieceValue);

                    if (capturedPlayer && capturedPlayer && capturedPlayer !== player) {
                        jumps.push({ 
                            from: { r, c }, 
                            to: { r: landR, c: landC }, 
                            captured: { r: capturedR, c: capturedC } 
                        });
                    }
                }
            }
            return jumps;
        }

        /** Rekursiv olaraq …ôn uzun yem…ô z…ôncirini tapƒ±r (Serverd…ôn g…ôl…ôn m…ôlumatƒ± t…ôsdiql…ôm…ôk v…ô UI √º√ß√ºn) */
        function findLongestJumpChain(board, r, c, player, currentLength) {
            const possibleNextJumps = findJumps(board, r, c, player);
            let maxChain = currentLength;

            for (const jump of possibleNextJumps) {
                // M√ºv…ôqq…ôti taxta v…ôziyy…ôti yarat
                const nextBoard = JSON.parse(JSON.stringify(board));
                
                // H…ôr…ôk…ôt v…ô yem…ôni simulyasiya et
                nextBoard[jump.to.r][jump.to.c] = board[r][c];
                nextBoard[r][c] = 0;
                nextBoard[jump.captured.r][jump.captured.c] = 0;
                
                // Yeni m√∂vqed…ô z…ôncir…ô davam et
                const newLength = findLongestJumpChain(
                    nextBoard,
                    jump.to.r,
                    jump.to.c,
                    player,
                    currentLength + 1
                );

                if (newLength > maxChain) {
                    maxChain = newLength;
                }
            }
            return maxChain;
        }

        /** B√ºt√ºn taxtada cari oyun√ßu √º√ß√ºn …ôn uzun yem…ô z…ôncirinin uzunluƒüunu tapƒ±r. */
        function getMaxJumpChainLength(board, player) {
            let maxLength = 0;
            for (let r = 0; r < BOARD_SIZE; r++) {
                for (let c = 0; c < BOARD_SIZE; c++) {
                    if (getPiecePlayer(board[r][c]) === player) {
                        const chainLength = findLongestJumpChain(board, r, c, player, 0);
                        if (chainLength > maxLength) {
                            maxLength = chainLength;
                        }
                    }
                }
            }
            return maxLength;
        }

        /**
         * M√ºmk√ºn h…ôr…ôk…ôtl…ôri tapƒ±r (M…ôcburi yem…ô qaydasƒ± daxil olmaqla).
         */
        function getPossibleMoves(board, player, mandatoryStart = null) {
            let moves = [];
            const maxLength = getMaxJumpChainLength(board, player);
            const isMandatoryJump = maxLength > 0;
            
            // --- UI Mesajƒ±nƒ±n Yenil…ônm…ôsi ---
            document.getElementById('action-info').textContent = isMandatoryJump 
                ? "M∆èCBURƒ∞ YEM∆è VAR: ∆èn uzun z…ônciri yem…ôlisiniz!"
                : "H…ôr…ôk…ôt edin.";
            document.getElementById('action-info').className = `text-sm text-center p-2 rounded-lg w-full ${isMandatoryJump ? 'bg-red-500 text-white animate-pulse-fast' : 'bg-blue-600 text-white'}`;
            // ---------------------------------

            for (let r = 0; r < BOARD_SIZE; r++) {
                for (let c = 0; c < BOARD_SIZE; c++) {
                    if (getPiecePlayer(board[r][c]) === player) {
                        
                        // ∆èg…ôr √ßoxlu z…ôncir varsa, yalnƒ±z bu da≈üla h…ôr…ôk…ôt…ô icaz…ô ver
                        if (mandatoryStart && (mandatoryStart.r !== r || mandatoryStart.c !== c)) continue;

                        const piece = board[r][c];
                        const isKingPiece = piece === 3 || piece === 4;
                        
                        // --- Yem…ô H…ôr…ôk…ôtl…ôri (Jumps) ---
                        const jumps = findJumps(board, r, c, player);
                        jumps.forEach(jump => {
                            const nextBoard = makeTempMove(board, r, c, jump.to.r, jump.to.c, jump.captured.r, jump.captured.c);
                            const chainLength = findLongestJumpChain(nextBoard, jump.to.r, jump.to.c, player, 1);
                            
                            // Yalnƒ±z …ôn uzun z…ôncirin bir hiss…ôsi olan t…ôk yem…ôl…ôr…ô icaz…ô ver
                            if (chainLength === maxLength || !isMandatoryJump) {
                                moves.push({
                                    from: { r, c },
                                    to: jump.to,
                                    type: 'jump',
                                    captured: jump.captured,
                                    chainLength: chainLength
                                });
                            }
                        });

                        // --- Adi H…ôr…ôk…ôtl…ôr (Moves) ---
                        if (!isMandatoryJump) {
                            const directions = isKingPiece ? [[-1, -1], [-1, 1], [1, -1], [1, 1]] :
                                player === 'white' ? [[1, -1], [1, 1]] : [[-1, -1], [-1, 1]];

                            for (const [dr, dc] of directions) {
                                const newR = r + dr;
                                const newC = c + dc;
                                
                                if (isValidCell(newR, newC) && board[newR][newC] === 0) {
                                    moves.push({
                                        from: { r, c },
                                        to: { r: newR, c: newC },
                                        type: 'move'
                                    });
                                }
                            }
                        }
                    }
                }
            }
            return moves;
        }

        /** M√ºv…ôqq…ôti h…ôr…ôk…ôt edir (yem…ô z…ôncirini yoxlamaq √º√ß√ºn) */
        function makeTempMove(board, fromR, fromC, toR, toC, capturedR, capturedC) {
            const newBoard = JSON.parse(JSON.stringify(board));
            const pieceValue = newBoard[fromR][fromC];
            newBoard[fromR][fromC] = 0;
            newBoard[toR][toC] = pieceValue;
            if (capturedR !== undefined) {
                 newBoard[capturedR][capturedC] = 0;
            }
            return newBoard;
        }

        // --- UI √á…ôkm…ô v…ô Hadis…ô ƒ∞dar…ôetm…ôsi ---

        function drawBoard(board, turn, mandatoryCapture) {
            boardElement.innerHTML = '';
            boardState = board;
            selectedPiece = null; // H…ôr yenil…ôm…ôd…ô se√ßimi sƒ±fƒ±rla

            // ∆èg…ôr n√∂vb…ô bizd…ôdirs…ô, icaz…ô veril…ôn h…ôr…ôk…ôtl…ôri hesablayƒ±n
            if (isMyTurn && myColor === turn) {
                possibleMoves = getPossibleMoves(board, myColor, mandatoryCapture);
            } else {
                possibleMoves = [];
            }
            
            for (let r = 0; r < BOARD_SIZE; r++) {
                for (let c = 0; c < BOARD_SIZE; c++) {
                    const cell = document.createElement('div');
                    const isDark = (r + c) % 2 === 0;
                    cell.className = `cell ${ isDark ? 'bg-gray-200' : 'bg-gray-500' }`;
                    cell.dataset.row = r;
                    cell.dataset.col = c;
                    cell.onclick = handleBoardClick;
                    
                    const pieceValue = board[r][c];
                    
                    // M…ôcburi yem…ô start da≈üƒ±nƒ± vurƒüula (…ôg…ôr h…ôl…ô se√ßilm…ôyibs…ô)
                    if (isMyTurn && getPiecePlayer(pieceValue) === myColor) {
                        const canStartJump = possibleMoves.some(m => m.from.r === r && m.from.c === c);
                        if (canStartJump && possibleMoves.some(m => m.type === 'jump')) {
                            cell.classList.add('mandatory-jump');
                        }
                    }

                    // Da≈ü varsa
                    if (pieceValue !== 0) {
                        const piece = document.createElement('div');
                        const player = getPiecePlayer(pieceValue);
                        const isKing = pieceValue === 3 || pieceValue === 4;

                        piece.className = `piece ${player === 'white' ? 'piece-white' : 'piece-black'} ${isKing ? `piece-king ${player === 'white' ? 'piece-king-white' : 'piece-king-black'}` : ''}`;
                        piece.textContent = getPieceSymbol(pieceValue);
                        piece.dataset.row = r;
                        piece.dataset.col = c;

                        cell.appendChild(piece);
                    }

                    boardElement.appendChild(cell);
                }
            }
        }
        
        function handleBoardClick(event) {
            if (!isMyTurn || !currentRoomId) {
                return; // showModal("G√∂zl…ôyin, n√∂vb…ô sizin deyil.");
            }
            
            const cell = event.currentTarget;
            const r = parseInt(cell.dataset.row);
            const c = parseInt(cell.dataset.col);
            const pieceValue = boardState[r][c];
            const piecePlayer = getPiecePlayer(pieceValue);
            const isMyPiece = piecePlayer === myColor;
            
            // Se√ßilmi≈ü xanadan h…ôr…ôk…ôtl…ôri tap
            const movesFromSelectedPiece = selectedPiece 
                ? possibleMoves.filter(m => m.from.r === selectedPiece.r && m.from.c === selectedPiece.c)
                : [];
            
            const pieceElement = cell.querySelector('.piece');

            if (isMyPiece) {
                // Da≈ü se√ßimi
                if (selectedPiece && selectedPiece.r === r && selectedPiece.c === c) {
                    selectedPiece = null;
                } else {
                    // Yalnƒ±z h…ôr…ôk…ôt ed…ô bil…ôn da≈ü se√ßil…ô bil…ôr
                    if (possibleMoves.some(m => m.from.r === r && m.from.c === c)) {
                         selectedPiece = { r, c };
                    } else {
                        return showModal("Bu da≈üla h…ôr…ôk…ôt ed…ô bilm…ôzsiniz, ya da m…ôcburi yem…ô varsa, …ôn uzun z…ôncir…ô ba≈ülaya bil…ôc…ôk da≈üƒ± se√ßin.");
                    }
                }
                
                // Se√ßim vizualizasiyasƒ±nƒ± yenil…ô
                updateSelectionUI(movesFromSelectedPiece);
                
            } else if (selectedPiece) {
                // H…ôr…ôk…ôt c…ôhdi
                const moveAttempt = movesFromSelectedPiece.find(m => m.to.r === r && m.to.c === c);

                if (moveAttempt) {
                    // H…ôr…ôk…ôti server…ô g√∂nd…ôr
                    socket.emit('makeMove', {
                        roomId: currentRoomId,
                        from: selectedPiece,
                        to: { r, c },
                        type: moveAttempt.type,
                        captured: moveAttempt.captured,
                        player: myColor,
                        chainLength: moveAttempt.chainLength 
                    });
                    
                    // UI-da g√∂zl…ôm…ô v…ôziyy…ôtin…ô ke√ß
                    selectedPiece = null; 
                    updateSelectionUI([]);
                    
                } else {
                    showModal("Bu, qaydalara uyƒüun olmayan h…ôr…ôk…ôtdir. L√ºtf…ôn vurƒüulanmƒ±≈ü xanalara h…ôr…ôk…ôt edin.");
                }
            }
        }

        function updateSelectionUI(movesFromSelectedPiece) {
            // ∆èvv…ôlki vurƒüulamalarƒ± t…ômizl…ô
            document.querySelectorAll('.possible-move').forEach(el => el.classList.remove('possible-move'));
            document.querySelectorAll('.selected').forEach(el => el.classList.remove('selected'));
            
            if (!selectedPiece) return;

            // Yeni se√ßimi vurƒüula
            const selectedCell = document.querySelector(`.piece[data-row="${selectedPiece.r}"][data-col="${selectedPiece.c}"]`);
            if (selectedCell) selectedCell.classList.add('selected');

            // M√ºmk√ºn h…ôr…ôk…ôt xanalarƒ±nƒ± vurƒüula
            movesFromSelectedPiece.forEach(m => {
                const targetCell = document.querySelector(`.cell[data-row="${m.to.r}"][data-col="${m.to.c}"]`);
                if (targetCell) targetCell.classList.add('possible-move');
            });
        }


        // --- Socket.IO ∆èlaq…ôsi ---
        
        function initSocket() {
            if (SERVER_URL === "YOUR_RENDER_SERVER_URL_HERE") {
                document.getElementById('connection-status').textContent = "üö® X∆èTA: SERVER_URL-i d…ôyi≈üdirin!";
                document.getElementById('connection-status').className = "text-sm font-semibold mt-2 text-red-700 font-bold";
                return;
            }

            const userData = getTelegramUser();
            currentUserId = userData.id;
            currentUserName = userData.name;
            
            // UI-da istifad…ô√ßi adƒ±nƒ± g√∂st…ôr
            document.getElementById('user-name-display').textContent = `ƒ∞stifad…ô√ßi: ${currentUserName}`;
            document.getElementById('current-user-id-display').textContent = `ID: ${currentUserId.substring(0, 8)}...`;
            document.getElementById('my-name-display').textContent = currentUserName;


            socket = io(SERVER_URL, {
                query: { 
                    userId: currentUserId,
                    userName: currentUserName
                },
                transports: ['websocket', 'polling']
            });

            showScreen('loading');

            socket.on('connect', () => {
                document.getElementById('connection-status').textContent = "‚úÖ Server…ô qo≈üulmu≈üdur";
                document.getElementById('connection-status').className = "text-sm font-semibold mt-2 text-green-500";
                showScreen('lobby');
            });

            socket.on('disconnect', () => {
                document.getElementById('connection-status').textContent = "‚ùå Serverl…ô …ôlaq…ô k…ôsildi";
                document.getElementById('connection-status').className = "text-sm font-semibold mt-2 text-red-500 animate-pulse-fast";
                showScreen('loading');
            });
            
            socket.on('error', (message) => {
                showModal(`X…ôta: ${message}`);
            });
            
            // Serverd…ôn G…ôl…ôn Yenil…ôm…ôl…ôr
            socket.on('statusUpdate', (data) => {
                if (data.status === 'searching') {
                    showScreen('searching');
                } else if (data.status === 'matchFound' && data.roomId) {
                    currentRoomId = data.roomId;
                    document.getElementById('room-code-output').textContent = data.roomId;
                } else if (data.status === 'waitingForFriend') {
                    currentRoomId = data.roomId;
                    document.getElementById('room-code-output').textContent = data.roomId;
                    document.getElementById('lobi-status-message').textContent = `Otaq yaratƒ±ldƒ±: ${data.roomId}. R…ôqib g√∂zl…ônilir...`;
                    showScreen('lobby');
                }
            });

            socket.on('roomUpdate', (data) => {
                currentRoomId = data.roomId;
                myColor = data.playerBlackId === currentUserId ? 'black' : (data.playerWhiteId === currentUserId ? 'white' : null);
                
                if (data.status === 'playing') {
                    showScreen('game');
                    updateGameUI(data);
                } else if (data.status.startsWith('waiting')) {
                    const waitingMessage = data.status.includes('ranked') ? 'üèÜ Reytinqli R…ôqib axtarƒ±lƒ±r...' : `Otaq kodu: ${data.roomId}. R…ôqib g√∂zl…ônilir...`;
                    document.getElementById('lobi-status-message').textContent = waitingMessage;
                    showScreen(data.status.includes('ranked') ? 'searching' : 'lobby');
                } else if (data.status === 'finished') {
                    const winnerMessage = data.reason ? data.reason : `Oyun Bitdi! Qalib: ${data.winner === 'white' ? 'Aƒü' : 'Qara'}!`;
                    showModal(winnerMessage, () => leaveGame(false));
                }
            });
            
            socket.on('moveConfirmed', (data) => {
                updateGameUI(data);
            });
            
            socket.on('gameMessage', (message) => {
                showModal(message);
            });

            socket.on('timerUpdate', (timers) => {
                document.getElementById('white-timer').textContent = formatTime(timers.white);
                document.getElementById('black-timer').textContent = formatTime(timers.black);
            });
        }
        
        // --- Oyun UI-nƒ±n Yenil…ônm…ôsi ---
        
        let timerInterval = null;

        function updateGameUI(data) {
            const isBlack = myColor === 'black';
            const myId = currentUserId;

            // R…ôqib adƒ±nƒ± t…ôyin et
            let opponentName;
            if (data.playerBlackId === myId) {
                opponentName = data.playerWhite?.name || 'Aƒü Oyun√ßu (R…ôqib)';
            } else {
                opponentName = data.playerBlack?.name || 'Qara Oyun√ßu (R…ôqib)';
            }
            document.getElementById('opponent-name-display').textContent = opponentName;
            
            // N√∂vb…ôni t…ôyin et
            const turnColor = data.turn;
            isMyTurn = turnColor === myColor;
            mandatoryCapture = data.mandatoryCapture; // Serverd…ôn g…ôl…ôn son h…ôr…ôk…ôtin n…ôtic…ôsi

            // N√∂vb…ô mesajƒ±
            document.getElementById('current-turn-display').textContent = isMyTurn ? 'Sƒ∞Zƒ∞N N√ñVB∆èNƒ∞ZDƒ∞R!' : `R…ôqibd…ôdir (${turnColor === 'black' ? 'Qara' : 'Aƒü'})`;
            document.getElementById('current-turn-display').className = `text-lg font-bold p-3 rounded-xl shadow-xl transition duration-300 w-full text-center ${isMyTurn ? 'bg-green-600 animate-pulse-fast' : 'bg-yellow-600'}`;
            
            // Timer Vurƒüusu
            const whiteTimer = document.getElementById('white-timer');
            const blackTimer = document.getElementById('black-timer');

            whiteTimer.className = `p-2 rounded-lg font-mono text-2xl text-white shadow-md min-w-[80px] text-center ${turnColor === 'white' ? 'bg-red-500 animate-pulse-fast' : 'bg-gray-700'}`;
            blackTimer.className = `p-2 rounded-lg font-mono text-2xl text-white shadow-md min-w-[80px] text-center ${turnColor === 'black' ? 'bg-red-500 animate-pulse-fast' : 'bg-gray-700'}`;

            // Taxtanƒ± √ß…ôk
            drawBoard(data.board, turnColor, mandatoryCapture);

            // Timer Loop
            if (!timerInterval) {
                timerInterval = setInterval(() => {
                    socket.emit('requestTimerUpdate', { roomId: data.roomId });
                }, 1000); 
            }
        }

        // --- Lobiya H…ôr…ôk…ôtl…ôri ---

        dereceliBtn.onclick = () => {
            if (!socket || !socket.connected) return showModal("Server…ô qo≈üulmayƒ±b.");
            showScreen('searching');
            socket.emit('startRankedMatchmaking', { userId: currentUserId, userName: currentUserName });
        };

        deregeliCancelBtn.onclick = () => {
            if (!socket || !socket.connected) return;
            socket.emit('cancelRankedMatchmaking', { userId: currentUserId });
            showScreen('lobby');
        };

        createRoomBtn.onclick = () => {
            if (!socket || !socket.connected) return showModal("Server…ô qo≈üulmayƒ±b.");
            showScreen('loading');
            socket.emit('createRoom', { userId: currentUserId, userName: currentUserName });
        };

        document.getElementById('copy-code-btn').onclick = () => {
            const code = document.getElementById('room-code-output').textContent;
            if (code && code !== '....') {
                try {
                    navigator.clipboard.writeText(code).then(() => showModal(`Otaq kodu (${code}) kopyalandƒ±!`));
                } catch (err) {
                    showModal("Kopyalama x…ôtasƒ±: L√ºtf…ôn kodu …ôl il…ô kopyalayƒ±n.");
                }
            }
        };

        document.getElementById('join-room-btn').onclick = () => {
            if (!socket || !socket.connected) return showModal("Server…ô qo≈üulmayƒ±b.");
            const roomCode = document.getElementById('join-room-input').value.trim();
            if (roomCode.length !== 4) return showModal("Xahi≈ü edirik, 4 r…ôq…ômli otaq kodunu daxil edin.");

            showScreen('loading');
            socket.emit('joinRoom', { 
                roomId: roomCode, 
                userId: currentUserId, 
                userName: currentUserName 
            });
            document.getElementById('join-room-input').value = '';
        };

        document.getElementById('leave-game-btn').onclick = () => leaveGame(true);

        function leaveGame(notifyServer) {
            if (!currentRoomId) {
                showScreen('lobby');
                return;
            }
            
            if (notifyServer && socket && socket.connected) {
                // Server…ô oyunu t…ôrk etdiyimi bildir (Avtomatik uduzma il…ô n…ôtic…ôl…ôn…ôc…ôk)
                socket.emit('leaveRoom', { roomId: currentRoomId, userId: currentUserId });
            }
            
            // Client t…ôr…ôfind…ô t…ômizl…ô
            currentRoomId = null;
            selectedPiece = null;
            mandatoryCapture = null;
            possibleMoves = [];
            showScreen('lobby');
        }


        // --- Ba≈ülanƒüƒ±c ---
        document.addEventListener('DOMContentLoaded', initSocket);

    </script>
</body>
</html>
