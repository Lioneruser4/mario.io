<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âš¡ Mario IO Online Checkers âš¡</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        /* === Genel Stil ve Animasyon Temelleri === */
        :root {
            --primary-color: #4CAF50; /* YeÅŸil */
            --secondary-color: #FF9800; /* Turuncu */
            --light-bg: #f5f5f5;
            --dark-bg: #2c3e50;
            --tile-dark: #3a1f1f;
            --tile-light: #fce4b3;
            --piece-red: #d32f2f;
            --piece-black: #1a1a1a;
            --highlight-move: #81c784; /* AÃ§Ä±k yeÅŸil */
            --highlight-turn: #ffff00; /* SarÄ± */
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--dark-bg), #1a252f);
            color: var(--light-bg);
            overflow: hidden; /* Animasyonlar iÃ§in */
        }

        .container {
            width: 90%;
            max-width: 1000px;
            text-align: center;
            padding: 20px;
            background: rgba(44, 62, 80, 0.85); /* Hafif ÅŸeffaf koyu zemin */
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            transition: all 0.5s ease-in-out;
            border: 3px solid var(--primary-color);
        }

        /* BaÅŸlÄ±k IÅŸÄ±klÄ± Animasyon */
        h1 {
            font-size: 2.5em;
            margin-bottom: 20px;
            text-shadow: 0 0 10px var(--primary-color), 0 0 20px var(--primary-color);
            animation: pulse-title 2s infinite alternate;
        }
        @keyframes pulse-title {
            from { text-shadow: 0 0 5px var(--primary-color); }
            to { text-shadow: 0 0 15px var(--primary-color), 0 0 30px var(--primary-color); }
        }

        /* Sunucu Bildirim AlanÄ± */
        #server-status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        .status-connecting { background-color: var(--secondary-color); }
        .status-connected { background-color: var(--primary-color); }
        .status-disconnected { background-color: #e74c3c; }

        /* Lobi ButonlarÄ± (Animasyonlu ve IÅŸÄ±klÄ±) */
        .lobby-buttons button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 15px 30px;
            margin: 10px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
        }

        .lobby-buttons button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5), 0 0 15px var(--primary-color);
        }

        /* Buton "ParlaklÄ±k" Animasyonu */
        .lobby-buttons button::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.15);
            transition: all 0.5s;
            transform: skewX(-20deg);
        }
        .lobby-buttons button:hover::after {
            left: 100%;
        }

        /* ArkadaÅŸla Oyna / Oda GiriÅŸi */
        #friend-join-section {
            margin-top: 20px;
            padding: 15px;
            border: 1px dashed var(--secondary-color);
            border-radius: 8px;
            display: none; /* VarsayÄ±lan olarak gizli */
            background: rgba(255, 152, 0, 0.1);
        }

        #room-code-display, #room-input {
            margin-bottom: 10px;
        }

        #room-input input {
            padding: 10px;
            border-radius: 5px;
            border: 1px solid var(--secondary-color);
            background: #34495e;
            color: white;
            margin-right: 10px;
        }

        #copy-room-btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
        }

        /* === Oyun AlanÄ± Stilleri === */
        #game-board-container {
            display: none; /* VarsayÄ±lan olarak gizli */
            justify-content: center;
            margin-top: 20px;
        }

        #checkers-board {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            grid-template-rows: repeat(8, 1fr);
            width: 400px;
            height: 400px;
            border: 5px solid #a0522d;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.7);
        }

        .tile {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }

        .tile:nth-child(odd) {
            background-color: var(--tile-light);
        }

        .tile:nth-child(even) {
            background-color: var(--tile-dark);
        }

        /* SatÄ±r Ã§ift, SÃ¼tun tek ise Koyu; SatÄ±r tek, SÃ¼tun Ã§ift ise Koyu. */
        .row:nth-child(odd) .tile:nth-child(even),
        .row:nth-child(even) .tile:nth-child(odd) {
            background-color: var(--tile-dark);
        }
        /* Ters durumlar (oyun taÅŸlarÄ±nÄ±n konduÄŸu kareler) */
        .row:nth-child(odd) .tile:nth-child(odd),
        .row:nth-child(even) .tile:nth-child(even) {
             background-color: var(--tile-light);
        }

        /* TaÅŸlarÄ±n Stili */
        .piece {
            width: 80%;
            height: 80%;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
            transition: transform 0.2s ease-out;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .piece-red {
            background-color: var(--piece-red);
            border: 3px solid #b71c1c;
        }

        .piece-black {
            background-color: var(--piece-black);
            border: 3px solid #000000;
        }

        .piece.king::before {
            content: 'â˜…'; /* Kral sembolÃ¼ */
            position: absolute;
            font-size: 1.2em;
            color: gold;
            text-shadow: 0 0 5px #000;
        }

        /* Oynanabilir Kare Vurgusu */
        .possible-move {
            background-color: var(--highlight-move) !important;
            animation: blink-highlight 1s infinite alternate;
        }
        @keyframes blink-highlight {
            from { opacity: 0.8; }
            to { opacity: 1; }
        }

        /* SÄ±ra Kimdeyse O TarafÄ±n IÅŸÄ±klÄ± OlmasÄ± */
        .player-info {
            padding: 10px;
            margin: 10px;
            border-radius: 5px;
            font-weight: bold;
            transition: box-shadow 0.5s ease;
        }

        .turn-active {
            box-shadow: 0 0 15px var(--highlight-turn), 0 0 20px var(--highlight-turn);
            background-color: rgba(255, 255, 0, 0.1);
        }

        /* EÅŸleÅŸme AranÄ±yor Animasyonu */
        #matchmaking-info {
            display: none;
            padding: 20px;
            margin-top: 20px;
            border-radius: 10px;
            background: rgba(255, 152, 0, 0.2);
            color: var(--secondary-color);
        }
        .dot-pulse {
            display: inline-block;
        }
        .dot-pulse::after {
            content: '...';
            display: inline-block;
            overflow: hidden;
            vertical-align: bottom;
            animation: dot-loading 1.5s step-end infinite;
        }
        @keyframes dot-loading {
            0% { content: '.'; }
            33% { content: '..'; }
            66% { content: '...'; }
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>ğŸŒŸ Amerikan DamasÄ± Online ğŸŒŸ</h1>

        <div id="server-status" class="status-connecting">Sunucuya baÄŸlanÄ±lÄ±yor... ($https://mario-io-1.onrender.com$)</div>

        <div id="lobby-screen">
            <h2>Hemen Oyna!</h2>
            <div class="lobby-buttons">
                <button id="rated-match-btn">ğŸ† Dereceli EÅŸleÅŸme (Ã‡evrim Ä°Ã§i Kim)</button>
                <button id="friend-game-btn">ğŸ¤ ArkadaÅŸla Oyna</button>
            </div>

            <div id="matchmaking-info">
                EÅŸleÅŸme AranÄ±yor <span class="dot-pulse"></span>
                <button id="cancel-match-btn" style="margin-left: 20px; background-color: #c0392b;">Ä°ptal</button>
            </div>

            <div id="friend-join-section">
                <div id="room-code-display" style="display: none;">
                    Oda Kodun: <span id="room-code" style="font-size: 1.2em; color: var(--highlight-turn);"></span>
                    <button id="copy-room-btn">Kopyala</button>
                </div>
                <div id="room-input">
                    <input type="text" id="join-room-code" placeholder="4 RakamlÄ± Oda Kodu" maxlength="4">
                    <button id="join-room-btn">Odaya BaÄŸlan</button>
                </div>
            </div>
        </div>

        <div id="game-screen" style="display: none;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                <div id="player-top-info" class="player-info">Siyah Oyuncu (Rakip)</div>
                <div id="player-bottom-info" class="player-info">KÄ±rmÄ±zÄ± Oyuncu (Sen)</div>
            </div>

            <div id="game-board-container">
                <div id="checkers-board">
                    </div>
            </div>

            <h3 id="game-message" style="margin-top: 20px;">SÄ±ra: KÄ±rmÄ±zÄ± Oyuncuda</h3>
        </div>

    </div>

    <script>
        // Sunucu Adresi
        const SERVER_URL = "https://mario-io-1.onrender.com";

        // DOM Elementleri
        const serverStatusEl = document.getElementById('server-status');
        const lobbyScreenEl = document.getElementById('lobby-screen');
        const gameScreenEl = document.getElementById('game-screen');
        const ratedMatchBtn = document.getElementById('rated-match-btn');
        const friendGameBtn = document.getElementById('friend-game-btn');
        const cancelMatchBtn = document.getElementById('cancel-match-btn');
        const matchmakingInfoEl = document.getElementById('matchmaking-info');
        const friendJoinSectionEl = document.getElementById('friend-join-section');
        const roomCodeDisplayEl = document.getElementById('room-code-display');
        const roomCodeEl = document.getElementById('room-code');
        const copyRoomBtn = document.getElementById('copy-room-btn');
        const joinRoomInput = document.getElementById('join-room-code');
        const joinRoomBtn = document.getElementById('join-room-btn');
        const boardEl = document.getElementById('checkers-board');
        const gameMessageEl = document.getElementById('game-message');
        const playerTopInfoEl = document.getElementById('player-top-info');
        const playerBottomInfoEl = document.getElementById('player-bottom-info');

        // Global Oyun Durumu
        let socket;
        let myColor = null; // 'red' veya 'black'
        let currentTurn = 'red';
        let selectedPiece = null; // SeÃ§ilen taÅŸÄ±n koordinatlarÄ±

        // ==========================================================
        // === 1. SUNUCU BAÄLANTISI ve LOBÄ° MANTIÄI ===
        // ==========================================================

        function connectToServer() {
            serverStatusEl.className = 'status-connecting';
            serverStatusEl.textContent = `Sunucuya baÄŸlanÄ±lÄ±yor... (${SERVER_URL})`;

            socket = io(SERVER_URL);

            socket.on('connect', () => {
                serverStatusEl.className = 'status-connected';
                serverStatusEl.textContent = 'âœ… Sunucuya baÅŸarÄ±yla baÄŸlandÄ±! Oyun lobisi hazÄ±r.';
            });

            socket.on('disconnect', () => {
                serverStatusEl.className = 'status-disconnected';
                serverStatusEl.textContent = 'âŒ Sunucu baÄŸlantÄ±sÄ± kesildi. Yeniden baÄŸlanÄ±lÄ±yor...';
                // Oyun sÄ±rasÄ±nda baÄŸlantÄ± kesilirse kullanÄ±cÄ±ya bildirim gÃ¶ster
            });

            // Sunucudan EÅŸleÅŸme Bulundu/Oda Kuruldu yanÄ±tlarÄ±
            socket.on('matchFound', (data) => {
                startGame(data.color, data.opponentName);
            });

            socket.on('roomCreated', (roomCode) => {
                roomCodeEl.textContent = roomCode;
                roomCodeDisplayEl.style.display = 'block';
                // KullanÄ±cÄ±ya bildir
                alert(`Oda ${roomCode} kodu ile kuruldu. Kodu arkadaÅŸÄ±nla paylaÅŸ.`);
            });

            socket.on('gameStart', (data) => {
                 startGame(data.color, data.opponentName);
            });
            
            socket.on('roomNotFound', () => {
                alert('Belirtilen oda kodu bulunamadÄ± veya doludur.');
            });

             socket.on('gameUpdate', (data) => {
                updateGameState(data.board, data.turn, data.lastMove);
            });
        }

        // Lobi Buton Ä°ÅŸlevleri
        ratedMatchBtn.onclick = () => {
            if (!socket || !socket.connected) {
                alert("Ã–nce sunucuya baÄŸlanÄ±n.");
                return;
            }
            // EÅŸleÅŸme arama baÅŸlat
            matchmakingInfoEl.style.display = 'block';
            lobbyScreenEl.querySelectorAll('.lobby-buttons button').forEach(b => b.disabled = true);
            socket.emit('startMatchmaking');
        };

        cancelMatchBtn.onclick = () => {
            matchmakingInfoEl.style.display = 'none';
            lobbyScreenEl.querySelectorAll('.lobby-buttons button').forEach(b => b.disabled = false);
            socket.emit('cancelMatchmaking');
        };

        friendGameBtn.onclick = () => {
            if (friendJoinSectionEl.style.display === 'block') {
                friendJoinSectionEl.style.display = 'none';
            } else {
                friendJoinSectionEl.style.display = 'block';
                // Oda kurma isteÄŸi
                socket.emit('createRoom');
            }
        };

        copyRoomBtn.onclick = () => {
            navigator.clipboard.writeText(roomCodeEl.textContent).then(() => {
                alert('Oda Kodu kopyalandÄ±: ' + roomCodeEl.textContent);
            });
        };

        joinRoomBtn.onclick = () => {
            const code = joinRoomInput.value.trim();
            if (code.length === 4) {
                socket.emit('joinRoom', code);
            } else {
                alert('Oda kodu 4 haneli olmalÄ±dÄ±r.');
            }
        };


        // ==========================================================
        // === 2. OYUN BAÅLANGICI ve TAHTA OLUÅTURMA ===
        // ==========================================================

        function startGame(color, opponentName = "Rakip") {
            lobbyScreenEl.style.display = 'none';
            gameScreenEl.style.display = 'block';
            myColor = color;
            
            // Oyuncu bilgilerini gÃ¼ncelle
            if (myColor === 'red') {
                playerBottomInfoEl.textContent = 'KÄ±rmÄ±zÄ± (Sen)';
                playerTopInfoEl.textContent = `Siyah (${opponentName})`;
            } else {
                playerBottomInfoEl.textContent = `KÄ±rmÄ±zÄ± (${opponentName})`;
                playerTopInfoEl.textContent = 'Siyah (Sen)';
            }

            // TahtayÄ± ve baÅŸlangÄ±Ã§ taÅŸlarÄ±nÄ± Ã§iz
            drawBoard();
            updateTurnDisplay('red'); // Oyun kÄ±rmÄ±zÄ± ile baÅŸlar
        }

        function drawBoard() {
            boardEl.innerHTML = '';
            // BaÅŸlangÄ±Ã§ tahta durumu (Amerikan DamasÄ±)
            const initialBoardState = [
                ['', 'black', '', 'black', '', 'black', '', 'black'],
                ['black', '', 'black', '', 'black', '', 'black', ''],
                ['', 'black', '', 'black', '', 'black', '', 'black'],
                ['', '', '', '', '', '', '', ''],
                ['', '', '', '', '', '', '', ''],
                ['red', '', 'red', '', 'red', '', 'red', ''],
                ['', 'red', '', 'red', '', 'red', '', 'red'],
                ['red', '', 'red', '', 'red', '', 'red', '']
            ];

            for (let r = 0; r < 8; r++) {
                const rowEl = document.createElement('div');
                rowEl.className = 'row';
                rowEl.style.display = 'contents'; // Grid yapÄ±sÄ± iÃ§in

                for (let c = 0; c < 8; c++) {
                    const tileEl = document.createElement('div');
                    tileEl.className = 'tile';
                    tileEl.dataset.row = r;
                    tileEl.dataset.col = c;
                    
                    // Koyu karelere tÄ±klama iÅŸleyici ekle
                    const isDark = (r % 2) === (c % 2);
                    if (!isDark) {
                         // Arka plan rengini CSS hallediyor. Buraya tÄ±klama olayÄ±nÄ± ekleyelim.
                    } else {
                        // TaÅŸlarÄ±n konulduÄŸu koyu karelere tÄ±klama olayÄ±
                        tileEl.onclick = handleTileClick;
                    }
                   
                    const pieceType = initialBoardState[r][c];
                    if (pieceType) {
                        const pieceEl = document.createElement('div');
                        pieceEl.className = `piece piece-${pieceType}`;
                        // pieceEl.onclick = handlePieceClick; // TaÅŸÄ± seÃ§mek iÃ§in tile'a tÄ±kla
                        tileEl.appendChild(pieceEl);
                    }
                    
                    rowEl.appendChild(tileEl);
                }
                boardEl.appendChild(rowEl);
            }
        }

        // ==========================================================
        // === 3. OYUN Ä°Ã‡Ä° ETKÄ°LEÅÄ°M ve GÃœNCELLEME ===
        // ==========================================================
        
        // TaÅŸa/Kareye TÄ±klama Ä°ÅŸleyicisi
        function handleTileClick(event) {
            if (currentTurn !== myColor) {
                gameMessageEl.textContent = `SÄ±ra rakipte! (${currentTurn.toUpperCase()})`;
                return;
            }

            const tileEl = event.currentTarget;
            const r = parseInt(tileEl.dataset.row);
            const c = parseInt(tileEl.dataset.col);
            const pieceEl = tileEl.querySelector('.piece');

            // 1. Durum: TaÅŸ SeÃ§imi (TaÅŸ benimse)
            if (pieceEl && pieceEl.classList.contains(`piece-${myColor}`)) {
                // Ã–nceki seÃ§imi ve olasÄ± hareketleri temizle
                clearHighlights(); 
                
                selectedPiece = { r, c };
                // TaÅŸÄ± seÃ§ ve olasÄ± hareketleri sunucudan iste
                tileEl.style.boxShadow = `0 0 10px 5px var(--secondary-color)`;
                
                // Sunucuya olasÄ± hareketleri sor (Bu kritik kÄ±sÄ±m)
                socket.emit('requestPossibleMoves', { r, c });
                return;
            } 
            
            // 2. Durum: Hareketi Yapma (Oynanabilir kareye tÄ±klandÄ±ysa)
            else if (selectedPiece && tileEl.classList.contains('possible-move')) {
                const startR = selectedPiece.r;
                const startC = selectedPiece.c;
                const endR = r;
                const endC = c;
                
                // Hareketi sunucuya gÃ¶nder
                socket.emit('makeMove', { startR, startC, endR, endC });

                // Ä°stemci tarafÄ±nda temizle
                clearHighlights();
                selectedPiece = null;
            } 
            
            // 3. Durum: GeÃ§ersiz TÄ±klama
            else {
                 clearHighlights();
                 selectedPiece = null;
                 gameMessageEl.textContent = `GeÃ§ersiz hareket veya kare.`;
            }
        }
        
        // Sunucudan Gelen OlasÄ± Hareketleri GÃ¶sterme
        socket.on('showPossibleMoves', (moves) => {
            // moves: [{ r: 4, c: 3 }, { r: 4, c: 5 }, ...]
            clearHighlights(false); // Sadece hareketleri temizle

            moves.forEach(move => {
                const tileEl = document.querySelector(`.tile[data-row='${move.r}'][data-col='${move.c}']`);
                if (tileEl) {
                    tileEl.classList.add('possible-move');
                }
            });
        });

        // Sunucudan Gelen Oyun Durumu GÃ¼ncellemesi
        function updateGameState(newBoardState, newTurn, lastMove) {
            currentTurn = newTurn;
            updateTurnDisplay(newTurn);
            clearHighlights(); // Her ihtimale karÅŸÄ± temizle

            // TahtayÄ± gÃ¼ncelleyen kÄ±sÄ±m
            for (let r = 0; r < 8; r++) {
                for (let c = 0; c < 8; c++) {
                    const tileEl = document.querySelector(`.tile[data-row='${r}'][data-col='${c}']`);
                    tileEl.innerHTML = ''; // Kareyi temizle

                    const pieceData = newBoardState[r][c]; // Ã–rnek: 'red' veya 'black-king'
                    if (pieceData) {
                        const [color, type] = pieceData.split('-');
                        const pieceEl = document.createElement('div');
                        pieceEl.className = `piece piece-${color}`;
                        if (type === 'king') {
                            pieceEl.classList.add('king');
                        }
                        tileEl.appendChild(pieceEl);

                        // Hareket animasyonu (Basit)
                        if (lastMove && (lastMove.endR === r && lastMove.endC === c)) {
                            pieceEl.style.transform = 'scale(1.2)';
                            setTimeout(() => pieceEl.style.transform = 'scale(1)', 200);
                        }
                    }
                }
            }
        }
        
        // VurgularÄ± Temizleme
        function clearHighlights(clearSelected = true) {
            document.querySelectorAll('.tile').forEach(tile => {
                tile.classList.remove('possible-move');
                if (clearSelected) {
                    tile.style.boxShadow = 'none';
                }
            });
            if (clearSelected) {
                selectedPiece = null;
            }
        }
        
        // SÄ±ra IÅŸÄ±klÄ± GÃ¶sterimi
        function updateTurnDisplay(turn) {
            currentTurn = turn;
            gameMessageEl.textContent = `SÄ±ra: ${turn === 'red' ? 'KÄ±rmÄ±zÄ±' : 'Siyah'} Oyuncuda`;
            
            playerTopInfoEl.classList.remove('turn-active');
            playerBottomInfoEl.classList.remove('turn-active');
            
            // SÄ±ra benim tarafÄ±mdayken daha parlak olsun
            if (myColor === turn) {
                 (myColor === 'red' ? playerBottomInfoEl : playerTopInfoEl).classList.add('turn-active');
            } else {
                 (myColor === 'red' ? playerTopInfoEl : playerBottomInfoEl).classList.add('turn-active');
            }
        }


        // ==========================================================
        // === BAÅLATMA ===
        // ==========================================================

        document.addEventListener('DOMContentLoaded', connectToServer);

    </script>
</body>
</html>
