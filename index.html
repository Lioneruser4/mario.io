<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Online Dama (Checkers)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.js"></script>
    <style>
        :root {
            --board-size: 8;
            --cell-size: 12.5vw; 
            --max-cell-size: 65px; 
            --black-cell: #4e342e;
            --white-cell: #ffecb3;
            --highlight-color: #4caf50; 
            --turn-light-color: #ffeb3b;
            --player-1-color: #e53935;
            --player-2-color: #455a64;
            --main-bg: #1c1c1c;
            --primary-color: #4CAF50; 
            --ranked-color: #FFC107; 
        }

        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: var(--main-bg);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: white;
            padding: 20px 5px;
            box-sizing: border-box;
            transition: background-color 0.5s;
        }

        /* Ba≈ülƒ±k ve Baƒülantƒ± Durumu */
        h1 { margin-bottom: 5px; font-size: 2.2em; color: var(--ranked-color); text-shadow: 0 0 5px rgba(0, 0, 0, 0.5); }
        #connection-status { font-weight: bold; font-size: 0.9em; margin-bottom: 20px; }
        
        /* Buton ve Giri≈ü Alanƒ± */
        #main-menu { display: flex; flex-direction: column; align-items: center; width: 95%; max-width: 400px; padding-top: 5vh;}

        #username-input-group, #join-lobby-group {
            width: 100%;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #2c2c2c;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
            transition: all 0.3s;
        }

        label { display: block; margin-bottom: 8px; font-weight: bold; color: #ccc; }
        input[type="text"], input[type="number"] {
            width: calc(100% - 20px);
            padding: 10px;
            border: 2px solid #555;
            border-radius: 8px;
            background-color: #383838;
            color: white;
            font-size: 1em;
            transition: border-color 0.3s;
        }
        input[type="text"]:focus, input[type="number"]:focus {
            border-color: var(--primary-color);
            outline: none;
        }
        
        .menu-buttons button {
            width: 100%;
            padding: 15px;
            margin: 8px 0;
            font-size: 1.1em;
            cursor: pointer;
            border: none;
            border-radius: 10px;
            color: white;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.4);
            font-weight: bold;
            position: relative;
            overflow: hidden;
        }
        /* Animasyonlu Buton Efektleri */
        .menu-buttons button:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.6);
        }
        .menu-buttons button:active {
            transform: translateY(-1px) scale(0.98);
        }
        
        #rank-match-button { background-color: var(--ranked-color); color: var(--main-bg); }
        #create-lobby-button { background-color: var(--primary-color); }
        #join-lobby-button { background-color: #03A9F4; } /* Mavi ton */

        .menu-buttons button::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.3);
            opacity: 0;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.5s ease-out;
        }
        .menu-buttons button:active::after {
            width: 200%;
            height: 200%;
            opacity: 1;
            transition: 0s;
        }

        /* Oyun Ekranƒ± */
        #game-screen { display: none; width: 100%; align-items: center; flex-direction: column; padding-top: 10px;}
        #game-info {
            color: #ccc;
            margin-bottom: 15px;
            font-size: 1.1em;
            text-align: center;
        }
        #current-player-text { font-weight: bold; color: var(--turn-light-color); }
        #player-names { margin-bottom: 10px; font-size: 1.2em; font-weight: 500;}
        
        /* Tahta */
        #board-container {
            max-width: 100vw;
            width: calc(var(--cell-size) * 8);
            margin: 10px auto;
            border: 6px solid #8d6e63;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.7);
            max-width: calc(var(--max-cell-size) * 8 + 12px); 
        }

        #board {
            display: grid;
            grid-template-columns: repeat(var(--board-size), min(var(--cell-size), var(--max-cell-size)));
            grid-template-rows: repeat(var(--board-size), min(var(--cell-size), var(--max-cell-size)));
        }

        .cell {
            width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; cursor: pointer; position: relative;
        }
        .light { background-color: var(--white-cell); }
        .dark { background-color: var(--black-cell); }
        
        .piece {
            width: 80%; height: 80%; border-radius: 50%; box-shadow: 0 3px 6px rgba(0, 0, 0, 0.6); border: 2px solid rgba(255, 255, 255, 0.4); z-index: 5; transition: transform 0.2s ease-out; display: flex; align-items: center; justify-content: center; font-size: 20px;
        }
        .player-1 { background-color: var(--player-1-color); }
        .player-2 { background-color: var(--player-2-color); }
        .king { color: var(--turn-light-color); font-weight: bold; border: 3px solid var(--turn-light-color);}

        .selected-piece {
            transform: scale(1.15) translateY(-5px); 
            box-shadow: 0 0 15px 3px var(--highlight-color);
        }
        .valid-move::after {
            content: '';
            position: absolute;
            width: 35%; height: 35%; border-radius: 50%; background-color: var(--highlight-color); opacity: 0.9; z-index: 10;
        }

        .is-turn { box-shadow: inset 0 0 8px 1px var(--turn-light-color); }
        .player-turn-light { box-shadow: 0 0 15px var(--turn-light-color); border: 1px solid var(--turn-light-color); }

        /* Bekleme Ekranƒ± (Dereceli Lobi) */
        #waiting-screen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            color: white;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            font-size: 1.5em;
            text-align: center;
            z-index: 100;
        }
        .spinner {
            border: 8px solid #333;
            border-top: 8px solid var(--ranked-color);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin-top: 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="app-container">
        <h1>Online Dama üëë</h1>
        <div id="connection-status">Baƒülanƒ±yor...</div>

        <div id="main-menu">
            
            <div id="username-input-group">
                <label for="username">Kullanƒ±cƒ± Adƒ±:</label>
                <input type="text" id="username" placeholder="Adƒ±nƒ±zƒ± girin" maxlength="15">
            </div>

            <div class="menu-buttons">
                <button id="rank-match-button">üëë Dereceli Oyna (E≈üle≈ütirme)</button>
                <button id="create-lobby-button">ü§ù Arkada≈üla Oyna (Oda Kur)</button>
            </div>

            <div id="join-lobby-group">
                <label for="lobby-code">Oda Kodu (4 Rakam):</label>
                <input type="number" id="lobby-code" placeholder="√ñrn: 1234" maxlength="4">
                <button id="join-lobby-button" style="margin-top: 10px;">üö™ Odaya Katƒ±l</button>
            </div>
        </div>

        <div id="game-screen">
            <div id="player-names"></div>
            <div id="game-info">
                Oda: <span id="lobby-id-text">---</span> | Sƒ±ra: <span id="current-player-text">Bekleniyor...</span>
            </div>
            
            <div id="board-container">
                <div id="board">
                    </div>
            </div>
        </div>
    </div>
    
    <div id="waiting-screen">
        <p>Rakip aranƒ±yor...</p>
        <div class="spinner"></div>
        <p>L√ºtfen bekleyiniz, diƒüer oyuncular e≈üle≈üme lobisinden baƒülanacak.</p>
    </div>

    <script>
        // *** CONFIGURATION ***
        const SERVER_URL = 'https://mario-io-1.onrender.com'; 
        const socket = io(SERVER_URL);
        const boardSize = 8;
        
        // *** DOM ELEMENTS ***
        const mainMenu = document.getElementById('main-menu');
        const gameScreen = document.getElementById('game-screen');
        const board = document.getElementById('board');
        const currentPlayerText = document.getElementById('current-player-text');
        const connectionStatus = document.getElementById('connection-status');
        const lobbyIdText = document.getElementById('lobby-id-text');
        const usernameInput = document.getElementById('username');
        const lobbyCodeInput = document.getElementById('lobby-code');
        const waitingScreen = document.getElementById('waiting-screen');
        const playerNamesDiv = document.getElementById('player-names');

        // *** GAME STATE ***
        let selectedPiece = null;
        let currentPlayer = 1; 
        let playerRole = 0; // 1 veya 2 (Bu istemcide oynayan oyuncu)
        let lobbyId = null;
        let isMyTurn = false;
        let player1Name = 'Oyuncu 1';
        let player2Name = 'Oyuncu 2';
        
        let gameState = [
            [0, 2, 0, 2, 0, 2, 0, 2], [2, 0, 2, 0, 2, 0, 2, 0],
            [0, 2, 0, 2, 0, 2, 0, 2], [0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0], [1, 0, 1, 0, 1, 0, 1, 0],
            [0, 1, 0, 1, 0, 1, 0, 1], [1, 0, 1, 0, 1, 0, 1, 0]
        ];
        
        // **********************************
        // *** G√ñRSEL VE AKI≈û Y√ñNETƒ∞Mƒ∞ ***
        // **********************************
        
        function showGameScreen() {
            mainMenu.style.display = 'none';
            waitingScreen.style.display = 'none';
            gameScreen.style.display = 'flex';
        }
        
        function showWaitingScreen(message) {
            mainMenu.style.display = 'none';
            gameScreen.style.display = 'none';
            waitingScreen.style.display = 'flex';
            waitingScreen.querySelector('p').textContent = message;
        }
        
        function updatePlayerNamesDisplay() {
            const myName = (playerRole === 1) ? player1Name : player2Name;
            const opponentName = (playerRole === 1) ? player2Name : player1Name;
            
            playerNamesDiv.innerHTML = `
                <span style="color:var(--player-1-color);">${player1Name}</span> 
                vs 
                <span style="color:var(--player-2-color);">${player2Name}</span>
            `;
        }

        function placePiece(cell, pieceOwner) {
            cell.innerHTML = ''; 
            if (pieceOwner > 0) {
                const piece = document.createElement('div');
                piece.className = `piece player-${pieceOwner}`;
                piece.dataset.owner = pieceOwner;
                if (pieceOwner > 2) piece.classList.add('king'); 
                piece.textContent = piece.classList.contains('king') ? '‚ôî' : ''; 
                cell.appendChild(piece);
            }
        }
        
        function createBoard(state) {
            board.innerHTML = '';
            for (let r = 0; r < boardSize; r++) {
                for (let c = 0; c < boardSize; c++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell ' + (((r + c) % 2 === 0) ? 'light' : 'dark');
                    cell.dataset.row = r;
                    cell.dataset.col = c;
                    cell.addEventListener('click', handleCellClick);
                    
                    placePiece(cell, state[r][c]);
                    board.appendChild(cell);
                }
            }
            updateTurnLight();
        }

        function updateTurnLight() {
            document.querySelectorAll('.cell').forEach(cell => {
                cell.classList.remove('is-turn', 'player-turn-light');
            });
            
            const targetCells = (currentPlayer === 1) 
                ? Array.from(document.querySelectorAll('.cell[data-row="5"], .cell[data-row="6"], .cell[data-row="7"]'))
                : Array.from(document.querySelectorAll('.cell[data-row="0"], .cell[data-row="1"], .cell[data-row="2"]'));
            
            targetCells.forEach(cell => {
                if (cell.classList.contains('dark')) {
                    cell.classList.add('is-turn', 'player-turn-light');
                }
            });
            
            // Oyuncu ismini de sƒ±raya g√∂re g√ºncelle
            const currentName = (currentPlayer === 1) ? player1Name : player2Name;
            currentPlayerText.textContent = `${currentName} (${currentPlayer === playerRole ? 'Sƒ±ra Sizde' : 'Rakip Oynuyor'})`;
        }

        // --- ANIMASYON: TA≈ûIN KAYMASI ---
        function applyMoveAndAnimate(fromR, fromC, toR, toC, isOpponent = false) {
            const oldCell = board.querySelector(`[data-row="${fromR}"][data-col="${fromC}"]`);
            const newCell = board.querySelector(`[data-row="${toR}"][data-col="${toC}"]`);
            const movingPiece = oldCell ? oldCell.querySelector('.piece') : null;
            
            if (!movingPiece) return;

            // Oyun Durumunu G√ºncelle (Ta≈üƒ±n King olup olmadƒ±ƒüƒ± bilgisi korunarak)
            const pieceOwner = gameState[fromR][fromC];
            gameState[toR][toC] = pieceOwner;
            gameState[fromR][fromC] = 0;

            // DOM Transferi
            oldCell.removeChild(movingPiece);
            newCell.appendChild(movingPiece);
            
            // Kral yapma kontrol√º
            if ((toR === 0 && (pieceOwner === 1 || pieceOwner === 3)) && pieceOwner < 3) {
                movingPiece.classList.add('king');
                movingPiece.textContent = '‚ôî';
                gameState[toR][toC] = 3; 
            } else if ((toR === 7 && (pieceOwner === 2 || pieceOwner === 4)) && pieceOwner < 4) {
                movingPiece.classList.add('king');
                movingPiece.textContent = '‚ôî';
                gameState[toR][toC] = 4; 
            }
        }
        
        function clearHighlights() {
            document.querySelectorAll('.selected-piece').forEach(p => p.classList.remove('selected-piece'));
            document.querySelectorAll('.valid-move').forEach(cell => cell.classList.remove('valid-move'));
        }
        
        // Basit Hamle Kontrol√º (G√∂rsel ƒ∞pucu)
        function getValidMoves(r, c, pieceOwner, isKing) {
            const moves = [];
            const directions = (pieceOwner === 1) ? [-1] : [1]; 
            if (isKing) directions.push(1, -1); 

            for (const direction of directions) {
                const nextRow = r + direction;
                if (nextRow >= 0 && nextRow < boardSize) {
                    if (c - 1 >= 0 && gameState[nextRow][c - 1] === 0) {
                        moves.push({ row: nextRow, col: c - 1 });
                    }
                    if (c + 1 < boardSize && gameState[nextRow][c + 1] === 0) {
                        moves.push({ row: nextRow, col: c + 1 });
                    }
                }
            }
            return moves;
        }


        // **********************************
        // *** SOCKET.IO ƒ∞LETƒ∞≈ûƒ∞M KISMI ***
        // **********************************

        socket.on('connect', () => {
            connectionStatus.textContent = `Online (${socket.id.substring(0, 4)}...)`;
            connectionStatus.style.color = '#76ff03';
        });

        socket.on('disconnect', () => {
            connectionStatus.textContent = 'Baƒülantƒ± Kesildi!';
            connectionStatus.style.color = '#ff1744';
            mainMenu.style.display = 'flex';
            gameScreen.style.display = 'none';
            waitingScreen.style.display = 'none';
            lobbyId = null;
        });
        
        socket.on('lobby_created', (data) => {
            lobbyId = data.lobbyId;
            playerRole = data.playerRole;
            player1Name = data.username;
            lobbyIdText.textContent = lobbyId;
            alert(`Lobi Kuruldu! Kod: ${lobbyId}. Rakibinizi bekliyor.`);
            showGameScreen();
            updatePlayerNamesDisplay();
        });

        socket.on('lobby_joined', (data) => {
            lobbyId = data.lobbyId;
            playerRole = data.playerRole;
            player2Name = data.username; // Ge√ßici olarak kendimizi P2 yapƒ±yoruz
            lobbyIdText.textContent = lobbyId;
            showGameScreen();
        });
        
        socket.on('rank_match_start', (data) => {
            lobbyId = data.lobbyId;
            showGameScreen();
        });

        // Oyun Ba≈üladƒ± (Lobi veya Dereceli E≈üle≈üme Sonrasƒ±)
        socket.on('game_start', (data) => {
            gameState = data.initialState; 
            currentPlayer = data.turn;
            isMyTurn = (playerRole === currentPlayer);
            
            player1Name = data.player1.username;
            player2Name = data.player2.username;

            createBoard(gameState);
            updateTurnLight();
            updatePlayerNamesDisplay();
        });
        
        // Sunucu sƒ±rayƒ± deƒüi≈ütirdiƒüinde
        socket.on('turn_changed', (data) => {
             currentPlayer = data.newTurn;
             isMyTurn = (playerRole === currentPlayer);
             updateTurnLight();
        });

        socket.on('waiting_for_opponent', (message) => {
            showWaitingScreen(message);
        });

        // Rakip Hamle Yaptƒ±
        socket.on('opponent_moved', (move) => {
            // Hamleyi uygulayƒ±n
            applyMoveAndAnimate(move.from.r, move.from.c, move.to.r, move.to.c, true);
            // Sunucudan turn_changed sinyali geleceƒüi i√ßin burada sƒ±rayƒ± deƒüi≈ütirmeye gerek yok.
        });
        
        socket.on('opponent_disconnected', (message) => {
            alert(message);
            // Ana men√ºye d√∂n
            mainMenu.style.display = 'flex';
            gameScreen.style.display = 'none';
            lobbyId = null;
        });
        
        socket.on('error', (message) => {
            alert("Hata: " + message);
            waitingScreen.style.display = 'none'; // Hatada bekleme ekranƒ±nƒ± kapat
            mainMenu.style.display = 'flex';
        });
        
        // **********************************
        // *** OYUN ƒ∞√áƒ∞ ETKƒ∞LE≈ûƒ∞M ***
        // **********************************

        function handleCellClick(event) {
            if (!isMyTurn || !lobbyId) {
                if(lobbyId) console.log("Sƒ±ra sizde deƒüil!");
                else alert("√ñnce bir oyuna katƒ±lƒ±n!");
                return;
            }

            const cell = event.currentTarget;
            const r = parseInt(cell.dataset.row);
            const c = parseInt(cell.dataset.col);
            const piece = cell.querySelector('.piece');

            clearHighlights(); 

            // 1. Ta≈ü Se√ßme
            if (piece && parseInt(piece.dataset.owner) === currentPlayer && parseInt(piece.dataset.owner) === playerRole) {
                selectedPiece = { r, c, piece: piece };
                piece.classList.add('selected-piece'); 

                const isKing = piece.classList.contains('king');
                const moves = getValidMoves(r, c, currentPlayer, isKing); 
                
                moves.forEach(move => {
                    const targetCell = board.querySelector(`[data-row="${move.row}"][data-col="${move.col}"]`);
                    targetCell.classList.add('valid-move');
                });
            }
            // 2. Hamle Yapma ve Sunucuya G√∂nderme
            else if (selectedPiece && cell.classList.contains('valid-move')) {
                const fromR = selectedPiece.r;
                const fromC = selectedPiece.c;
                const toR = r;
                const toC = c;
                
                // Hamleyi sunucuya g√∂nder
                socket.emit('make_move', { 
                    lobbyId: lobbyId, 
                    move: { from: {r: fromR, c: fromC}, to: {r: toR, c: toC} }
                });

                // Kendi tahtanƒ±zda hamleyi hemen uygulayƒ±n (Gecikmeyi √∂nler)
                applyMoveAndAnimate(fromR, fromC, toR, toC, false);
                
                selectedPiece = null;
            }
            // 3. Ge√ßersiz Tƒ±klama
            else {
                selectedPiece = null;
            }
        }
        
        // **********************************
        // *** LOBƒ∞ BUTONLARI ƒ∞≈ûLEVƒ∞ ***
        // **********************************
        
        function getUsername() {
            const name = usernameInput.value.trim();
            if (name.length < 3) {
                alert("L√ºtfen en az 3 karakterli bir kullanƒ±cƒ± adƒ± giriniz.");
                return null;
            }
            return name;
        }

        document.getElementById('create-lobby-button').addEventListener('click', () => {
            const username = getUsername();
            if (username && socket.connected) {
                socket.emit('create_lobby', username);
            }
        });

        document.getElementById('join-lobby-button').addEventListener('click', () => {
            const username = getUsername();
            const lobbyCode = lobbyCodeInput.value.trim();
            if (username && lobbyCode.length === 4 && socket.connected) {
                socket.emit('join_lobby', { lobbyId: lobbyCode, username: username });
            } else if (lobbyCode.length !== 4) {
                alert("L√ºtfen 4 haneli bir oda kodu giriniz.");
            }
        });

        document.getElementById('rank-match-button').addEventListener('click', () => {
            const username = getUsername();
            if (username && socket.connected) {
                socket.emit('start_rank_match', username);
            }
        });


    </script>
</body>
</html>
