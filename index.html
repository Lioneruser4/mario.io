<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saski Checkers Online</title>
    <!-- Tailwind CSS CDN (Stil için) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons CDN (Buton ikonları) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        
        /* Tema ve Genel Stil */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a2e; /* Koyu Mavi Arka Plan */
            color: #e5e5e5; /* Açık Gri Metin */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 1rem;
            box-sizing: border-box;
        }
        
        /* Buton Stili - Dikey düzen için tam genişlik */
        .game-button {
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: 0 8px 15px rgba(0,0,0,0.4), 0 4px 5px rgba(0,0,0,0.2);
            width: 100%; 
        }
        .game-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 20px rgba(0,0,0,0.5), 0 8px 8px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body class="p-4">

    <!-- Ana Konteyner - Maksimum 448px genişliğinde, mobil cihazlara uyumlu -->
    <div id="app-container" class="w-full max-w-sm bg-[#0f0f1d] p-8 rounded-xl shadow-2xl text-center">
        
        <!-- Başlık -->
        <h1 class="text-4xl font-extrabold mb-10 text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-orange-500">
            Saski Checkers Online
        </h1>
        
        <!-- Yükleme/Durum Mesajı -->
        <p id="status-message" class="mb-6 h-6 text-yellow-400 text-sm"></p>
        
        <!-- Butonlar Konteyneri (Alt Alta) -->
        <div class="flex flex-col space-y-6">
            
            <!-- 1. Dereceli Oyna Butonu -->
            <button id="ranked-play-btn" 
                    class="game-button py-4 px-6 bg-gradient-to-r from-red-600 to-red-800 hover:from-red-500 hover:to-red-700 text-white font-bold rounded-xl text-lg uppercase tracking-wider focus:outline-none focus:ring-4 focus:ring-red-500 focus:ring-opacity-50 disabled:opacity-50"
                    onclick="handleRankedPlay()">
                <span class="flex items-center justify-center">
                    <i data-lucide="trophy" class="mr-3 w-6 h-6"></i>
                    Dereceli Oyna
                </span>
            </button>
            
            <!-- 2. Dostunla Oyna Butonu -->
            <button id="friend-play-btn" 
                    class="game-button py-4 px-6 bg-gradient-to-r from-blue-600 to-blue-800 hover:from-blue-500 hover:to-blue-700 text-white font-bold rounded-xl text-lg uppercase tracking-wider focus:outline-none focus:ring-4 focus:ring-blue-500 focus:ring-opacity-50 disabled:opacity-50"
                    onclick="handleFriendPlay()">
                <span class="flex items-center justify-center">
                    <i data-lucide="users" class="mr-3 w-6 h-6"></i>
                    Dostunla Oyna
                </span>
            </button>
        </div>
        
    </div>

    <!-- JavaScript ve Firebase Modülleri -->
    <script type="module">
        // Gerekli Firebase kütüphanelerini import et
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, addDoc, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Uygulama global değişkenleri
        let db;
        let auth;
        let userId = null;
        const statusMessage = document.getElementById('status-message');
        
        // Butonlar
        const rankedBtn = document.getElementById('ranked-play-btn');
        const friendBtn = document.getElementById('friend-play-btn');

        // Butonları başlangıçta devre dışı bırak, Firebase bağlantısını bekleyecekler
        rankedBtn.disabled = true;
        friendBtn.disabled = true;

        // Platformdan sağlanan zorunlu global değişkenleri al
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        /**
         * Durum mesajını günceller.
         */
        const updateStatus = (message, type = 'info') => {
            statusMessage.textContent = message;
            // Renkleri Tailwind sınıfları ile ayarla
            statusMessage.className = 'mb-6 h-6 text-sm';
            if (type === 'error') {
                statusMessage.classList.add('text-red-400');
            } else if (type === 'success') {
                statusMessage.classList.add('text-green-400');
            } else {
                statusMessage.classList.add('text-yellow-400');
            }
        };

        /**
         * Firebase'i başlatır ve kullanıcı kimlik doğrulamasını yapar.
         */
        async function initializeFirebase() {
            updateStatus('Bağlanıyor...');

            if (!firebaseConfig) {
                updateStatus('HATA: Firebase konfigurasiyası bulunamadı.', 'error');
                console.error('HATA: Firebase konfigurasiyası bulunamadı. Uygulama çalışamaz.');
                return;
            }

            try {
                // Hata ayıklama seviyesini Debug yap (konsolda detaylı log görmek için)
                setLogLevel('Debug');
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Kimlik doğrulama işlemi
                await new Promise((resolve) => {
                    // onAuthStateChanged ile Auth durumunu izle ve resolve et
                    const unsubscribe = onAuthStateChanged(auth, async (user) => {
                        unsubscribe(); 
                        if (user) {
                            userId = user.uid;
                            resolve();
                        } else {
                            // Custom Token varsa onunla giriş yap, yoksa anonim giriş yap
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                            userId = auth.currentUser.uid;
                            resolve();
                        }
                    }, (error) => {
                        console.error("Kimlik doğrulama hatası:", error);
                        resolve(); 
                    });
                });
                
                if (userId) {
                    updateStatus('Hazır. Bir oyun modu seçin.', 'success');
                    // Kullanıcı Kimliği alındıktan sonra butonları etkinleştir
                    rankedBtn.disabled = false;
                    friendBtn.disabled = false;
                    
                    // Kullanıcı profil bilgisini Firestore'a kaydet (isteğe bağlı)
                    const userRef = doc(db, `artifacts/${appId}/users/${userId}/profile`, 'data');
                    await setDoc(userRef, { lastLogin: serverTimestamp(), userId: userId }, { merge: true });

                } else {
                    updateStatus('HATA: Kullanıcı kimliği alınamadı.', 'error');
                }

            } catch (error) {
                console.error("Firebase Başlatma/Auth Hatası:", error);
                updateStatus(`Kritik Hata: ${error.message}`, 'error');
            }
        }

        /**
         * Dereceli Oyna butonuna tıklandığında çalışır.
         * Eşleştirme lobisine kullanıcıyı ekler ve render bağlantısını simüle eder.
         */
        window.handleRankedPlay = async () => {
            if (!userId || !db) {
                updateStatus('Bağlantı bekleniyor.', 'error');
                return;
            }

            updateStatus('Eşleşme aranıyor...', 'info');
            rankedBtn.disabled = true;

            try {
                // Public Eşleştirme Koleksiyonuna ekle
                const matchmakingRef = collection(db, `artifacts/${appId}/public/data/matchmaking`);
                
                const newMatchRequest = {
                    userId: userId,
                    timestamp: serverTimestamp(),
                    status: 'searching',
                    gameType: 'ranked'
                };

                await addDoc(matchmakingRef, newMatchRequest);
                updateStatus(`Eşleşme aranıyor... (ID: ${userId})`, 'info');
                
                // Render URL'sine yönlendirme simülasyonu
                console.log("Oyun sunucusuna (Render) bağlanılıyor: https://mario-io-1.onrender.com");
                
            } catch (error) {
                console.error("Dereceli Oyna Hatası:", error);
                updateStatus(`Başlatılamadı: ${error.message}`, 'error');
                rankedBtn.disabled = false;
            }
        };

        /**
         * Dostunla Oyna butonuna tıklandığında çalışır.
         * Yeni bir özel lobi oluşturur ve lobi kodunu gösterir.
         */
        window.handleFriendPlay = async () => {
            if (!userId || !db) {
                updateStatus('Bağlantı bekleniyor.', 'error');
                return;
            }
            
            try {
                // Rastgele bir lobi kodu oluştur (6 karakter)
                const lobbyId = Math.random().toString(36).substring(2, 8).toUpperCase();
                // Public Lobiler Koleksiyonunda yeni bir doküman oluştur
                const lobbiesRef = doc(db, `artifacts/${appId}/public/data/lobbies`, lobbyId);

                await setDoc(lobbiesRef, {
                    hostId: userId,
                    createdAt: serverTimestamp(),
                    status: 'waiting',
                    players: [userId]
                });

                updateStatus(`Lobi Kodu: ${lobbyId}. Arkadaşına gönder!`, 'success');

            } catch (error) {
                console.error("Dostunla Oyna Hatası:", error);
                updateStatus(`Başlatılamadı: ${error.message}`, 'error');
            }
        };
        
        // Sayfa yüklendiğinde
        window.onload = () => {
            // Lucide ikonlarını oluştur
            lucide.createIcons();
            // Firebase'i başlat
            initializeFirebase();
        };

    </script>
</body>
</html>
