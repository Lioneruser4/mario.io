<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Az…ôrbaycan Damasƒ± (Dama) - Socket.IO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        /* Custom Styles (Eski kodunuzdan) */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        
        @keyframes pulse-fast {
            0%, 100% { box-shadow: 0 0 0 0 rgba(251, 113, 133, 0.7); }
            50% { box-shadow: 0 0 15px 15px rgba(251, 113, 133, 0.5); }
        }
        @keyframes flicker {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        .animate-pulse-fast { animation: pulse-fast 1s infinite cubic-bezier(0.4, 0, 0.6, 1); }
        .animate-flicker { animation: flicker 0.5s infinite alternate; }
        .title-glow { text-shadow: 0 0 10px #f97316, 0 0 20px #f97316; }
        .button-glow { transition: all 0.3s; box-shadow: 0 0 10px rgba(236, 72, 153, 0.5); }
        .button-glow:hover { box-shadow: 0 0 20px rgba(236, 72, 153, 0.8); }

        .board {
            display: grid;
            /* H√ºceyr…ô √∂l√ß√ºl…ôrini adaptiv saxla, maksimum 55px */
            grid-template-columns: repeat(8, min(11vw, 55px));
            grid-template-rows: repeat(8, min(11vw, 55px));
            border: 8px solid #334155;
            box-shadow: 0 15px 25px rgba(0, 0, 0, 0.7);
            border-radius: 12px;
            overflow: hidden;
            touch-action: manipulation;
            margin: 0 auto;
        }
        .cell {
            width: min(11vw, 55px);
            height: min(11vw, 55px);
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.2s;
        }
        .piece {
            width: 80%;
            height: 80%;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: min(4vw, 1.5rem); /* ≈ûrift √∂l√ß√ºs√ºn√º d…ô adaptiv et */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            border: 2px solid;
            cursor: pointer;
            user-select: none;
        }
        .piece-white { background-color: #fff; color: #1f2937; border-color: #9ca3af; }
        .piece-black { background-color: #1f2937; color: #fff; border-color: #4b5563; }
        @keyframes pulse-slow {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.9, transform: scale(1.05); }
        }
        .piece-king { animation: pulse-slow 2s ease-in-out infinite; }
        .piece-king-white { background: linear-gradient(145deg, #fef3c7, #fde047); }
        .piece-king-black { background: linear-gradient(145deg, #4b5563, #374151); color: #fde047; }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { 'primary-dark': '#1e293b', 'accent': '#ec4899', },
                }
            }
        }
    </script>
</head>
<body class="bg-gray-900 text-white font-['Inter'] min-h-screen flex flex-col items-center justify-center p-4">

    <header class="text-center mb-6">
        <h1 class="text-4xl font-black title-glow text-orange-500 mb-2">AZ∆èRBAYCAN DAMA OYUNU</h1>
        <div id="connection-status" class="text-sm font-semibold mb-4 text-red-500 animate-flicker">Server…ô qo≈üulur...</div>
        <div id="user-info-display" class="text-xs text-gray-400">
            <span id="user-name-display">ƒ∞stifad…ô√ßi: Y√ºkl…ônir...</span> |
            <span id="current-user-id-display">ID: ...</span>
        </div>
    </header>

    <div id="message-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden flex items-center justify-center z-50">
        <div class="bg-primary-dark p-8 rounded-xl shadow-2xl max-w-sm w-full text-center border-t-4 border-accent">
            <p id="modal-message" class="text-lg font-semibold mb-4 text-white"></p>
            <button id="modal-close-btn" class="w-full bg-accent hover:bg-pink-700 text-white font-bold py-2 px-4 rounded-lg button-glow">Baƒüla</button>
        </div>
    </div>

    <div id="loader" class="flex flex-col items-center justify-center h-48">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-accent"></div>
        <p class="mt-4 text-lg text-gray-400">Y√ºkl…ônir...</p>
    </div>

    <div id="lobby-screen" class="hidden w-full max-w-md bg-primary-dark p-6 rounded-xl shadow-2xl">
        <h2 class="text-2xl font-bold text-center text-white mb-4">Oyun Lobisi</h2>
        <p id="lobi-status-message" class="text-center text-sm mb-6 text-gray-300">Oyun rejimi se√ßin.</p>

        <div class="space-y-4">
            <button id="dereceli-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-extrabold py-3 rounded-xl transition duration-300 shadow-lg animate-pulse-fast">
                üèÜ Reytinqli Oyna (Axtar)
            </button>
            <button id="deregeli-cancel-btn" class="hidden w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 rounded-xl transition duration-300">
                L…ôƒüv Et
            </button>

            <div class="relative flex items-center py-2">
                <div class="flex-grow border-t border-gray-600"></div>
                <span class="flex-shrink mx-4 text-gray-500">V∆è YA</span>
                <div class="flex-grow border-t border-gray-600"></div>
            </div>

            <button id="create-room-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl transition duration-300">
                ‚ûï Dostla Oyna (Otaq Yarat)
            </button>
            <div class="text-center text-sm text-gray-400">
                Otaq Kodu: <span id="room-code-output" class="font-mono text-lg text-accent">...</span>
                <button id="copy-code-btn" class="ml-2 text-green-400 hover:text-green-300 text-xs">Kopyala</button>
            </div>

            <div class="flex space-x-2 pt-2">
                <input type="text" id="join-room-input" placeholder="Otaq kodu (4 r…ôq…ôm)" maxlength="4" class="flex-grow p-3 rounded-xl bg-gray-700 text-white placeholder-gray-400 border border-gray-600 focus:border-accent focus:ring-1 focus:ring-accent outline-none">
                <button id="join-room-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-xl transition duration-300">
                    Qo≈üul
                </button>
            </div>
        </div>
    </div>

    <main id="game-screen" class="hidden w-full max-w-4xl flex flex-col md:flex-row items-center md:items-start justify-center p-4 space-y-4 md:space-y-0 md:space-x-8">
        
        <div class="flex flex-col items-center space-y-4 w-full md:w-auto order-2 md:order-1">
            <div class="flex justify-between w-full md:w-72 p-2 bg-gray-800 rounded-lg shadow-md">
                <div class="text-center">
                    <p class="text-sm text-gray-400">Aƒü (R…ôqib)</p>
                    <p id="white-timer" class="p-2 rounded-lg font-mono text-xl text-white shadow-md bg-gray-700">0:00</p>
                </div>
                <div class="text-center">
                    <p class="text-sm text-gray-400">Qara (Siz)</p>
                    <p id="black-timer" class="p-2 rounded-lg font-mono text-xl text-white shadow-md bg-gray-700">0:00</p>
                </div>
            </div>
            
            <div id="current-turn-display" class="text-lg font-bold p-2 rounded-lg bg-yellow-600 text-white shadow-lg transition duration-300 w-full md:w-72 text-center">
                Y√ºkl…ônir...
            </div>

            <button id="leave-game-btn" class="w-full md:w-72 bg-red-700 hover:bg-red-800 text-white font-bold py-2 rounded-xl transition duration-300 mt-4">
                Oyunu T…ôrk Et
            </button>
        </div>

        <div id="board" class="board bg-gray-700 order-1 md:order-2">
            </div>
        
    </main>

    <script>
        // Global d…ôyi≈ü…ônl…ôr
        const SERVER_URL = "https://mario-io-1.onrender.com";
        const BOARD_SIZE = 8;
        const TIMER_DURATION = 120; // 2 d…ôqiq…ô
        
        let socket;
        let currentUserId = null;
        let currentUserName = null;
        let currentRoomId = null;
        let isMyTurn = false;
        let myColor = null; // 'black' v…ô ya 'white'
        let selectedPiece = null; // {r, c}
        let boardState = null;
        
        // UI Elementl…ôri
        const loader = document.getElementById('loader');
        const lobbyScreen = document.getElementById('lobby-screen');
        const gameScreen = document.getElementById('game-screen');
        const userNameDisplay = document.getElementById('user-name-display');
        const currentUserIdDisplay = document.getElementById('current-user-id-display');
        const connectionStatus = document.getElementById('connection-status');
        const dereceliBtn = document.getElementById('dereceli-btn');
        const deregeliCancelBtn = document.getElementById('deregeli-cancel-btn');
        const lobiStatusMessage = document.getElementById('lobi-status-message');
        const createRoomBtn = document.getElementById('create-room-btn');
        const roomCodeOutput = document.getElementById('room-code-output');
        const copyCodeBtn = document.getElementById('copy-code-btn');
        const joinRoomInput = document.getElementById('join-room-input');
        const joinRoomBtn = document.getElementById('join-room-btn');
        const boardElement = document.getElementById('board');
        const currentTurnDisplay = document.getElementById('current-turn-display');
        const whiteTimerDisplay = document.getElementById('white-timer');
        const blackTimerDisplay = document.getElementById('black-timer');
        const leaveGameBtn = document.getElementById('leave-game-btn');
        const messageModal = document.getElementById('message-modal');
        const modalMessage = document.getElementById('modal-message');
        const modalCloseBtn = document.getElementById('modal-close-btn');

        // --- Yardƒ±m√ßƒ± Funksiyalar ---

        function getTelegramUser() {
            const urlParams = new URLSearchParams(window.location.search);
            const tgUserId = urlParams.get('tg_user_id') || urlParams.get('id');
            const tgUsername = urlParams.get('tg_username') || urlParams.get('name');

            return {
                id: tgUserId || 'anon_' + Math.random().toString(36).substring(2, 9),
                name: tgUsername ? decodeURIComponent(tgUsername) : 'Anonim ƒ∞stifad…ô√ßi',
            };
        }

        function showModal(message, callback = null) {
            modalMessage.textContent = message;
            messageModal.classList.remove('hidden');
            modalCloseBtn.onclick = () => {
                messageModal.classList.add('hidden');
                if (callback) callback();
            };
        }

        function showScreen(screen) {
            loader.classList.add('hidden');
            lobbyScreen.classList.add('hidden');
            gameScreen.classList.add('hidden');
            deregeliCancelBtn.classList.add('hidden');
            dereceliBtn.classList.remove('hidden');

            if (screen === 'lobby') {
                lobbyScreen.classList.remove('hidden');
                lobiStatusMessage.textContent = 'Oyun rejimi se√ßin.';
                currentRoomId = null;
                roomCodeOutput.textContent = '...';
            } else if (screen === 'game') {
                lobbyScreen.classList.add('hidden'); // Ensure lobby is hidden
                gameScreen.classList.remove('hidden');
            } else if (screen === 'searching') {
                lobbyScreen.classList.remove('hidden');
                deregeliCancelBtn.classList.remove('hidden');
                dereceliBtn.classList.add('hidden');
                lobiStatusMessage.textContent = 'üèÜ Reytinqli R…ôqib axtarƒ±lƒ±r... L√ºtf…ôn g√∂zl…ôyin.';
            } else {
                loader.classList.remove('hidden');
            }
        }

        function formatTime(seconds) {
            const min = Math.floor(seconds / 60);
            const sec = Math.max(0, seconds % 60); // M…ônfi olmamasƒ± √º√ß√ºn
            return `${min}:${sec.toString().padStart(2, '0')}`;
        }

        // --- Dama Taxtasƒ±nƒ±n √á…ôkilm…ôsi ---

        function getPiecePlayer(pieceValue) {
            if (pieceValue === 1 || pieceValue === 3) return 'white';
            if (pieceValue === 2 || pieceValue === 4) return 'black';
            return null;
        }

        function getPieceSymbol(pieceValue) {
            if (pieceValue === 1 || pieceValue === 2) return '‚óè';
            if (pieceValue === 3 || pieceValue === 4) return '‚ôõ';
            return '';
        }

        function drawBoard(board, turn, mandatoryCapture = null) {
            boardElement.innerHTML = '';
            boardState = board;

            for (let r = 0; r < BOARD_SIZE; r++) {
                for (let c = 0; c < BOARD_SIZE; c++) {
                    const cell = document.createElement('div');
                    cell.className = `cell ${ (r + c) % 2 === 0 ? 'bg-gray-200 hover:bg-gray-300' : 'bg-gray-500 hover:bg-gray-600' }`;
                    cell.dataset.row = r;
                    cell.dataset.col = c;
                    cell.onclick = handleBoardClick;

                    const pieceValue = board[r][c];
                    if (pieceValue !== 0) {
                        const piece = document.createElement('div');
                        const player = getPiecePlayer(pieceValue);
                        const isKing = pieceValue === 3 || pieceValue === 4;

                        piece.className = `piece ${player === 'white' ? 'piece-white' : 'piece-black'} ${isKing ? `piece-king ${player === 'white' ? 'piece-king-white' : 'piece-king-black'}` : ''}`;
                        piece.textContent = getPieceSymbol(pieceValue);
                        piece.dataset.row = r;
                        piece.dataset.col = c;
                        
                        // ∆èg…ôr da≈ü se√ßilibs…ô, vurƒüu (highlight) …ôlav…ô et
                        if (selectedPiece && selectedPiece.r === r && selectedPiece.c === c) {
                            piece.classList.add('ring-4', 'ring-offset-2', 'ring-accent', 'ring-offset-primary-dark');
                        }
                        
                        // N√∂vb…ô bu da≈üdadƒ±rsa v…ô m…ôcburi yem…ô varsa, onu vurƒüula
                        if (mandatoryCapture && mandatoryCapture.r === r && mandatoryCapture.c === c) {
                            piece.classList.add('ring-4', 'ring-offset-2', 'ring-red-500', 'ring-offset-primary-dark', 'animate-pulse-fast');
                        }

                        cell.appendChild(piece);
                    }

                    // H…ôr…ôk…ôt ed…ô bil…ôc…ôyi xanalarƒ± vurƒüulamaq
                    if (selectedPiece) {
                        // TODO: Serverd…ôn g…ôl…ôn m√ºmk√ºn h…ôr…ôk…ôtl…ôr…ô …ôsas…ôn vurƒüulamaq daha yax≈üƒ±dƒ±r
                        // Sad…ôlik √º√ß√ºn burada xanalarƒ±n vurƒüulanmasƒ± m…ôntiqi server cavabƒ±ndan sonra i≈ül…ônm…ôlidir.
                    }

                    boardElement.appendChild(cell);
                }
            }
        }
        
        // --- Oyun M…ôntiqi (Client T…ôr…ôfi) ---

        function handleBoardClick(event) {
            if (!socket || !isMyTurn) {
                return showModal("G√∂zl…ôyin, n√∂vb…ô sizin deyil.");
            }

            const targetCell = event.currentTarget.tagName === 'DIV' && event.currentTarget.classList.contains('cell') ? event.currentTarget : null;
            if (!targetCell) return;

            const r = parseInt(targetCell.dataset.row);
            const c = parseInt(targetCell.dataset.col);
            const pieceValue = boardState[r][c];
            const piecePlayer = getPiecePlayer(pieceValue);
            const isMyPiece = piecePlayer === myColor;

            if (isMyPiece) {
                // √ñz da≈üƒ±mƒ± se√ßdim
                if (selectedPiece && selectedPiece.r === r && selectedPiece.c === c) {
                    // Eyni da≈üa t…ôkrar klik - se√ßimi l…ôƒüv et
                    selectedPiece = null;
                    drawBoard(boardState, myColor); // UI-ƒ± yenil…ô
                } else {
                    // Yeni da≈ü se√ß
                    selectedPiece = { r, c };
                    drawBoard(boardState, myColor); // UI-ƒ± yenil…ô
                }
            } else if (selectedPiece) {
                // Se√ßilmi≈ü da≈üla h…ôr…ôk…ôt etm…ôk
                const fromR = selectedPiece.r;
                const fromC = selectedPiece.c;
                const toR = r;
                const toC = c;
                
                // H…ôr…ôk…ôt t…ôklifini server…ô g√∂nd…ôr
                socket.emit('makeMove', {
                    roomId: currentRoomId,
                    from: { r: fromR, c: fromC },
                    to: { r: toR, c: toC },
                    player: myColor
                });
                
                // Server cavabƒ±nƒ± g√∂zl…ôy…ôrk…ôn se√ßimi l…ôƒüv et
                selectedPiece = null;
                drawBoard(boardState, myColor); // Vurƒüunu l…ôƒüv et
            }
        }

        // --- Server ∆èlaq…ôsi (Socket.IO) ---
        
        function initSocket() {
            const userData = getTelegramUser();
            currentUserId = userData.id;
            currentUserName = userData.name;
            userNameDisplay.textContent = `ƒ∞stifad…ô√ßi: ${currentUserName}`;
            currentUserIdDisplay.textContent = `ID: ${currentUserId}`;

            // Socket.IO qo≈üulmasƒ±, qo≈üulma zamanƒ± user ID-ni g√∂nd…ôr
            socket = io(SERVER_URL, {
                query: { 
                    userId: currentUserId,
                    userName: currentUserName
                },
                transports: ['websocket', 'polling']
            });

            showScreen('loading');

            socket.on('connect', () => {
                connectionStatus.textContent = "‚úÖ Server…ô qo≈üulmu≈üdur";
                connectionStatus.className = "text-sm font-semibold mb-4 text-green-500";
                showScreen('lobby');
            });

            socket.on('disconnect', () => {
                connectionStatus.textContent = "‚ùå Serverl…ô …ôlaq…ô k…ôsildi";
                connectionStatus.className = "text-sm font-semibold mb-4 text-red-500 animate-flicker";
                showScreen('loading');
                clearInterval(timerInterval);
                timerInterval = null;
            });
            
            socket.on('error', (message) => {
                showModal(`X…ôta: ${message}`);
            });
            
            // --- Oyun Hadis…ôl…ôri ---
            
            socket.on('statusUpdate', (data) => {
                // H…ôr hansƒ± bir UI yenil…ôm…ôsi (M…ôs: reytinq axtarƒ±≈üƒ± mesajlarƒ±)
                if (data.status === 'searching') {
                    showScreen('searching');
                } else if (data.status === 'matchFound' && data.roomId) {
                    // Otaƒüa daxil olun, lakin 'roomUpdate' g…ôlm…ôlidir
                    currentRoomId = data.roomId;
                    roomCodeOutput.textContent = data.roomId;
                    showModal("R…ôqib tapƒ±ldƒ±! Oyuna daxil olursunuz...");
                } else if (data.status === 'waitingForFriend') {
                    currentRoomId = data.roomId;
                    roomCodeOutput.textContent = data.roomId;
                    lobiStatusMessage.textContent = `Otaq yaradƒ±ldƒ±: ${data.roomId}. R…ôqib g√∂zl…ônilir...`;
                    showScreen('lobby');
                }
            });

            socket.on('roomUpdate', (data) => {
                currentRoomId = data.roomId;
                myColor = data.playerBlackId === currentUserId ? 'black' : (data.playerWhiteId === currentUserId ? 'white' : null);
                
                if (!myColor) return showModal("Otaƒüa qo≈üulmaq m√ºmk√ºn olmadƒ±: R…ông t…ôyin edilm…ôyib.");

                if (data.status === 'playing') {
                    showScreen('game');
                    updateGameUI(data);
                } else if (data.status.startsWith('waiting')) {
                    // G√∂zl…ôm…ô statusunda qal
                    const waitingMessage = data.status.includes('ranked') ? 'üèÜ Reytinqli R…ôqib axtarƒ±lƒ±r...' : `Otaq kodu: ${data.roomId}. R…ôqib g√∂zl…ônilir...`;
                    lobiStatusMessage.textContent = waitingMessage;
                    showScreen(data.status.includes('ranked') ? 'searching' : 'lobby');
                } else if (data.status === 'finished') {
                    const winnerMessage = data.reason ? data.reason : `Oyun Bitdi! Qalib: ${data.winner}`;
                    showModal(winnerMessage, () => {
                         leaveGame(false); // Avtomatik lobbiy…ô qayƒ±t
                    });
                }
            });
            
            socket.on('moveConfirmed', (data) => {
                // H…ôr…ôk…ôt t…ôsdiql…ôndi, UI yenil…ôndi.
                updateGameUI(data);
            });
            
            socket.on('gameMessage', (message) => {
                showModal(message);
            });

            socket.on('timerUpdate', (timers) => {
                whiteTimerDisplay.textContent = formatTime(timers.white);
                blackTimerDisplay.textContent = formatTime(timers.black);
            });
        }
        
        // Timer
        let timerInterval = null;
        function startTimerLoop(roomId) {
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                // Serverd…ô vaxtƒ±n bitm…ôsi yoxlanƒ±lƒ±r, biz sad…ôc…ô vizual olaraq yenil…ôyirik
                socket.emit('requestTimerUpdate', { roomId });
            }, 1000); 
        }

        // UI-ƒ± yenil…ôm…ôk
        function updateGameUI(data) {
            const myTurn = data.turn === myColor;
            isMyTurn = myTurn;

            currentTurnDisplay.textContent = myTurn ? 'Sizin N√∂vb…ônizdir' : `R…ôqibd…ôdir (${data.turn === 'black' ? 'Qara' : 'Aƒü'})`;
            currentTurnDisplay.className = `text-lg font-bold p-2 rounded-lg ${myTurn ? 'bg-green-600' : 'bg-yellow-600'} text-white shadow-lg transition duration-300 w-full md:w-72 text-center`;

            // R…ôngl…ôri d√ºz…ôlt (Siz Qara, R…ôqib Aƒü)
            const myTimerDisplay = myColor === 'black' ? blackTimerDisplay : whiteTimerDisplay;
            const opponentTimerDisplay = myColor === 'white' ? blackTimerDisplay : whiteTimerDisplay;

            myTimerDisplay.parentElement.querySelector('p').textContent = myColor === 'black' ? 'Qara (Siz)' : 'Aƒü (Siz)';
            opponentTimerDisplay.parentElement.querySelector('p').textContent = myColor === 'black' ? 'Aƒü (R…ôqib)' : 'Qara (R…ôqib)';

            // Timer Vurƒüusu
            const whiteTimerClass = data.turn === 'white' ? 'bg-red-500 animate-flicker' : 'bg-gray-700';
            const blackTimerClass = data.turn === 'black' ? 'bg-red-500 animate-flicker' : 'bg-gray-700';

            whiteTimerDisplay.className = `p-2 rounded-lg font-mono text-xl text-white shadow-md ${whiteTimerClass}`;
            blackTimerDisplay.className = `p-2 rounded-lg font-mono text-xl text-white shadow-md ${blackTimerClass}`;

            drawBoard(data.board, data.turn, data.mandatoryCapture);
        }

        // --- Lobiya Funksionallƒ±ƒüƒ± (Socket.IO-ya uyƒüunla≈üdƒ±rƒ±lmƒ±≈ü) ---

        // 1. Reytinqli E≈ül…ô≈üm…ô
        dereceliBtn.onclick = () => {
            if (!socket || !socket.connected) return showModal("Server…ô qo≈üulmayƒ±b.");
            showScreen('searching');
            socket.emit('startRankedMatchmaking', { userId: currentUserId, userName: currentUserName });
        };

        deregeliCancelBtn.onclick = () => {
            if (!socket || !socket.connected) return;
            socket.emit('cancelRankedMatchmaking', { userId: currentUserId });
            showScreen('lobby');
            currentRoomId = null;
        };

        // 2. Dostla Oyna (Otaq Yarat)
        createRoomBtn.onclick = () => {
            if (!socket || !socket.connected) return showModal("Server…ô qo≈üulmayƒ±b.");
            showScreen('loading');
            socket.emit('createRoom', { userId: currentUserId, userName: currentUserName });
        };

        // Kodu Kopyala
        copyCodeBtn.onclick = () => {
            const code = roomCodeOutput.textContent;
            if (code && code !== '...') {
                try {
                    navigator.clipboard.writeText(code).then(() => {
                        showModal(`Otaq kodu (${code}) kopyalandƒ±!`);
                    }).catch(err => {
                        throw new Error("Kopyalama x…ôtasƒ±");
                    });
                } catch (err) {
                    // ∆èg…ôr navigator.clipboard i≈ül…ômirs…ô, k√∂hn…ô √ºsula qayƒ±t
                    const tempInput = document.createElement('input');
                    document.body.appendChild(tempInput);
                    tempInput.value = code;
                    tempInput.select();
                    document.execCommand('copy');
                    document.body.removeChild(tempInput);
                    showModal(`Otaq kodu (${code}) kopyalandƒ±! (K√∂hn…ô metod)`);
                }
            }
        };

        // 3. Koda Qo≈üul
        joinRoomBtn.onclick = () => {
            if (!socket || !socket.connected) return showModal("Server…ô qo≈üulmayƒ±b.");
            const roomCode = joinRoomInput.value.trim();
            if (roomCode.length !== 4) return showModal("Xahi≈ü edirik, 4 r…ôq…ômli otaq kodunu daxil edin.");

            showScreen('loading');
            socket.emit('joinRoom', { 
                roomId: roomCode, 
                userId: currentUserId, 
                userName: currentUserName 
            });
            joinRoomInput.value = '';
        };

        // Oyunu t…ôrk etm…ôk
        leaveGameBtn.onclick = () => leaveGame(true);

        function leaveGame(notifyServer) {
            if (!currentRoomId) {
                showScreen('lobby');
                return;
            }
            
            clearInterval(timerInterval);
            timerInterval = null;
            
            if (notifyServer && socket && socket.connected) {
                // Server…ô oyunu t…ôrk etdiyimi bildir
                socket.emit('leaveRoom', { roomId: currentRoomId, userId: currentUserId });
            }
            
            // Client t…ôr…ôfind…ô t…ômizl…ô
            currentRoomId = null;
            selectedPiece = null;
            myColor = null;
            showScreen('lobby');
        }


        // Ba≈ülanƒüƒ±c
        document.addEventListener('DOMContentLoaded', initSocket);

    </script>
</body>
</html>
