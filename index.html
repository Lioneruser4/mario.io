<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matter.js Kƒ±lƒ±√ßlƒ± Top D√ºellosu</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        /* Genel Stil */
        body {
            font-family: 'Arial', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #2c3e50;
            color: #ecf0f1;
            flex-direction: column;
            overflow: hidden; /* Dƒ±≈üarƒ± ta≈üan top divlerini gizle */
        }

        /* Ana Oyun Konteyneri */
        #game-container {
            position: relative;
            width: 800px;
            height: 800px;
            border: 10px solid #3498db;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            background-color: #3b5971;
            overflow: hidden;
        }

        /* Top Fotoƒüraf Divleri (Matter.js toplarƒ±nƒ± kaplar) */
        .ball-photo-div {
            position: absolute;
            width: 80px; /* CONFIG.ballRadius * 2 */
            height: 80px; /* CONFIG.ballRadius * 2 */
            border-radius: 50%;
            background-size: cover;
            background-position: center;
            transition: transform 0.05s ease-out; /* Hafif vuru≈ü animasyonu i√ßin */
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 40px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }
        
        /* Kƒ±lƒ±√ß ƒ∞konu */
        .sword-icon {
            position: absolute;
            top: -20px;
            right: -20px;
            font-size: 30px;
            transform-origin: 50% 100%;
            display: none;
            text-shadow: 0 0 5px #f1c40f;
        }

        /* Vurulma Efekti */
        .hit-effect {
            animation: hit-shake 0.3s ease-in-out;
            box-shadow: 0 0 20px 5px #e74c3c;
        }

        @keyframes hit-shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            20% { transform: translate(-3px, 0px) rotate(-2deg); }
            40% { transform: translate(3px, 1px) rotate(2deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            80% { transform: translate(1px, -1px) rotate(2deg); }
            100% { transform: translate(1px, 1px) rotate(0deg); }
        }

        /* E≈üya ƒ∞konu */
        #item-emoji {
            position: absolute;
            font-size: 40px;
            transform: translate(-50%, -50%);
            display: none;
            z-index: 10;
        }

        /* Bilgi Paneli */
        .info-panel {
            width: 800px;
            max-width: 100%;
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
        }

        .player-status {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            border-radius: 8px;
            background-color: #34495e;
            width: 45%;
        }

        .health-bar-container {
            width: 90%;
            background-color: #c0392b;
            border-radius: 5px;
            overflow: hidden;
            margin-top: 5px;
        }

        .health-bar {
            height: 15px;
            background-color: #27ae60;
            transition: width 0.3s ease-in-out;
        }

        .health-bar.low-health {
            background-color: #f1c40f;
        }
        
        /* Modal Stilleri */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .modal-content {
            background-color: #34495e;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.7);
        }

        .player-setup {
            display: flex;
            justify-content: space-around;
            gap: 20px;
            margin-bottom: 20px;
        }

        .player-setup div {
            flex: 1;
        }

        input[type="text"], input[type="file"] {
            padding: 10px;
            margin: 5px 0 15px;
            border: none;
            border-radius: 5px;
            width: 100%;
            box-sizing: border-box;
        }

        .file-upload-label {
            display: block;
            background-color: #2980b9;
            color: white;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 10px;
        }

        .file-preview {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: #7f8c8d;
            background-size: cover;
            background-position: center;
            margin: 10px auto;
            border: 3px solid white;
        }

        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background-color: #2ecc71;
            color: white;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        button:hover:not(:disabled) {
            background-color: #27ae60;
        }

        button:disabled {
            background-color: #7f8c8d;
            cursor: not-allowed;
        }

        /* Oyun Sonu Modal */
        #game-over-modal .modal-content {
            padding: 50px;
        }
        
        #game-over-modal h2 {
            font-size: 30px;
            margin-bottom: 20px;
            color: #f1c40f;
        }

        #winner-emoji {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin: 20px auto;
        }
        
        /* Matter.js Canvas gizleme */
        #game-container canvas {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1; /* Alttaki photo div'in arkasƒ±nda kalmasƒ± i√ßin */
            display: none !important; /* Toplarƒ±n varsayƒ±lan Matter.js render'ƒ±nƒ± gizle */
        }
    </style>
</head>
<body>

    <div class="info-panel">
        <div id="p1-health" class="player-status">
            <h3 id="p1-name-display">Oyuncu 1 Can: 5/5</h3>
            <div class="health-bar-container">
                <div class="health-bar" style="width: 100%;"></div>
            </div>
        </div>
        <button id="customize-button">Yeni Oyun Kur/√ñzelle≈ütir</button>
        <div id="p2-health" class="player-status">
            <h3 id="p2-name-display">Oyuncu 2 Can: 5/5</h3>
            <div class="health-bar-container">
                <div class="health-bar" style="width: 100%;"></div>
            </div>
        </div>
    </div>

    <div id="game-container">
        <div id="ball1-photo" class="ball-photo-div" style="background-color: #FF5252;">
            üî¥
            <span id="p1-sword" class="sword-icon">‚öîÔ∏è</span>
        </div>
        <div id="ball2-photo" class="ball-photo-div" style="background-color: #2196F3;">
            üîµ
            <span id="p2-sword" class="sword-icon">‚öîÔ∏è</span>
        </div>
        <div id="item-emoji">‚öîÔ∏è</div>
    </div>

    <div id="setup-modal" class="modal" style="display: flex;">
        <div class="modal-content">
            <h2>Oyunu √ñzelle≈ütir</h2>
            <div class="player-setup">
                <div>
                    <h3>Oyuncu 1 (üî¥)</h3>
                    <input type="text" id="p1-name-input" placeholder="ƒ∞sim Girin (√∂rn: Kaptan)">
                    <input type="file" id="p1-file" accept="image/*" style="display: none;">
                    <label for="p1-file" class="file-upload-label">Fotoƒüraf Y√ºkle</label>
                    <div id="p1-preview" class="file-preview"></div>
                </div>
                <div>
                    <h3>Oyuncu 2 (üîµ)</h3>
                    <input type="text" id="p2-name-input" placeholder="ƒ∞sim Girin (√∂rn: Demir Adam)">
                    <input type="file" id="p2-file" accept="image/*" style="display: none;">
                    <label for="p2-file" class="file-upload-label">Fotoƒüraf Y√ºkle</label>
                    <div id="p2-preview" class="file-preview"></div>
                </div>
            </div>
            <button id="start-custom-game-button" disabled>Oyunu Ba≈ülat</button>
        </div>
    </div>

    <div id="game-over-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <h2 id="winner-text"></h2>
            <div id="winner-emoji"></div>
            <button id="restart-button">Tekrar Oyna (Aynƒ± Ayarlar)</button>
            <button id="new-game-button">Yeni Oyun Kur</button>
        </div>
    </div>

    <script>
        // Matter.js Mod√ºlleri
        const { Engine, Render, Runner, Bodies, Composite, Events, Body } = Matter;

        // --- GLOBAL SABƒ∞TLER (Kodunuzdaki eksikleri tamamlamak i√ßin) ---
        const MAX_HEALTH = 5;
        const MAX_SPEED = 8;
        const ITEM_RESPAWN_TIME = 3000;
        let INITIAL_BALL_RADIUS = 40; 
        let arenaWidth = 800;
        let arenaHeight = 800;

        // --- GLOBAL DEƒûƒ∞≈ûKENLER (Kodunuzdaki eksikleri tamamlamak i√ßin) ---
        let engine, render, runner, world;
        let ball1, ball2;
        let currentItem = null;
        let itemSpawnTimer = null;
        let isGameOver = true;
        
        // HTML Elementleri
        const gameContainer = document.getElementById('game-container');
        const photo1Div = document.getElementById('ball1-photo');
        const photo2Div = document.getElementById('ball2-photo');
        const itemEmojiDiv = document.getElementById('item-emoji');
        const p1NameDisplay = document.getElementById('p1-name-display');
        const p2NameDisplay = document.getElementById('p2-name-display');
        const setupModal = document.getElementById('setup-modal');
        const gameOverModal = document.getElementById('game-over-modal');
        const winnerText = document.getElementById('winner-text');
        const winnerEmoji = document.getElementById('winner-emoji');
        const customizeButton = document.getElementById('customize-button');
        const startGameCustomButton = document.getElementById('start-custom-game-button');
        const restartButton = document.getElementById('restart-button');
        const newGameButton = document.getElementById('new-game-button');
        const p1NameInput = document.getElementById('p1-name-input');
        const p2NameInput = document.getElementById('p2-name-input');
        const p1Preview = document.getElementById('p1-preview');
        const p2Preview = document.getElementById('p2-preview');

        // Oyun ayarlarƒ± (Matter.js ve Mantƒ±k i√ßin birle≈ütirilmi≈ü)
        const CONFIG = {
            arenaSize: 800,
            ballRadius: INITIAL_BALL_RADIUS,
            maxHealth: MAX_HEALTH,
            itemSize: 40,
            itemRespawnTime: ITEM_RESPAWN_TIME,
            maxSpeed: MAX_SPEED,
            colors: ['#FF5252', '#4CAF50', '#2196F3', '#FFC107', '#9C27B0', '#00BCD4']
        };

        // Oyuncu Bilgileri (Global state'e ta≈üƒ±ndƒ± ve eksikler tamamlandƒ±)
        const playerInfo = {
            ball1: {
                id: 'ball1',
                name: 'Oyuncu 1',
                health: MAX_HEALTH,
                hasSword: false,
                texture: '',
                emoji: 'üî¥',
                color: CONFIG.colors[0],
                photoDiv: photo1Div,
                nameDisplay: p1NameDisplay,
                healthBar: document.getElementById('p1-health').querySelector('.health-bar'),
                swordIcon: document.getElementById('p1-sword')
            },
            ball2: {
                id: 'ball2',
                name: 'Oyuncu 2',
                health: MAX_HEALTH,
                hasSword: false,
                texture: '',
                emoji: 'üîµ',
                color: CONFIG.colors[2],
                photoDiv: photo2Div,
                nameDisplay: p2NameDisplay,
                healthBar: document.getElementById('p2-health').querySelector('.health-bar'),
                swordIcon: document.getElementById('p2-sword')
            }
        };

        // Rastgele Renk √úretici
        function getRandomColor() {
            const letters = '0123456789ABCDEF';
            let color = '#';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }
        
        // --- RESPONSIVE VE ARENA Y√ñNETƒ∞Mƒ∞ ---

        function updateArenaSize() {
            const container = gameContainer;
            const size = Math.min(container.clientWidth, container.clientHeight);
            
            arenaWidth = size;
            arenaHeight = size;
            INITIAL_BALL_RADIUS = size * 0.05; // %5 yarƒ±√ßap
            CONFIG.ballRadius = INITIAL_BALL_RADIUS;
            
            // Matter.js Render boyutunu g√ºncelle
            if (render) {
                Render.stop(render);
                render.canvas.width = arenaWidth;
                render.canvas.height = arenaHeight;
                render.options.width = arenaWidth;
                render.options.height = arenaHeight;
                Render.run(render);
            }

            // Top divlerini ve yarƒ±√ßaplarƒ±nƒ± g√ºncelle
            const ballDiameter = INITIAL_BALL_RADIUS * 2;
            photo1Div.style.width = `${ballDiameter}px`;
            photo1Div.style.height = `${ballDiameter}px`;
            photo2Div.style.width = `${ballDiameter}px`;
            photo2Div.style.height = `${ballDiameter}px`;
            
            if (ball1 && ball2) {
                Body.set(ball1, 'circleRadius', INITIAL_BALL_RADIUS);
                Body.set(ball2, 'circleRadius', INITIAL_BALL_RADIUS);
            }

            // Duvarlarƒ± yeniden olu≈ütur
            if (world) setupWalls();
        }

        function setupWalls() {
            if (!world) return;
            // Eski duvarlarƒ± temizle
            Composite.allBodies(world).forEach(body => {
                if (body.label === 'wall' || body.label === 'sword') {
                     Composite.remove(world, body);
                }
            });

            const wallThickness = 20;

            const walls = [
                // √úst, Alt, Sol, Saƒü
                Bodies.rectangle(arenaWidth / 2, wallThickness / 2, arenaWidth, wallThickness, { isStatic: true, label: 'wall', render: { fillStyle: '#333' } }),
                Bodies.rectangle(arenaWidth / 2, arenaHeight - wallThickness / 2, arenaWidth, wallThickness, { isStatic: true, label: 'wall', render: { fillStyle: '#333' } }),
                Bodies.rectangle(wallThickness / 2, arenaHeight / 2, wallThickness, arenaHeight, { isStatic: true, label: 'wall', render: { fillStyle: '#333' } }),
                Bodies.rectangle(arenaWidth - wallThickness / 2, arenaHeight / 2, wallThickness, arenaHeight, { isStatic: true, label: 'wall', render: { fillStyle: '#333' } })
            ];
            Composite.add(world, walls);
        }

        function initializeGame() {
            // Engine ve World olu≈üturma (Eƒüer yoksa)
            if (!engine) {
                engine = Engine.create();
                world = engine.world;
                world.gravity.y = 0;
                world.gravity.x = 0;
            } else {
                Engine.clear(engine);
                Composite.clear(world, false); // Sadece body'leri temizle
            }
            
            // Runner'ƒ± sƒ±fƒ±rla/olu≈ütur
            if (runner) Runner.stop(runner);
            runner = Runner.create();
            Runner.run(runner, engine);

            // Events silme/ekleme
            Events.off(engine, 'afterUpdate', afterUpdateHandler);
            Events.off(engine, 'collisionStart', collisionStartHandler);
            Events.on(engine, 'afterUpdate', afterUpdateHandler);
            Events.on(engine, 'collisionStart', collisionStartHandler);
            
            updateArenaSize();
            setupWalls(); // Yeni duvarlarƒ± olu≈ütur

            // Render olu≈üturma (Eƒüer yoksa)
            if (!render) {
                render = Render.create({
                    element: gameContainer,
                    engine: engine,
                    options: {
                        width: arenaWidth,
                        height: arenaHeight,
                        wireframes: false,
                        background: 'transparent',
                        showAngleIndicator: false
                    }
                });
                Render.run(render);
            }
            
            // Eski top ve e≈üyalarƒ± temizle
            ball1 = null; ball2 = null;
            currentItem = null;
            clearTimeout(itemSpawnTimer);
            itemEmojiDiv.style.display = 'none';

            // Oyuncu objelerini ve canlarƒ±nƒ± sƒ±fƒ±rla
            playerInfo.ball1.health = MAX_HEALTH;
            playerInfo.ball2.health = MAX_HEALTH;
            playerInfo.ball1.hasSword = false;
            playerInfo.ball2.hasSword = false;
            
            // Toplarƒ±n olu≈üturulmasƒ±
            const ballOptions = {
                restitution: 1, // M√ºkemmel sekme
                friction: 0, // S√ºrt√ºnme yok
                frictionAir: 0, // Hava direnci yok
                density: 0.1, // D√º≈ü√ºk yoƒüunluk
                inertia: Infinity, // D√∂nme ataleti yok
                label: 'ball', // Ortak etiket
                render: { fillStyle: 'transparent', strokeStyle: 'transparent' }
            };

            // Toplarƒ± olu≈ütur
            ball1 = Bodies.circle(
                arenaWidth / 3, 
                arenaHeight / 2, 
                INITIAL_BALL_RADIUS, 
                { 
                    ...ballOptions, 
                    label: 'ball1',
                    mass: 1,
                    inverseMass: 1
                }
            );

            ball2 = Bodies.circle(
                arenaWidth * 2 / 3, 
                arenaHeight / 2, 
                INITIAL_BALL_RADIUS, 
                { 
                    ...ballOptions, 
                    label: 'ball2',
                    mass: 1,
                    inverseMass: 1
                }
            );
            
            // Toplara rastgele ba≈ülangƒ±√ß hƒ±zlarƒ± ver (MAX_SPEED civarƒ±nda)
            const speed = CONFIG.maxSpeed;
            const angle1 = Math.random() * Math.PI * 2; 
            const angle2 = Math.PI + Math.random() * Math.PI; 
            
            Body.setVelocity(ball1, { 
                x: Math.cos(angle1) * speed, 
                y: Math.sin(angle1) * speed 
            });
            
            Body.setVelocity(ball2, { 
                x: Math.cos(angle2) * speed, 
                y: Math.sin(angle2) * speed 
            });

            // Toplarƒ± d√ºnyaya ekle
            Composite.add(world, [ball1, ball2]);
            isGameOver = false;

            // G√∂rsel ve Durum G√ºncellemeleri
            updateHealthBar(playerInfo.ball1, MAX_HEALTH);
            updateHealthBar(playerInfo.ball2, MAX_HEALTH);
            
            // CSS Fotoƒüraflarƒ±nƒ± Ayarla
            playerInfo.ball1.photoDiv.style.backgroundImage = playerInfo.ball1.texture ? `url(${playerInfo.ball1.texture})` : 'none';
            playerInfo.ball2.photoDiv.style.backgroundImage = playerInfo.ball2.texture ? `url(${playerInfo.ball2.texture})` : 'none';
            playerInfo.ball1.photoDiv.style.backgroundColor = playerInfo.ball1.texture ? 'transparent' : playerInfo.ball1.color;
            playerInfo.ball2.photoDiv.style.backgroundColor = playerInfo.ball2.texture ? 'transparent' : playerInfo.ball2.color;

            // E≈üya Sistemi
            setTimeout(spawnItem, 1000);
        }

        // Pencere boyutu deƒüi≈ütiƒüinde arenamƒ±zƒ±n boyutunu g√ºncelle
        const resizeObserver = new ResizeObserver(entries => {
            if (isGameOver) return; // Oyun bitmi≈üse konumlarƒ± g√ºncelleme
            
            const oldArenaWidth = arenaWidth;
            const oldArenaHeight = arenaHeight;
            
            updateArenaSize();
            
            // Eƒüer toplar varsa, oranlƒ± olarak konumlarƒ±nƒ± g√ºncelle
            if (ball1 && ball2 && oldArenaWidth > 0 && oldArenaHeight > 0) {
                const scaleX = arenaWidth / oldArenaWidth;
                const scaleY = arenaHeight / oldArenaHeight;
                
                Body.setPosition(ball1, {
                    x: ball1.position.x * scaleX,
                    y: ball1.position.y * scaleY
                });
                
                Body.setPosition(ball2, {
                    x: ball2.position.x * scaleX,
                    y: ball2.position.y * scaleY
                });
            }
        });
        resizeObserver.observe(gameContainer);


        // --- OYUN MANTIK FONKSƒ∞YONLARI ---

        function updateHealthBar(player, health) {
            const healthPercentage = (health / MAX_HEALTH) * 100;
            player.healthBar.style.width = `${healthPercentage}%`;
            
            player.nameDisplay.textContent = `${player.name} Can: ${health}/${MAX_HEALTH}`;

            if (healthPercentage <= 33) {
                player.healthBar.classList.add('low-health');
            } else {
                player.healthBar.classList.remove('low-health');
            }
        }

        function updatePhotoPosition(body, player) {
            if (body) {
                // CSS Div konumunu Matter.js topuna g√∂re ayarla
                const ballDiameter = INITIAL_BALL_RADIUS * 2;
                player.photoDiv.style.left = `${body.position.x - INITIAL_BALL_RADIUS}px`;
                player.photoDiv.style.top = `${body.position.y - INITIAL_BALL_RADIUS}px`;
                Body.setAngularVelocity(body, 0); // Toplarƒ±n d√∂nmesini engelle
                
                // Kƒ±lƒ±√ß ikonunu g√ºncelle
                if (player.hasSword) {
                    player.swordIcon.style.display = 'block';
                    // Hafif sallanma efekti
                    player.swordIcon.style.transform = `rotate(${Math.sin(engine.timing.timestamp * 0.005) * 15}deg)`;
                } else {
                    player.swordIcon.style.display = 'none';
                }
            }
        }

        function removeHitEffect(player, delay = 300) {
            setTimeout(() => {
                player.photoDiv.classList.remove('hit-effect');
            }, delay);
        }

        function endGame(winnerPlayer) {
            if (isGameOver) return;
            isGameOver = true;
            
            if (runner) Runner.stop(runner); // Oyunu durdur

            const winnerName = winnerPlayer.name;
            
            winnerText.textContent = `${winnerName} KAZANDI!`;
            
            // Kazananƒ±n g√∂rselini ayarla
            if (winnerPlayer.texture) {
                winnerEmoji.style.backgroundImage = `url(${winnerPlayer.texture})`;
                winnerEmoji.style.backgroundSize = 'cover';
                winnerEmoji.textContent = '';
                winnerEmoji.style.backgroundColor = 'transparent';
            } else {
                winnerEmoji.style.backgroundImage = 'none';
                winnerEmoji.style.backgroundColor = winnerPlayer.color;
                winnerEmoji.textContent = winnerPlayer.emoji;
            }
            winnerEmoji.style.display = 'flex'; // Gerekli CSS √∂zelliklerini ayarla
            winnerEmoji.style.justifyContent = 'center';
            winnerEmoji.style.alignItems = 'center';
            winnerEmoji.style.borderRadius = '50%';
            winnerEmoji.style.fontSize = '60px';


            gameOverModal.style.display = 'flex';
            
            if (currentItem) Composite.remove(world, currentItem);
            clearTimeout(itemSpawnTimer);
            itemEmojiDiv.style.display = 'none';
        }

        function spawnItem() {
            const currentItemType = 'sword';
            const emoji = '‚öîÔ∏è';

            // Duvarlardan ve toplardan yeterince uzakta rastgele konum
            const padding = CONFIG.ballRadius * 2;
            const x = Math.random() * (arenaWidth - 2 * padding) + padding;
            const y = Math.random() * (arenaHeight - 2 * padding) + padding;

            currentItem = Bodies.circle(x, y, CONFIG.itemSize / 2, { 
                isStatic: true, 
                render: { fillStyle: 'transparent' }, 
                label: currentItemType,
                collisionFilter: { group: 0 } 
            });

            Composite.add(world, currentItem);
            itemEmojiDiv.textContent = emoji;
            itemEmojiDiv.style.display = 'block';
            
            clearTimeout(itemSpawnTimer);
        }

        // **!!! √ñNEMLƒ∞ D√úZELTME: Toplarƒ±n Hƒ±z Kontrol√º ve Sƒ±nƒ±rda Kalmasƒ± !!!**
        const afterUpdateHandler = function() {
            if (isGameOver || !ball1 || !ball2) return; 

            if (currentItem) {
                itemEmojiDiv.style.left = `${currentItem.position.x}px`;
                itemEmojiDiv.style.top = `${currentItem.position.y}px`;
            }

            updatePhotoPosition(ball1, playerInfo.ball1);
            updatePhotoPosition(ball2, playerInfo.ball2);

            const checkBallBoundsAndSpeed = (ball) => {
                const wallThickness = 20;
                const halfBall = CONFIG.ballRadius;
                
                // 1. ARENA SINIR KONTROL√ú (Kaybolmayƒ± √∂nler)
                let newX = ball.position.x;
                let newY = ball.position.y;
                let velocity = { ...ball.velocity };

                // X Sƒ±nƒ±rlarƒ±
                if (newX < wallThickness + halfBall) {
                    newX = wallThickness + halfBall;
                    velocity.x = Math.abs(velocity.x); // Saƒüa sektir
                } else if (newX > arenaWidth - wallThickness - halfBall) {
                    newX = arenaWidth - wallThickness - halfBall;
                    velocity.x = -Math.abs(velocity.x); // Sola sektir
                }

                // Y Sƒ±nƒ±rlarƒ±
                if (newY < wallThickness + halfBall) {
                    newY = wallThickness + halfBall;
                    velocity.y = Math.abs(velocity.y); // A≈üaƒüƒ± sektir
                } else if (newY > arenaHeight - wallThickness - halfBall) {
                    newY = arenaHeight - wallThickness - halfBall;
                    velocity.y = -Math.abs(velocity.y); // Yukarƒ± sektir
                }
                
                // Eƒüer konum deƒüi≈ütiyse, Matter.js pozisyonunu ayarla
                if (newX !== ball.position.x || newY !== ball.position.y) {
                    Body.setPosition(ball, { x: newX, y: newY });
                }
                
                // 2. HIZ KONTROL√ú (Aynƒ± s√ºratte kalsƒ±n)
                const speed = Math.sqrt(velocity.x * velocity.x + velocity.y * velocity.y);
                
                // Eƒüer hƒ±z MAX_SPEED'den farklƒ±ysa d√ºzelt
                if (speed !== 0 && speed !== CONFIG.maxSpeed) {
                    const scaleFactor = CONFIG.maxSpeed / speed;
                    velocity.x *= scaleFactor;
                    velocity.y *= scaleFactor;
                }

                // Hƒ±zƒ± ayarla (Sƒ±nƒ±rda sektirme veya hƒ±z d√ºzeltmesi nedeniyle deƒüi≈ümi≈ü olabilir)
                Body.setVelocity(ball, velocity);
                
                Body.setAngularVelocity(ball, 0); // D√∂nmeyi engelle
            };

            checkBallBoundsAndSpeed(ball1);
            checkBallBoundsAndSpeed(ball2);
        };

        const collisionStartHandler = function(event) {
            if (isGameOver) return;

            const pairs = event.pairs;

            pairs.forEach(pair => {
                const labels = [pair.bodyA.label, pair.bodyB.label];
                const isItemCollision = labels.includes('sword');
                const isBallCollision = labels.includes('ball1') && labels.includes('ball2');

                // 1. √ñƒüe Alma Mantƒ±ƒüƒ±
                if (isItemCollision && (labels.includes('ball1') || labels.includes('ball2'))) {
                    const takerBall = pair.bodyA.label.startsWith('ball') ? pair.bodyA : pair.bodyB;
                    
                    playerInfo.ball1.hasSword = (takerBall === ball1);
                    playerInfo.ball2.hasSword = (takerBall === ball2);
                    
                    Composite.remove(world, currentItem);
                    itemEmojiDiv.style.display = 'none';
                    currentItem = null;
                    itemSpawnTimer = setTimeout(spawnItem, ITEM_RESPAWN_TIME);
                }

                // 2. Toplarƒ±n Birbirine √áarpƒ±≈ümasƒ± (Kƒ±lƒ±√ß hasarƒ±)
                if (isBallCollision) {
                    const p1 = playerInfo.ball1;
                    const p2 = playerInfo.ball2;

                    let damageDealt = false;
                    let damagedPlayer = null;
                    
                    if (p1.hasSword && !p2.hasSword) {
                        p2.health--;
                        p1.hasSword = false;
                        damageDealt = true;
                        damagedPlayer = p2;
                    } else if (p2.hasSword && !p1.hasSword) {
                        p1.health--;
                        p2.hasSword = false;
                        damageDealt = true;
                        damagedPlayer = p1;
                    } else if (p1.hasSword && p2.hasSword) {
                        // Kƒ±lƒ±√ßlar √ßarpƒ±≈üƒ±rsa ikisi de kaybolur
                        p1.hasSword = false;
                        p2.hasSword = false;
                        damageDealt = false;
                    }
                    
                    if (damageDealt) {
                        updateHealthBar(p1, p1.health);
                        updateHealthBar(p2, p2.health);
                        
                        damagedPlayer.photoDiv.classList.add('hit-effect');
                        removeHitEffect(damagedPlayer);

                        // Kƒ±lƒ±√ß √ßarpƒ±≈üma sonucu yok olduysa, e≈üya geri gelme s√ºresini kƒ±salt
                        if (!currentItem) {
                            itemSpawnTimer = setTimeout(spawnItem, ITEM_RESPAWN_TIME / 3);
                        }
                    }

                    // Oyun Sonu Kontrol√º
                    if (p1.health <= 0) {
                        endGame(playerInfo.ball2);
                    } else if (p2.health <= 0) {
                        endGame(playerInfo.ball1);
                    }
                }
            });
        };
        
        // --- OYUN BA≈ûLATMA VE Y√ñNETƒ∞M ---

        // Fotoƒüraf y√ºkleme i≈ülevi
        function setupPhotoUpload(playerId) {
            const input = document.getElementById(`${playerId}-file`);
            const preview = document.getElementById(`${playerId}-preview`);
            const player = playerInfo[playerId === 'p1' ? 'ball1' : 'ball2'];
            
            input.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const size = Math.min(img.width, img.height);
                        canvas.width = size;
                        canvas.height = size;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(
                            img, 
                            (img.width - size) / 2, 
                            (img.height - size) / 2, 
                            size, size, 
                            0, 0, 
                            size, size
                        );
                        
                        const dataUrl = canvas.toDataURL('image/png');
                        player.texture = dataUrl;
                        preview.style.backgroundImage = `url(${dataUrl})`;
                        preview.style.backgroundSize = 'cover';
                        
                        checkCanStartCustom();
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        // Oyun ba≈ülatma kontrol√º
        function checkCanStartCustom() {
            const p1Ready = p1NameInput.value.trim() !== '';
            const p2Ready = p2NameInput.value.trim() !== '';
            startGameCustomButton.disabled = !(p1Ready && p2Ready);
            return p1Ready && p2Ready;
        }

        // Oyunu sƒ±fƒ±rla ve yeni oyun ba≈ülat (Aynƒ± ayarlar)
        function resetGame() {
            // Oyun durumunu sƒ±fƒ±rla
            isGameOver = false;
            gameOverModal.style.display = 'none';
            
            // Oyunu ba≈ülat
            initializeGame();
        }

        function startGameCustom() {
            if (!checkCanStartCustom()) return;

            // Oyuncu isimlerini g√ºncelle
            playerInfo.ball1.name = p1NameInput.value.trim() || 'Oyuncu 1';
            playerInfo.ball2.name = p2NameInput.value.trim() || 'Oyuncu 2';
            
            // Modalƒ± kapat
            setupModal.style.display = 'none';
            
            // Oyunu yeni ayarlar ile ba≈ülat
            initializeGame();
        }

        // Event listener'larƒ± kur
        function setupEventListeners() {
            // Fotoƒüraf y√ºkleme
            setupPhotoUpload('p1');
            setupPhotoUpload('p2');
            
            // ƒ∞sim deƒüi≈üikliklerini dinle
            p1NameInput.addEventListener('input', checkCanStartCustom);
            p2NameInput.addEventListener('input', checkCanStartCustom);
            
            // Oyun Kontrolleri
            startGameCustomButton.addEventListener('click', startGameCustom);
            customizeButton.addEventListener('click', () => {
                if (runner) Runner.stop(runner);
                setupModal.style.display = 'flex';
            });
            
            // Oyun sonu butonlarƒ±
            restartButton.addEventListener('click', resetGame);
            newGameButton.addEventListener('click', () => {
                gameOverModal.style.display = 'none';
                setupModal.style.display = 'flex';
            });
        }
        
        // Sayfa y√ºklendiƒüinde √ßalƒ±≈ütƒ±r
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
            updateArenaSize(); 
            // ƒ∞lk a√ßƒ±lƒ±≈üta Setup Modal'ƒ± g√∂ster
        });
    </script>
</body>
</html>
