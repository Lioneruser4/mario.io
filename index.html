<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Professional Online Dama (Checkers) Oyunu</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.js"></script>
    <style>
        :root {
            --board-size: 8;
            --cell-size: 70px; /* Daha bÃ¼yÃ¼k tahta */
            --black-cell: #4e342e; /* Koyu kahverengi */
            --white-cell: #ffecb3; /* AÃ§Ä±k krem */
            --highlight-color: #4caf50; /* YeÅŸil (GeÃ§erli hamle) */
            --turn-light-color: #ffeb3b; /* SarÄ± (SÄ±ra Ä±ÅŸÄ±ÄŸÄ±) */
            --player-1-color: #e53935; /* KÄ±rmÄ±zÄ± */
            --player-2-color: #455a64; /* Koyu Gri */
        }

        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #212121;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
        }

        h1 { color: white; margin-bottom: 5px; }

        #controls {
            margin: 20px 0;
            display: flex;
            gap: 15px;
        }

        button {
            padding: 12px 25px;
            font-size: 1.1em;
            cursor: pointer;
            border: none;
            border-radius: 8px;
            color: #212121;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        #rank-match { background-color: #fdd835; }
        #rank-match:hover { background-color: #fbc02d; transform: translateY(-2px); }
        #create-lobby, #join-lobby { background-color: #7cb342; }
        #create-lobby:hover, #join-lobby:hover { background-color: #689f38; transform: translateY(-2px); }


        #game-info {
            color: #fff;
            margin-bottom: 20px;
            font-size: 1.4em;
            padding: 10px 20px;
            background-color: #333;
            border-radius: 8px;
        }

        #board {
            display: grid;
            grid-template-columns: repeat(var(--board-size), var(--cell-size));
            grid-template-rows: repeat(var(--board-size), var(--cell-size));
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.7);
            border: 6px solid #8d6e63;
        }

        .cell {
            width: var(--cell-size);
            height: var(--cell-size);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
        }

        .light { background-color: var(--white-cell); }
        .dark { background-color: var(--black-cell); }

        /* TaÅŸlar */
        .piece {
            width: 85%;
            height: 85%;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.6);
            border: 2px solid rgba(255, 255, 255, 0.4);
            cursor: grab;
            z-index: 5;
            transition: all 0.3s ease-out; /* Animasyon: TaÅŸÄ±ma ve Kral olma */
        }

        .player-1 { background-color: var(--player-1-color); }
        .player-2 { background-color: var(--player-2-color); }

        .king {
            font-size: 24px;
            color: var(--turn-light-color);
            text-shadow: 0 0 5px black;
            border: 3px solid var(--turn-light-color);
        }

        /* SeÃ§ilen TaÅŸ Vurgusu */
        .selected-piece {
            transform: scale(1.1) translateY(-5px);
            box-shadow: 0 0 20px 5px var(--highlight-color);
            cursor: grabbing;
        }

        /* GeÃ§erli Hamle Hedefi (Renkli GÃ¶sterim) */
        .valid-move {
            position: relative;
        }
        .valid-move::after {
            content: '';
            position: absolute;
            width: 40%;
            height: 40%;
            border-radius: 50%;
            background-color: var(--highlight-color);
            opacity: 0.8;
            border: 2px solid white;
            z-index: 10;
        }

        /* SÄ±ra GÃ¶stergesi (IÅŸÄ±klÄ± BÃ¶lge) */
        .is-turn {
            box-shadow: inset 0 0 10px 2px var(--turn-light-color);
        }

        .player-turn-light {
             /* Oyuncu 1 ise alt 3 sÄ±ra, Oyuncu 2 ise Ã¼st 3 sÄ±ra iÃ§in Ä±ÅŸÄ±k efekti */
            box-shadow: 0 0 15px var(--turn-light-color);
            border: 1px solid var(--turn-light-color);
        }

    </style>
</head>
<body>
    <h1>Professional Dama Online</h1>

    <div id="controls">
        <button id="create-lobby">Lobi Kur</button>
        <button id="join-lobby">Odaya BaÄŸlan</button>
        <button id="rank-match">ðŸ‘‘ Dereceli Oyna</button>
    </div>

    <div id="game-info">
        <span id="connection-status">BaÄŸlanÄ±yor...</span> | SÄ±ra: <span id="current-player-text">Bekleniyor...</span>
    </div>

    <div id="board">
        </div>

    <script>
        // *** CONFIGURATION ***
        const SERVER_URL = 'https://mario-io-1.onrender.com';
        const socket = io(SERVER_URL);
        const boardSize = 8;
        
        // *** DOM ELEMENTS ***
        const board = document.getElementById('board');
        const currentPlayerText = document.getElementById('current-player-text');
        const connectionStatus = document.getElementById('connection-status');

        // *** GAME STATE ***
        let selectedPiece = null;
        let currentPlayer = 1; // 1: KÄ±rmÄ±zÄ± (Alt), 2: Gri (Ãœst)
        let playerRole = 0; // 1 veya 2 (Bu istemcide oynayan oyuncu)
        let lobbyId = null;
        let isMyTurn = false;
        
        // Tahta baÅŸlangÄ±Ã§ durumu
        let gameState = [
            [0, 2, 0, 2, 0, 2, 0, 2], // 2 = Oyuncu 2
            [2, 0, 2, 0, 2, 0, 2, 0],
            [0, 2, 0, 2, 0, 2, 0, 2],
            [0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0],
            [1, 0, 1, 0, 1, 0, 1, 0], // 1 = Oyuncu 1
            [0, 1, 0, 1, 0, 1, 0, 1],
            [1, 0, 1, 0, 1, 0, 1, 0]
        ];
        
        // **********************************
        // *** SOCKET.IO Ä°LETÄ°ÅžÄ°M KISMI ***
        // **********************************

        socket.on('connect', () => {
            connectionStatus.textContent = `Online (${socket.id})`;
            connectionStatus.style.color = '#76ff03';
        });

        socket.on('disconnect', () => {
            connectionStatus.textContent = 'BaÄŸlantÄ± Kesildi!';
            connectionStatus.style.color = '#ff1744';
        });
        
        // Lobi kuruldu
        socket.on('lobby_created', (data) => {
            lobbyId = data.lobbyId;
            playerRole = data.playerRole;
            alert(`Lobi Kuruldu! Kod: ${lobbyId}. LÃ¼tfen rakibinizle paylaÅŸÄ±n. Siz Oyuncu ${playerRole} (KÄ±rmÄ±zÄ±)`);
            updateGameInfo();
        });

        // Lobiye katÄ±l
        socket.on('lobby_joined', (data) => {
            lobbyId = data.lobbyId;
            playerRole = data.playerRole;
            alert(`Odaya KatÄ±ldÄ±nÄ±z! Kod: ${lobbyId}. Siz Oyuncu ${playerRole} (Gri)`);
            updateGameInfo();
        });
        
        // BaÅŸka oyuncu katÄ±ldÄ± veya eÅŸleÅŸme bulundu
        socket.on('game_start', (initialState) => {
            // initial state server'dan gelmelidir, ancak ÅŸimdilik local state'i kullanÄ±yoruz.
            // gameState = initialState; 
            isMyTurn = (playerRole === 1);
            if (isMyTurn) alert("Oyun BaÅŸladÄ±! SÄ±ra Sizde (KÄ±rmÄ±zÄ±)!");
            else alert("Oyun BaÅŸladÄ±! Rakibiniz Oynuyor (Gri)!");
            createBoard(gameState);
            updateTurnLight();
        });

        // Dereceli eÅŸleÅŸme bulundu
        socket.on('rank_match_start', (data) => {
            lobbyId = data.lobbyId;
            playerRole = data.playerRole;
            // gameState = data.gameState; // Sunucudan gelen oyun durumu
            isMyTurn = (playerRole === 1);
            alert(`ðŸ‘‘ Dereceli EÅŸleÅŸme Bulundu! ${lobbyId}. Siz Oyuncu ${playerRole}!`);
            createBoard(gameState);
            updateTurnLight();
        });
        
        socket.on('waiting_for_opponent', (message) => {
            alert(message);
        });

        // Rakip Hamle YaptÄ±
        socket.on('opponent_moved', (move) => {
            console.log('Rakip hamle yaptÄ±:', move);
            // Sunucudan gelen hamleyi uygulamak iÃ§in animasyonlu bir fonksiyon Ã§aÄŸrÄ±lmalÄ±.
            applyMoveAndAnimate(move.from.r, move.from.c, move.to.r, move.to.c, true);
            isMyTurn = true; // Rakip oynadÄ±ÄŸÄ± iÃ§in sÄ±ra size geÃ§ti
            currentPlayer = (currentPlayer === 1) ? 2 : 1;
            updateTurnLight();
        });
        
        socket.on('error', (message) => {
            alert("Hata: " + message);
        });

        // **********************************
        // *** OYUN MANTIK KISMI ***
        // **********************************

        function createBoard() {
            board.innerHTML = '';
            for (let r = 0; r < boardSize; r++) {
                for (let c = 0; c < boardSize; c++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell ' + (((r + c) % 2 === 0) ? 'light' : 'dark');
                    cell.dataset.row = r;
                    cell.dataset.col = c;
                    cell.addEventListener('click', handleCellClick);

                    placePiece(cell, gameState[r][c]);
                    board.appendChild(cell);
                }
            }
            updateTurnLight();
        }

        function placePiece(cell, pieceOwner) {
            cell.innerHTML = ''; // Ã–nceki taÅŸÄ± kaldÄ±r
            if (pieceOwner > 0) {
                const piece = document.createElement('div');
                piece.className = `piece player-${pieceOwner}`;
                piece.dataset.owner = pieceOwner;
                if (pieceOwner === 3 || pieceOwner === 4) piece.classList.add('king'); // Kral taÅŸlar (3 ve 4)
                piece.textContent = piece.classList.contains('king') ? 'â™”' : ''; 
                cell.appendChild(piece);
            }
        }
        
        // Sadece basit Ã§apraz 1 adÄ±m hamlesini kontrol eder (Vurma kurallarÄ± eksik)
        function getValidMoves(r, c, pieceOwner, isKing) {
            const moves = [];
            // Oyuncu 1 ise yukarÄ± (-1), Oyuncu 2 ise aÅŸaÄŸÄ± (+1)
            const directions = (pieceOwner === 1) ? [-1] : [1]; 
            if (isKing) directions.push(1, -1); // Kral her iki yÃ¶ne de gider

            for (const direction of directions) {
                const nextRow = r + direction;
                if (nextRow >= 0 && nextRow < boardSize) {
                    // Sol Ã§apraz
                    if (c - 1 >= 0 && gameState[nextRow][c - 1] === 0) {
                        moves.push({ row: nextRow, col: c - 1 });
                    }
                    // SaÄŸ Ã§apraz
                    if (c + 1 < boardSize && gameState[nextRow][c + 1] === 0) {
                        moves.push({ row: nextRow, col: c + 1 });
                    }
                }
            }
            // *** BURAYA ZORUNLU VURMA KURALLARI EKLENMELÄ°DÄ°R! ***
            return moves;
        }

        function clearHighlights() {
            document.querySelectorAll('.selected-piece').forEach(p => p.classList.remove('selected-piece'));
            document.querySelectorAll('.valid-move').forEach(cell => cell.classList.remove('valid-move'));
        }
        
        function updateGameInfo() {
             currentPlayerText.textContent = lobbyId 
                ? `Oyuncu ${currentPlayer} (Siz: ${playerRole})` 
                : `Oyuncu ${currentPlayer}`;
        }
        
        function updateTurnLight() {
            document.querySelectorAll('.cell').forEach(cell => {
                cell.classList.remove('player-turn-light');
            });
            
            // SÄ±ra kimdeyse, o oyuncunun tarafÄ±ndaki hÃ¼creleri Ä±ÅŸÄ±klandÄ±r
            const targetCells = (currentPlayer === 1) 
                ? Array.from(document.querySelectorAll('.cell[data-row="5"], .cell[data-row="6"], .cell[data-row="7"]'))
                : Array.from(document.querySelectorAll('.cell[data-row="0"], .cell[data-row="1"], .cell[data-row="2"]'));
            
            targetCells.forEach(cell => {
                cell.classList.add('is-turn');
                // Sadece koyu hÃ¼creleri Ä±ÅŸÄ±klandÄ±r (opsiyonel)
                if (cell.classList.contains('dark')) {
                     cell.classList.add('player-turn-light');
                }
            });
            
            updateGameInfo();
        }


        // Animasyonlu Hamle Uygula
        function applyMoveAndAnimate(fromR, fromC, toR, toC, isOpponent = false) {
            const oldCell = board.querySelector(`[data-row="${fromR}"][data-col="${fromC}"]`);
            const newCell = board.querySelector(`[data-row="${toR}"][data-col="${toC}"]`);
            const movingPiece = oldCell.querySelector('.piece');
            
            if (!movingPiece) return;

            // 1. Oyun Durumunu GÃ¼ncelle
            const pieceOwner = gameState[fromR][fromC];
            gameState[toR][toC] = pieceOwner;
            gameState[fromR][fromC] = 0;

            // 2. DOM TaÅŸÄ±ma Animasyonu (TaÅŸÄ±n kayÄ±yormuÅŸ gibi gÃ¶rÃ¼nmesi iÃ§in)
            // NOT: DOM taÅŸÄ±mada animasyon yapmak zordur. Burada basitÃ§e taÅŸÄ± eski hÃ¼creden kaldÄ±rÄ±p yenisine koyuyoruz.
            // CSS transition'Ä± bu transfer sÄ±rasÄ±nda gÃ¶rsel bir efekt yaratacaktÄ±r.
            
            oldCell.removeChild(movingPiece);
            newCell.appendChild(movingPiece);
            
            // Kral yapma kontrolÃ¼ (Basit Dama KuralÄ±)
            if (toR === 0 && pieceOwner === 1) { // P1 en Ã¼ste ulaÅŸtÄ±
                movingPiece.classList.add('king');
                movingPiece.textContent = 'â™”';
                gameState[toR][toC] = 3; // P1 King
            } else if (toR === 7 && pieceOwner === 2) { // P2 en alta ulaÅŸtÄ±
                movingPiece.classList.add('king');
                movingPiece.textContent = 'â™”';
                gameState[toR][toC] = 4; // P2 King
            }

            // EÄŸer bir taÅŸ yendiyse, o taÅŸÄ± tahtadan kaldÄ±r (Vurma mantÄ±ÄŸÄ± buraya eklenmeli)
            // ...

            // SÄ±rayÄ± deÄŸiÅŸtir
            if (!isOpponent) {
                currentPlayer = (currentPlayer === 1) ? 2 : 1;
                isMyTurn = false; // Hamleniz bitti
            }
        }
        
        
        // **********************************
        // *** EVENT HANDLERS ***
        // **********************************

        function handleCellClick(event) {
            if (!isMyTurn || !lobbyId) {
                if(lobbyId) alert("SÄ±ra sizde deÄŸil!");
                else alert("Ã–nce bir oyuna (lobi veya dereceli) katÄ±lÄ±n!");
                return;
            }

            const cell = event.currentTarget;
            const r = parseInt(cell.dataset.row);
            const c = parseInt(cell.dataset.col);
            const piece = cell.querySelector('.piece');

            clearHighlights(); 

            // 1. TaÅŸ SeÃ§me (SeÃ§ilen taÅŸ sÄ±radaki oyuncu ve aynÄ± zamanda bu istemcideki oyuncu ise)
            if (piece && parseInt(piece.dataset.owner) === currentPlayer && parseInt(piece.dataset.owner) === playerRole) {
                selectedPiece = { r, c, piece: piece };
                piece.classList.add('selected-piece'); 

                // GeÃ§erli hamleleri gÃ¶ster
                const isKing = piece.classList.contains('king');
                const moves = getValidMoves(r, c, currentPlayer, isKing); 
                
                moves.forEach(move => {
                    const targetCell = board.querySelector(`[data-row="${move.row}"][data-col="${move.col}"]`);
                    targetCell.classList.add('valid-move');
                });
            }
            // 2. Hamle Yapma (Ã–nceden bir taÅŸ seÃ§ilmiÅŸse ve hedef geÃ§erli bir hamleyse)
            else if (selectedPiece && cell.classList.contains('valid-move')) {
                const fromR = selectedPiece.r;
                const fromC = selectedPiece.c;
                const toR = r;
                const toC = c;
                
                // Hamleyi sunucuya gÃ¶nder
                socket.emit('make_move', { 
                    lobbyId: lobbyId, 
                    move: { from: {r: fromR, c: fromC}, to: {r: toR, c: toC} }
                });

                // Kendi tahtanÄ±zda hamleyi uygulayÄ±n ve animasyonu baÅŸlatÄ±n
                applyMoveAndAnimate(fromR, fromC, toR, toC, false);
                
                selectedPiece = null;
                clearHighlights(); // Hamle sonrasÄ± temizle
                updateTurnLight();
            }
            // 3. GeÃ§ersiz TÄ±klama
            else {
                selectedPiece = null;
            }
        }
        
        // **********************************
        // *** BUTONLAR ***
        // **********************************

        document.getElementById('create-lobby').addEventListener('click', () => {
            if (lobbyId) {
                alert("Zaten bir oyuna katÄ±lmÄ±ÅŸsÄ±nÄ±z!");
                return;
            }
            const username = prompt("LÃ¼tfen kullanÄ±cÄ± adÄ±nÄ±zÄ± girin:");
            if (username && socket.connected) {
                socket.emit('create_lobby', username);
            } else if (!socket.connected) {
                alert("Sunucuya baÄŸlÄ± deÄŸilsiniz. LÃ¼tfen tekrar deneyin.");
            }
        });

        document.getElementById('join-lobby').addEventListener('click', () => {
            if (lobbyId) {
                 alert("Zaten bir oyuna katÄ±lmÄ±ÅŸsÄ±nÄ±z!");
                return;
            }
            const lobbyCode = prompt("LÃ¼tfen katÄ±lmak istediÄŸiniz oda kodunu girin:");
            const username = prompt("LÃ¼tfen kullanÄ±cÄ± adÄ±nÄ±zÄ± girin:");
            if (lobbyCode && username && socket.connected) {
                socket.emit('join_lobby', { lobbyId: lobbyCode, username: username });
            } else if (!socket.connected) {
                alert("Sunucuya baÄŸlÄ± deÄŸilsiniz. LÃ¼tfen tekrar deneyin.");
            }
        });

        document.getElementById('rank-match').addEventListener('click', () => {
             if (lobbyId) {
                 alert("Zaten bir oyuna katÄ±lmÄ±ÅŸsÄ±nÄ±z!");
                return;
            }
            const username = prompt("LÃ¼tfen kullanÄ±cÄ± adÄ±nÄ±zÄ± girin:");
            if (username && socket.connected) {
                alert("Dereceli eÅŸleÅŸme aranÄ±yor... LÃ¼tfen bekleyiniz.");
                socket.emit('start_rank_match', username);
            } else if (!socket.connected) {
                alert("Sunucuya baÄŸlÄ± deÄŸilsiniz. LÃ¼tfen tekrar deneyin.");
            }
        });


        // Oyunu baÅŸlat
        createBoard();
    </script>
</body>
</html>
