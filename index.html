<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Professional Dama | Tam Versiya</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        /* --- ∆èsas Still…ôr --- */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        
        body { font-family: 'Inter', sans-serif; }
        
        .board {
            display: grid;
            grid-template-columns: repeat(8, min(12vw, 60px));
            grid-template-rows: repeat(8, min(12vw, 60px));
            border: 8px solid #334155; 
            box-shadow: 0 15px 25px rgba(0, 0, 0, 0.7);
            border-radius: 12px;
            overflow: hidden;
            touch-action: manipulation;
            margin: 0 auto;
        }
        .cell {
            width: min(12vw, 60px);
            height: min(12vw, 60px);
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.2s;
            cursor: pointer;
        }
        
        /* --- Da≈ü Still…ôri --- */
        .piece {
            width: 85%;
            height: 85%;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: min(4.5vw, 1.8rem);
            font-weight: 900;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
            border: 3px solid;
            cursor: pointer;
            user-select: none;
            transition: transform 0.1s, box-shadow 0.3s;
        }
        .piece-white { background-color: #f3f4f6; color: #1f2937; border-color: #9ca3af; }
        .piece-black { background-color: #1f2937; color: #f3f4f6; border-color: #4b5563; }
        
        /* Dama (King) effekti */
        @keyframes king-glow {
            0%, 100% { text-shadow: 0 0 10px #fde047, 0 0 5px #000; }
            50% { text-shadow: 0 0 20px #fde047, 0 0 10px #000; }
        }
        .piece-king { animation: king-glow 1.5s ease-in-out infinite alternate; }
        .piece-king-white { background: linear-gradient(135deg, #fde047, #fef08a); color: #1f2937; }
        .piece-king-black { background: linear-gradient(135deg, #374151, #4b5563); color: #fde047; }
        
        /* --- Vurƒüulama Effekl…ôri --- */
        .selected { border: 4px solid #ef4444; transform: scale(1.05); } 
        .possible-move { background-color: #10b981 !important; cursor: pointer; } 
        .possible-move:hover { background-color: #059669 !important; }
        
        /* M…ôcburi Yem…ô Da≈üƒ±nƒ±n ƒ∞≈üƒ±qlƒ± Animasiyasƒ± */
        @keyframes mandatory-pulse {
            0%, 100% { box-shadow: 0 0 15px #f97316; }
            50% { box-shadow: 0 0 25px #f97316; }
        }
        .mandatory-jump { 
            border: 4px solid #f97316; 
            animation: mandatory-pulse 0.8s infinite alternate; 
        } 

        @keyframes pulse-fast {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-pulse-fast { animation: pulse-fast 0.5s infinite alternate; }
        .title-glow { text-shadow: 0 0 10px #3b82f6, 0 0 20px #3b82f6; } 
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { 'primary-dark': '#0f172a', 'secondary-dark': '#1e293b', 'accent': '#3b82f6' },
                }
            }
        }
    </script>
</head>
<body class="bg-primary-dark text-white font-['Inter'] min-h-screen flex flex-col items-center justify-center p-4">

    <header class="text-center mb-6 w-full max-w-4xl">
        <h1 class="text-4xl font-black title-glow text-accent mb-2">PROFESSƒ∞ONAL DAMA OYUNU</h1>
        <div id="user-info-display" class="text-xs text-gray-400">
            <span id="user-name-display">ƒ∞stifad…ô√ßi: Y√ºkl…ônir...</span> |
            <span id="current-user-id-display">ID: ...</span>
        </div>
        <div id="connection-status" class="text-sm font-semibold mt-2 text-red-500 animate-pulse-fast">Server…ô qo≈üulur...</div>
    </header>

    <div id="message-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden flex items-center justify-center z-50">
        <div class="bg-secondary-dark p-8 rounded-xl shadow-2xl max-w-sm w-full text-center border-t-4 border-accent">
            <p id="modal-message" class="text-lg font-semibold mb-4 text-white"></p>
            <button id="modal-close-btn" class="w-full bg-accent hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Baƒüla</button>
        </div>
    </div>

    <div id="loader" class="flex flex-col items-center justify-center h-48">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-accent"></div>
        <p class="mt-4 text-lg text-gray-400">Y√ºkl…ônir...</p>
    </div>

    <div id="lobby-screen" class="hidden w-full max-w-md bg-secondary-dark p-6 rounded-xl shadow-2xl">
        <h2 class="text-2xl font-bold text-center text-white mb-4">Oyun Lobisi</h2>
        <p id="lobi-status-message" class="text-center text-sm mb-6 text-gray-300">Oyun rejimi se√ßin.</p>

        <div class="space-y-4">
            <button id="dereceli-btn" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-extrabold py-3 rounded-xl transition duration-300 shadow-lg">
                üèÜ Reytinqli Oyna (Axtar)
            </button>
            <button id="deregeli-cancel-btn" class="hidden w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 rounded-xl transition duration-300">
                Axtarƒ±≈üƒ± L…ôƒüv Et
            </button>
            <div class="relative flex items-center py-2"> <div class="flex-grow border-t border-gray-600"></div> <span class="flex-shrink mx-4 text-gray-500">V∆è YA</span> <div class="flex-grow border-t border-gray-600"></div> </div>
            <button id="create-room-btn" class="w-full bg-accent hover:bg-blue-700 text-white font-bold py-3 rounded-xl transition duration-300">
                ‚ûï Dostla Oyna (Otaq Yarat)
            </button>
            <div class="text-center text-sm text-gray-400">
                Otaq Kodu: <span id="room-code-output" class="font-mono text-xl text-yellow-400">....</span>
                <button id="copy-code-btn" class="ml-2 text-green-400 hover:text-green-300 text-xs">Kopyala</button>
            </div>
            <div class="flex space-x-2 pt-2">
                <input type="text" id="join-room-input" placeholder="Otaq kodu (4 r…ôq…ôm)" maxlength="4" class="flex-grow p-3 rounded-xl bg-gray-700 text-white placeholder-gray-400 border border-gray-600 focus:border-accent focus:ring-1 focus:ring-accent outline-none">
                <button id="join-room-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-xl transition duration-300">
                    Qo≈üul
                </button>
            </div>
        </div>
    </div>

    <main id="game-screen" class="hidden w-full max-w-4xl flex flex-col items-center justify-center p-4">
        
        <div class="flex flex-col md:flex-row items-start justify-center w-full space-y-6 md:space-y-0 md:space-x-8">
            
            <div class="flex flex-col items-center space-y-4 order-1 md:order-1 w-full max-w-xs">
                <div class="w-full bg-secondary-dark p-3 rounded-xl shadow-lg border-b-4 border-gray-400">
                    <p class="text-sm text-gray-400 font-semibold mb-1">R…ôqib (Aƒü)</p>
                    <div class="flex justify-between items-center">
                        <p id="opponent-name-display" class="font-bold text-lg text-gray-200">G√∂zl…ônilir...</p>
                        <p id="white-timer" class="p-2 rounded-lg font-mono text-2xl text-white shadow-md bg-gray-700 min-w-[80px] text-center">20s</p>
                    </div>
                </div>
            </div>

            <div id="board-container" class="order-2 md:order-2">
                <div id="board" class="board bg-gray-700">
                    </div>
            </div>

            <div class="flex flex-col items-center space-y-4 order-3 w-full max-w-xs">
                
                <div id="current-turn-display" class="text-lg font-bold p-3 rounded-xl bg-yellow-600 text-white shadow-xl transition duration-300 w-full text-center animate-pulse">
                    Y√ºkl…ônir...
                </div>

                <div id="action-info" class="text-sm text-center text-blue-300 p-2 rounded-lg bg-gray-700 w-full">
                    Da≈üƒ±nƒ±zƒ± se√ßin v…ô h…ôr…ôk…ôt etm…ôk ist…ôdiyiniz xanaya klikl…ôyin.
                </div>

                <div class="w-full bg-secondary-dark p-3 rounded-xl shadow-lg border-b-4 border-black">
                    <p class="text-sm text-gray-400 font-semibold mb-1">Siz (Qara)</p>
                    <div class="flex justify-between items-center">
                        <p id="my-name-display" class="font-bold text-lg text-gray-200">Siz</p>
                        <p id="black-timer" class="p-2 rounded-lg font-mono text-2xl text-white shadow-md bg-gray-700 min-w-[80px] text-center">20s</p>
                    </div>
                </div>
                
                <button id="leave-game-btn" class="w-full bg-red-700 hover:bg-red-800 text-white font-bold py-2 rounded-xl transition duration-300 mt-4 shadow-xl">
                    Oyunu T…ôrk Et (Uduz)
                </button>
            </div>
        </div>
        
    </main>

    <script>
        // --- 1. Sabitl…ôr v…ô Global D…ôyi≈ü…ônl…ôr ---
        
        // SERVER URL: ∆èmin olun ki, bu √ºnvan d√ºzg√ºn Socket.IO serverini i≈ül…ôdir.
        const SERVER_URL = "https://mario-io-1.onrender.com"; 

        const BOARD_SIZE = 8;
        
        let socket;
        let currentUserId = null;
        let currentUserName = null;
        let currentRoomId = null;
        let isMyTurn = false;
        let myColor = null; 
        
        let boardState = null;
        let selectedPiece = null; 
        let mandatoryCapture = null; 
        let possibleMoves = []; 
        let timerInterval = null;

        // --- 2. Yardƒ±m√ßƒ± Funksiyalar (UX) ---

        function getTelegramUser() {
            const urlParams = new URLSearchParams(window.location.search);
            const tgUserId = urlParams.get('tg_user_id') || urlParams.get('id');
            const tgUsername = urlParams.get('tg_username') || urlParams.get('name');

            return {
                id: tgUserId || 'anon_' + Math.random().toString(36).substring(2, 9),
                name: tgUsername ? decodeURIComponent(tgUsername).replace(/<\/?script>/ig, "") : 'Anonim ƒ∞stifad…ô√ßi',
            };
        }

        function showModal(message, callback = null) {
            document.getElementById('modal-message').textContent = message;
            document.getElementById('message-modal').classList.remove('hidden');
            document.getElementById('modal-close-btn').onclick = () => {
                document.getElementById('message-modal').classList.add('hidden');
                if (callback) callback();
            };
        }

        function showScreen(screen) {
            document.getElementById('loader').classList.add('hidden');
            document.getElementById('lobby-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('deregeli-cancel-btn').classList.add('hidden');
            document.getElementById('dereceli-btn').classList.remove('hidden');
            
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = null;

            if (screen === 'lobby') {
                document.getElementById('lobby-screen').classList.remove('hidden');
                document.getElementById('lobi-status-message').textContent = 'Oyun rejimi se√ßin.';
                document.getElementById('room-code-output').textContent = '....';
                currentRoomId = null;
                selectedPiece = null;
            } else if (screen === 'game') {
                document.getElementById('game-screen').classList.remove('hidden');
            } else if (screen === 'searching') {
                document.getElementById('lobby-screen').classList.remove('hidden');
                document.getElementById('deregeli-cancel-btn').classList.remove('hidden');
                document.getElementById('dereceli-btn').classList.add('hidden');
                document.getElementById('lobi-status-message').textContent = 'üèÜ Reytinqli R…ôqib axtarƒ±lƒ±r... L√ºtf…ôn g√∂zl…ôyin.';
            } else {
                document.getElementById('loader').classList.remove('hidden');
            }
        }

        function formatTime(seconds) { return `${Math.max(0, seconds)}s`; }
        function getPiecePlayer(pieceValue) {
            if (pieceValue === 1 || pieceValue === 3) return 'white';
            if (pieceValue === 2 || pieceValue === 4) return 'black';
            return null;
        }
        function getPieceSymbol(pieceValue) {
            if (pieceValue === 1 || pieceValue === 2) return '‚óè';
            if (pieceValue === 3 || pieceValue === 4) return '‚ôõ'; 
            return '';
        }
        function isValidCell(r, c) { return r >= 0 && r < BOARD_SIZE && c >= 0 && c < BOARD_SIZE; }

        // --- 3. Dama M…ôntiqi (Client-side yoxlamalar) ---
        
        function findJumps(board, r, c, player) {
            const pieceValue = board[r][c];
            const isKingPiece = pieceValue === 3 || pieceValue === 4;
            const jumps = [];
            const directions = [[-1, -1], [-1, 1], [1, -1], [1, 1]];

            for (const [dr, dc] of directions) {
                if (isKingPiece) {
                    let capturedR = -1, capturedC = -1;
                    
                    for (let i = 1; i < BOARD_SIZE; i++) {
                        const curR = r + i * dr;
                        const curC = c + i * dc;
                        
                        if (!isValidCell(curR, curC)) break;

                        const cellValue = board[curR][curC];
                        const cellPlayer = getPiecePlayer(cellValue);
                        
                        if (cellPlayer === player) break; 

                        if (cellPlayer !== null && cellPlayer !== player) {
                            if (capturedR === -1) {
                                capturedR = curR;
                                capturedC = curC;
                            } else {
                                break;
                            }
                        }

                        if (capturedR !== -1 && cellValue === 0) {
                            jumps.push({ 
                                from: { r, c }, 
                                to: { r: curR, c: curC }, 
                                captured: { r: capturedR, c: capturedC } 
                            });
                        }
                    }
                } else {
                    const capturedR = r + dr;
                    const capturedC = c + dc;
                    const landR = r + 2 * dr;
                    const landC = c + 2 * dc;

                    if (isValidCell(landR, landC) && board[landR][landC] === 0) {
                        const capturedPieceValue = board[capturedR]?.[capturedC];
                        const capturedPlayer = getPiecePlayer(capturedPieceValue);

                        if (capturedPlayer && capturedPlayer !== player) {
                            jumps.push({ 
                                from: { r, c }, 
                                to: { r: landR, c: landC }, 
                                captured: { r: capturedR, c: capturedC } 
                            });
                        }
                    }
                }
            }
            return jumps;
        }
        
        function findLongestJumpChain(board, r, c, player, currentLength) {
            const possibleNextJumps = findJumps(board, r, c, player);
            let maxChain = currentLength;

            for (const jump of possibleNextJumps) {
                const nextBoard = makeTempMove(board, r, c, jump.to.r, jump.to.c, jump.captured.r, jump.captured.c);
                
                const chainLengthFromHere = findLongestJumpChain(
                    nextBoard,
                    jump.to.r,
                    jump.to.c,
                    player,
                    currentLength + 1
                );

                if (chainLengthFromHere > maxChain) {
                    maxChain = chainLengthFromHere;
                }
            }
            return maxChain;
        }

        function getMaxJumpChainLength(board, player) {
            let maxLength = 0;
            for (let r = 0; r < BOARD_SIZE; r++) {
                for (let c = 0; c < BOARD_SIZE; c++) {
                    if (getPiecePlayer(board[r][c]) === player) {
                        const chainLength = findLongestJumpChain(board, r, c, player, 0);
                        if (chainLength > maxLength) {
                            maxLength = chainLength;
                        }
                    }
                }
            }
            return maxLength;
        }

        function getPossibleMoves(board, player, mandatoryStart = null) {
            let moves = [];
            const maxLength = getMaxJumpChainLength(board, player);
            const isMandatoryJump = maxLength > 0;
            
            document.getElementById('action-info').textContent = isMandatoryJump 
                ? "M∆èCBURƒ∞ YEM∆è VAR: O da≈üƒ± se√ßin!"
                : "Adi h…ôr…ôk…ôt edin.";
            document.getElementById('action-info').className = `text-sm text-center p-2 rounded-lg w-full ${isMandatoryJump ? 'bg-red-500 text-white animate-pulse-fast' : 'bg-blue-600 text-white'}`;
            
            for (let r = 0; r < BOARD_SIZE; r++) {
                for (let c = 0; c < BOARD_SIZE; c++) {
                    if (getPiecePlayer(board[r][c]) === player) {
                        
                        if (mandatoryStart && (mandatoryStart.r !== r || mandatoryStart.c !== c)) continue;

                        const piece = board[r][c];
                        const isKingPiece = piece === 3 || piece === 4;
                        
                        // Yem…ô H…ôr…ôk…ôtl…ôri (Jumps)
                        const jumps = findJumps(board, r, c, player);
                        jumps.forEach(jump => {
                            const nextBoard = makeTempMove(board, r, c, jump.to.r, jump.to.c, jump.captured.r, jump.captured.c);
                            const chainLength = findLongestJumpChain(nextBoard, jump.to.r, jump.to.c, player, 1);
                            
                            if (chainLength === maxLength || !isMandatoryJump) {
                                moves.push({
                                    from: { r, c },
                                    to: jump.to,
                                    type: 'jump',
                                    captured: jump.captured,
                                    chainLength: chainLength
                                });
                            }
                        });

                        // Adi H…ôr…ôk…ôtl…ôr (Moves)
                        if (!isMandatoryJump) {
                            const directions = [[-1, -1], [-1, 1], [1, -1], [1, 1]]; 
                            
                            for (const [dr, dc] of directions) {
                                if (isKingPiece) {
                                    for (let i = 1; i < BOARD_SIZE; i++) {
                                        const newR = r + i * dr;
                                        const newC = c + i * dc;
                                        if (!isValidCell(newR, newC) || board[newR][newC] !== 0) break;

                                        moves.push({ from: { r, c }, to: { r: newR, c: newC }, type: 'move' });
                                    }
                                } else {
                                    const newR = r + dr;
                                    const newC = c + dc;
                                    
                                    const isForward = (player === 'white' && dr > 0) || (player === 'black' && dr < 0);
                                    
                                    if (isForward && isValidCell(newR, newC) && board[newR][newC] === 0) {
                                        moves.push({ from: { r, c }, to: { r: newR, c: newC }, type: 'move' });
                                    }
                                }
                            }
                        }
                    }
                }
            }
            return moves;
        }

        function makeTempMove(board, fromR, fromC, toR, toC, capturedR, capturedC) {
            const newBoard = JSON.parse(JSON.stringify(board));
            const pieceValue = newBoard[fromR][fromC];
            newBoard[fromR][fromC] = 0;
            newBoard[toR][toC] = pieceValue;
            if (capturedR !== undefined) {
                 newBoard[capturedR][capturedC] = 0;
            }
            return newBoard;
        }

        // --- 4. UI √á…ôkm…ô v…ô Hadis…ô ƒ∞dar…ôetm…ôsi ---

        function drawBoard(board, turn, mandatoryCapture) {
            document.getElementById('board').innerHTML = '';
            boardState = board;

            if (isMyTurn && myColor === turn) {
                possibleMoves = getPossibleMoves(board, myColor, mandatoryCapture);
            } else {
                possibleMoves = [];
            }
            
            const movesFromSelectedPiece = selectedPiece 
                ? possibleMoves.filter(m => m.from.r === selectedPiece.r && m.from.c === selectedPiece.c)
                : [];
            
            const mandatoryJumpPieces = isMyTurn && possibleMoves.some(m => m.type === 'jump') && !mandatoryCapture
                ? possibleMoves.filter(m => m.type === 'jump').map(m => m.from)
                : [];

            for (let r = 0; r < BOARD_SIZE; r++) {
                for (let c = 0; c < BOARD_SIZE; c++) {
                    const cell = document.createElement('div');
                    const isDark = (r + c) % 2 === 0;
                    cell.className = `cell ${ isDark ? 'bg-gray-200' : 'bg-gray-500' }`;
                    cell.dataset.row = r;
                    cell.dataset.col = c;
                    cell.onclick = handleBoardClick;
                    
                    const pieceValue = board[r][c];
                    
                    // M…ôcburi yem…ô vurƒüusu
                    if (isMyTurn && getPiecePlayer(pieceValue) === myColor) {
                        const isMandatoryPiece = mandatoryJumpPieces.some(p => p.r === r && p.c === c);
                        const isMandatoryContinue = mandatoryCapture && mandatoryCapture.r === r && mandatoryCapture.c === c;

                        if (isMandatoryPiece || isMandatoryContinue) {
                            cell.classList.add('mandatory-jump');
                        }
                    }
                    
                    // M√ºmk√ºn h…ôr…ôk…ôt xanalarƒ±nƒ± vurƒüula
                    const isPossibleMoveTo = movesFromSelectedPiece.some(m => m.to.r === r && m.to.c === c);
                    if (isPossibleMoveTo) {
                        cell.classList.add('possible-move');
                    }

                    // Da≈üƒ± √ß…ôk
                    if (pieceValue !== 0) {
                        const piece = document.createElement('div');
                        const player = getPiecePlayer(pieceValue);
                        const isKing = pieceValue === 3 || pieceValue === 4;

                        piece.className = `piece ${player === 'white' ? 'piece-white' : 'piece-black'} ${isKing ? `piece-king ${player === 'white' ? 'piece-king-white' : 'piece-king-black'}` : ''}`;
                        piece.textContent = getPieceSymbol(pieceValue);
                        piece.dataset.row = r;
                        piece.dataset.col = c;
                        
                        if (selectedPiece && selectedPiece.r === r && selectedPiece.c === c) {
                            piece.classList.add('selected');
                        }

                        cell.appendChild(piece);
                    }

                    document.getElementById('board').appendChild(cell);
                }
            }
        }
        
        function handleBoardClick(event) {
            if (!isMyTurn || !currentRoomId) return; 
            
            const cell = event.currentTarget;
            const r = parseInt(cell.dataset.row);
            const c = parseInt(cell.dataset.col);
            const pieceValue = boardState[r][c];
            const piecePlayer = getPiecePlayer(pieceValue);
            const isMyPiece = piecePlayer === myColor;
            
            const isMandatoryJumpActive = possibleMoves.some(m => m.type === 'jump');
            const mandatoryJumpPieces = possibleMoves.filter(m => m.type === 'jump').map(m => m.from);


            if (isMyPiece) {
                if (isMandatoryJumpActive && !mandatoryCapture) {
                    if (!mandatoryJumpPieces.some(p => p.r === r && p.c === c)) {
                        return showModal("M∆èCBURƒ∞ YEM∆è var. Yalnƒ±z vurma h…ôr…ôk…ôti olan da≈üƒ± se√ßin.");
                    }
                } else if (mandatoryCapture && (mandatoryCapture.r !== r || mandatoryCapture.c !== c)) {
                    return showModal("Z…ônciri davam etdirm…ôk √º√ß√ºn …ôvv…ôlki da≈üla h…ôr…ôk…ôt etm…ôlisiniz.");
                }

                selectedPiece = (selectedPiece && selectedPiece.r === r && selectedPiece.c === c) ? null : { r, c };
                
                drawBoard(boardState, myColor, mandatoryCapture);
                
            } else if (selectedPiece) {
                const movesFromSelectedPiece = possibleMoves.filter(m => m.from.r === selectedPiece.r && m.from.c === selectedPiece.c);
                const moveAttempt = movesFromSelectedPiece.find(m => m.to.r === r && m.to.c === c);

                if (moveAttempt) {
                    socket.emit('makeMove', {
                        roomId: currentRoomId,
                        from: selectedPiece,
                        to: { r, c },
                        type: moveAttempt.type,
                        captured: moveAttempt.captured,
                        player: myColor,
                        chainLength: moveAttempt.chainLength 
                    });
                    
                    selectedPiece = null; 
                    drawBoard(boardState, myColor, mandatoryCapture);
                    
                } else {
                    showModal("Bu, qaydalara uyƒüun olmayan h…ôr…ôk…ôtdir.");
                }
            }
        }

        // --- 5. Socket.IO ∆èlaq…ôsi v…ô Protokolu ---
        
        function initSocket() {
            
            const userData = getTelegramUser();
            currentUserId = userData.id;
            currentUserName = userData.name;
            
            document.getElementById('user-name-display').textContent = `ƒ∞stifad…ô√ßi: ${currentUserName}`;
            document.getElementById('current-user-id-display').textContent = `ID: ${currentUserId.substring(0, 8)}...`;
            document.getElementById('my-name-display').textContent = currentUserName;

            // M√ñHK∆èM BAƒûLANTI KONFƒ∞QURASƒ∞YASI
            socket = io(SERVER_URL, {
                query: { 
                    userId: currentUserId,
                    userName: currentUserName
                },
                transports: ['websocket', 'polling'], 
                reconnectionDelayMax: 5000 
            });

            showScreen('loading');

            socket.on('connect', () => {
                document.getElementById('connection-status').textContent = "‚úÖ Server…ô qo≈üulmu≈üdur";
                document.getElementById('connection-status').className = "text-sm font-semibold mt-2 text-green-500";
                showScreen('lobby');
            });

            // Baƒülantƒ± X…ôtasƒ±nƒ±n Diaqnostikasƒ±
            socket.on('connect_error', (error) => {
                let errorMessage = "Nam…ôlum x…ôta.";
                if (error.message.includes("websocket error")) {
                    errorMessage = "WebSocket x…ôtasƒ±. Server Socket.IO-nu q…ôbul etmir (CORS v…ô ya Port problemi).";
                } else if (error.message.includes("xhr poll error")) {
                    errorMessage = "HTTP Polling x…ôtasƒ±. Server cavab vermir/eri≈üilm…ôzdir.";
                } else if (error.message.includes("timeout")) {
                     errorMessage = "Baƒülantƒ± vaxtƒ± bitdi (Timeout). Server yava≈üdƒ±r v…ô ya yatƒ±b.";
                }
                 document.getElementById('connection-status').textContent = `‚ùå BAƒûLANTI X∆èTASI: ${errorMessage}. Serveri yoxlayƒ±n!`;
                 document.getElementById('connection-status').className = "text-sm font-semibold mt-2 text-red-600 font-bold";
                 showScreen('loading');
            });

            socket.on('disconnect', () => {
                document.getElementById('connection-status').textContent = "‚ùå Serverl…ô …ôlaq…ô k…ôsildi";
                document.getElementById('connection-status').className = "text-sm font-semibold mt-2 text-red-500 animate-pulse-fast";
                showScreen('loading');
            });
            
            socket.on('roomUpdate', (data) => {
                currentRoomId = data.roomId;
                myColor = data.playerBlackId === currentUserId ? 'black' : (data.playerWhiteId === currentUserId ? 'white' : null);
                
                if (data.status === 'playing') {
                    showScreen('game');
                    updateGameUI(data);
                } else if (data.status === 'finished') {
                    const winnerMessage = data.reason ? data.reason : `Oyun Bitdi! Qalib: ${data.winner === 'white' ? 'Aƒü' : 'Qara'}!`;
                    showModal(winnerMessage, () => leaveGame(false));
                }
            });
            
            socket.on('moveConfirmed', (data) => {
                updateGameUI(data);
            });
            
            socket.on('turnTimerUpdate', (data) => {
                if (data.turn === 'white') {
                    document.getElementById('white-timer').textContent = formatTime(data.timeLeft);
                } else if (data.turn === 'black') {
                    document.getElementById('black-timer').textContent = formatTime(data.timeLeft);
                }
            });
            
            socket.on('opponentLeft', (data) => {
                 showModal(`R…ôqib oyunu t…ôrk etdi. ${data.winner === myColor ? 'Siz udunuz!' : 'Oyun dayandƒ±rƒ±ldƒ±.'}`, () => leaveGame(false));
             });

            socket.on('gameMessage', (message) => {
                showModal(`M…ôlumat: ${message}`);
            });

            // E≈ül…ô≈üm…ô zamanƒ± serverd…ôn g…ôl…ôn mesajlar (…ôg…ôr serverd…ô Matchmaking m…ôntiqi varsa)
             socket.on('statusUpdate', (data) => {
                if (data.status === 'searching') {
                    showScreen('searching');
                } else if (data.status === 'matchFound' && data.roomId) {
                    // Bu hiss…ô ad…ôt…ôn server t…ôr…ôfind…ôn 'roomUpdate' il…ô …ôv…ôzl…ônir
                    showModal(`R…ôqib tapƒ±ldƒ±! Otaq: ${data.roomId}`);
                }
            });
        }
        
        // --- 6. Oyun UI Yenil…ônm…ôsi ---

        function updateGameUI(data) {
            const myId = currentUserId;

            let opponentName = (data.playerBlackId === myId ? data.playerWhite?.name : data.playerBlack?.name) || 'R…ôqib G√∂zl…ônilir';
            document.getElementById('opponent-name-display').textContent = opponentName;
            
            const turnColor = data.turn;
            isMyTurn = turnColor === myColor;
            mandatoryCapture = data.mandatoryCapture; 

            document.getElementById('current-turn-display').textContent = isMyTurn ? 'Sƒ∞Zƒ∞N N√ñVB∆èNƒ∞ZDƒ∞R!' : `R…ôqibd…ôdir (${turnColor === 'black' ? 'Qara' : 'Aƒü'})`;
            document.getElementById('current-turn-display').className = `text-lg font-bold p-3 rounded-xl shadow-xl transition duration-300 w-full text-center ${isMyTurn ? 'bg-green-600 animate-pulse-fast' : 'bg-yellow-600'}`;
            
            const whiteTimer = document.getElementById('white-timer');
            const blackTimer = document.getElementById('black-timer');

            whiteTimer.className = `p-2 rounded-lg font-mono text-2xl text-white shadow-md min-w-[80px] text-center ${turnColor === 'white' ? 'bg-red-500 animate-pulse-fast' : 'bg-gray-700'}`;
            blackTimer.className = `p-2 rounded-lg font-mono text-2xl text-white shadow-md min-w-[80px] text-center ${turnColor === 'black' ? 'bg-red-500 animate-pulse-fast' : 'bg-gray-700'}`;
            
            if (!timerInterval) {
                timerInterval = setInterval(() => {
                    if (socket && socket.connected && currentRoomId) {
                        socket.emit('requestTimerUpdate', { roomId: data.roomId });
                    }
                }, 1000); 
            }

            drawBoard(data.board, turnColor, mandatoryCapture);
        }

        // --- 7. Lobiya H…ôr…ôk…ôtl…ôri ---

        document.getElementById('dereceli-btn').onclick = () => {
            if (!socket || !socket.connected) return showModal("Server…ô qo≈üulmayƒ±b.");
            
            showScreen('searching');
            // üí° D∆èYƒ∞≈ûƒ∞KLƒ∞K: Reytinqli axtarƒ±≈ü funksiyasƒ±
            socket.emit('startRankedMatchmaking', { 
                userId: currentUserId, 
                userName: currentUserName 
            });
        };

        document.getElementById('deregeli-cancel-btn').onclick = () => {
            if (!socket || !socket.connected) return;
            // üí° D∆èYƒ∞≈ûƒ∞KLƒ∞K: Axtarƒ±≈üƒ±n l…ôƒüvi
            socket.emit('cancelRankedMatchmaking', { userId: currentUserId });
            showScreen('lobby');
        };

        document.getElementById('create-room-btn').onclick = () => {
            if (!socket || !socket.connected) return showModal("Server…ô qo≈üulmayƒ±b.");
            showScreen('loading');
            socket.emit('createRoom', { userId: currentUserId, userName: currentUserName });
        };

        document.getElementById('copy-code-btn').onclick = () => {
            const code = document.getElementById('room-code-output').textContent;
            if (code && code !== '....') {
                navigator.clipboard.writeText(code).then(() => showModal(`Otaq kodu (${code}) kopyalandƒ±!`)).catch(() => showModal("Kopyalama x…ôtasƒ±."));
            }
        };

        document.getElementById('join-room-btn').onclick = () => {
            if (!socket || !socket.connected) return showModal("Server…ô qo≈üulmayƒ±b.");
            const roomCode = document.getElementById('join-room-input').value.trim();
            if (roomCode.length !== 4) return showModal("Xahi≈ü edirik, 4 r…ôq…ômli otaq kodunu daxil edin.");

            showScreen('loading');
            socket.emit('joinRoom', { roomId: roomCode, userId: currentUserId, userName: currentUserName });
            document.getElementById('join-room-input').value = '';
        };

        document.getElementById('leave-game-btn').onclick = () => {
            showModal("Oyunu t…ôrk ets…ôniz m…ôƒülub sayƒ±lacaqsƒ±nƒ±z. Davam edilsin?", () => leaveGame(true));
        };

        function leaveGame(notifyServer) {
            if (notifyServer && socket && socket.connected && currentRoomId) {
                socket.emit('leaveRoom', { roomId: currentRoomId, userId: currentUserId });
            }
            currentRoomId = null;
            selectedPiece = null;
            mandatoryCapture = null;
            possibleMoves = [];
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = null;
            showScreen('lobby');
        }

        // --- Ba≈ülanƒüƒ±c ---
        document.addEventListener('DOMContentLoaded', initSocket);

    </script>
</body>
</html>
