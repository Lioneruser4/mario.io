<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Dama Online - Profesyonel Dama Oyunu</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Roboto:wght@300;400;700&display=swap');
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%); 
            color: #fff; font-family: 'Roboto', sans-serif; 
            display: flex; justify-content: center; align-items: center; min-height: 100vh; 
            overflow: hidden; position: relative;
        }
        body::before { content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%); animation: sparkle 4s infinite; z-index: -1; }
        @keyframes sparkle { 0%, 100% { opacity: 0; } 50% { opacity: 1; } }
        #game-container { 
            background: rgba(0,0,0,0.8); backdrop-filter: blur(20px); padding: 30px; border-radius: 20px; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.1); 
            text-align: center; max-width: 800px; width: 90%; position: relative;
            animation: fadeIn 0.8s ease-out;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        h1 { font-family: 'Orbitron', monospace; font-size: 3em; margin-bottom: 20px; background: linear-gradient(45deg, #ff6b6b, #4ecdc4); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 0 0 20px rgba(255,107,107,0.5); }
        h2 { font-family: 'Orbitron', monospace; font-size: 1.8em; margin: 20px 0 10px; color: #4ecdc4; }
        #connection-status { position: absolute; top: 10px; right: 10px; padding: 8px 12px; border-radius: 20px; font-size: 0.9em; font-weight: bold; transition: all 0.3s; }
        .connected { background: #4caf50; color: white; box-shadow: 0 0 10px #4caf50; }
        .disconnected { background: #f44336; color: white; box-shadow: 0 0 10px #f44336; }
        #username-input, #room-code-input { margin: 10px 0; padding: 10px; border: none; border-radius: 10px; background: rgba(255,255,255,0.1); color: white; font-size: 1em; width: 200px; text-align: center; }
        #username-input::placeholder, #room-code-input::placeholder { color: rgba(255,255,255,0.6); }
        button { 
            padding: 15px 30px; font-size: 1.2em; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            border: none; border-radius: 50px; color: #fff; cursor: pointer; transition: all 0.3s; 
            box-shadow: 0 10px 20px rgba(0,0,0,0.3); font-weight: bold; margin: 10px;
            position: relative; overflow: hidden;
        }
        button::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent); transition: left 0.5s; }
        button:hover::before { left: 100%; }
        button:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0,0,0,0.4); }
        button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        #mode-selection { margin: 20px 0; }
        #lobby { display: none; margin: 20px; padding: 20px; background: rgba(255,255,255,0.05); border-radius: 15px; border: 1px solid rgba(78,205,196,0.3); }
        .lobby-progress { width: 100%; height: 10px; background: rgba(255,255,255,0.1); border-radius: 5px; margin: 10px 0; overflow: hidden; }
        .lobby-progress-bar { height: 100%; background: linear-gradient(90deg, #4ecdc4, #ff6b6b); width: 0%; transition: width 0.5s; animation: progressPulse 2s infinite; }
        @keyframes progressPulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        #waiting-players { margin: 10px 0; font-size: 1.1em; color: #4ecdc4; }
        #room-code { font-size: 2em; font-weight: bold; color: #ffd700; margin: 10px 0; font-family: 'Orbitron', monospace; }
        #board { 
            display: grid; grid-template-columns: repeat(8, 65px); grid-template-rows: repeat(8, 65px); 
            border: 4px solid #4ecdc4; border-radius: 15px; margin: 30px auto; box-shadow: 
            0 0 30px rgba(78,205,196,0.5), inset 0 0 20px rgba(0,0,0,0.5); overflow: hidden;
            background: linear-gradient(145deg, #1a1a2e, #16213e);
        }
        .cell { 
            display: flex; justify-content: center; align-items: center; position: relative; 
            transition: all 0.3s; cursor: pointer;
        }
        .white { background: linear-gradient(145deg, #e0e0e0, #f5f5f5); }
        .black { background: linear-gradient(145deg, #2d2d2d, #1a1a1a); }
        .piece { 
            width: 55px; height: 55px; border-radius: 50%; cursor: pointer; position: absolute; 
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); box-shadow: 0 8px 25px rgba(0,0,0,0.6);
            display: flex; align-items: center; justify-content: center; font-size: 0.8em; font-weight: bold;
        }
        .piece:hover { transform: scale(1.2) rotate(5deg); box-shadow: 0 12px 35px rgba(0,0,0,0.8); }
        .red { background: linear-gradient(145deg, #ff4757, #ff6b7a); border: 3px solid #c44569; color: white; }
        .black-piece { background: linear-gradient(145deg, #2f3542, #57606f); border: 3px solid #2f3542; color: #ddd; }
        .king { border-width: 5px; border-color: #ffd700; box-shadow: 0 0 20px #ffd700; text-shadow: 0 0 10px #ffd700; }
        .possible-move { background: rgba(76, 175, 80, 0.6) !important; transform: scale(1.05); box-shadow: inset 0 0 15px rgba(76,175,80,0.8); }
        .turn-highlight { box-shadow: inset 0 0 25px 8px rgba(255, 193, 7, 0.7); animation: glow 1s infinite alternate; }
        @keyframes glow { from { box-shadow: inset 0 0 25px 8px rgba(255,193,7,0.7); } to { box-shadow: inset 0 0 35px 12px rgba(255,193,7,1); } }
        #status { margin: 20px 0; font-size: 1.4em; font-weight: bold; color: #4ecdc4; text-shadow: 0 0 10px rgba(78,205,196,0.5); }
        #score { display: flex; justify-content: space-around; margin: 20px 0; font-size: 1.2em; }
        .score-item { background: rgba(255,255,255,0.1); padding: 10px 20px; border-radius: 10px; }
        #timer { font-family: 'Orbitron', monospace; font-size: 2em; color: #ff6b6b; margin: 10px 0; }
        .notification { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); padding: 15px 25px; background: #4caf50; color: white; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 1000; animation: slideIn 0.5s ease; display: none; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-50%) translateY(-20px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }
        @media (max-width: 768px) { #board { grid-template-columns: repeat(8, 50px); grid-template-rows: repeat(8, 50px); } .piece { width: 40px; height: 40px; } h1 { font-size: 2em; } }
    </style>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
</head>
<body>
    <div id="notification" class="notification"></div>
    <div id="game-container">
        <div id="connection-status" class="disconnected">BaÄŸlanÄ±yor...</div>
        <h1>Pro Dama Online</h1>
        <input type="text" id="username-input" placeholder="KullanÄ±cÄ± adÄ±n..." maxlength="15">
        <div id="mode-selection">
            <button id="ranked-play">Dereceli Oyna</button>
            <button id="create-room">Oda OluÅŸtur</button>
            <input type="text" id="room-code-input" placeholder="Oda Kodu (4 haneli)" maxlength="4" style="display:none;">
            <button id="join-room" style="display:none;">Odaya KatÄ±l</button>
        </div>
        <div id="lobby" class="lobby">
            <h2 id="lobby-title">EÅŸleÅŸme AranÄ±yor...</h2>
            <div class="lobby-progress"><div class="lobby-progress-bar" id="progress-bar"></div></div>
            <div id="waiting-players">Bekleyen: <span id="player-count">0</span></div>
            <div id="room-code" style="display:none;"></div>
            <span id="search-timer"></span>
        </div>
        <div id="board" style="display:none"></div>
        <div id="status"></div>
        <div id="score">
            <div class="score-item">Sen: <span id="your-score">0</span></div>
            <div class="score-item">Rakip: <span id="opponent-score">0</span></div>
        </div>
        <div id="timer">00:30</div>
    </div>

    <script>
        const socket = io('https://mario-io-1.onrender.com', { transports: ['websocket'], timeout: 20000 });
        let board = [], currentPlayer = 'red', selectedPiece = null, playerColor = null, gameId = null, isMyTurn = false;
        let username = '', gameTimer = null, searchTimer = null, turnTime = 30, timeLeft = 30;
        let yourScore = 0, opponentScore = 0, mode = 'ranked'; // 'ranked' or 'private'

        function showNotification(msg, type = 'info') {
            const notif = document.getElementById('notification');
            notif.textContent = msg;
            notif.style.background = type === 'success' ? '#4caf50' : type === 'error' ? '#f44336' : '#2196f3';
            notif.style.display = 'block';
            setTimeout(() => notif.style.display = 'none', 3000);
        }

        function updateConnectionStatus(connected) {
            const status = document.getElementById('connection-status');
            status.textContent = connected ? 'BaÄŸlandÄ±!' : 'BaÄŸlantÄ± Koptu!';
            status.className = connected ? 'connected' : 'disconnected';
        }

        function updateTimer() {
            const mins = Math.floor(timeLeft / 60);
            const secs = timeLeft % 60;
            document.getElementById('timer').textContent = `${mins.toString().padStart(2,'0')}:${secs.toString().padStart(2,'0')}`;
            if (timeLeft <= 0 && isMyTurn) { showNotification('Zaman doldu! SÄ±ra rakibe geÃ§iyor.', 'error'); switchTurn(); }
        }

        function startTurnTimer() {
            if (gameTimer) clearInterval(gameTimer);
            timeLeft = 30;
            updateTimer();
            gameTimer = setInterval(() => { timeLeft--; updateTimer(); }, 1000);
        }

        function updateLobbyProgress(count, max = 2) {
            const progress = (count / max) * 100;
            document.getElementById('progress-bar').style.width = progress + '%';
            document.getElementById('player-count').textContent = count;
        }

        function initBoard() {
            const b = document.getElementById('board'); b.innerHTML = ''; b.style.display = 'grid';
            board = Array.from({length:8},()=>Array(8).fill(null));
            for(let r=0;r<8;r++) for(let c=0;c<8;c++){
                const cell = document.createElement('div');
                cell.classList.add('cell', (r+c)%2===0 ? 'white' : 'black');
                cell.dataset.row = r; cell.dataset.col = c;
                cell.addEventListener('click', handleCellClick);
                b.appendChild(cell);
                if(r<3 && (r+c)%2===1) placePiece(r,c,'black');
                if(r>4 && (r+c)%2===1) placePiece(r,c,'red');
            }
            updateScores();
        }

        function placePiece(r,c,color, isKing = false) {
            const cell = document.querySelector(`[data-row="${r}"][data-col="${c}"]`);
            if (cell.firstChild) cell.innerHTML = '';
            const p = document.createElement('div');
            p.classList.add('piece', color==='red'?'red':'black-piece');
            p.dataset.color = color; p.innerHTML = isKing ? 'ðŸ‘‘' : color === 'red' ? 'ðŸ”´' : 'âš«';
            p.addEventListener('click', e => { e.stopPropagation(); if(isMyTurn && color===playerColor){ clearHighlights(); selectedPiece=p; highlightPossibleMoves(r,c); } });
            cell.appendChild(p);
            board[r][c] = {color, king: isKing};
        }

        function highlightPossibleMoves(r,c) {
            const moves = getPossibleMoves(r,c, board[r][c].color==='red' ? -1 : 1, board[r][c].king);
            moves.forEach(([tr,tc]) => document.querySelector(`[data-row="${tr}"][data-col="${tc}"]`).classList.add('possible-move'));
        }

        function getPossibleMoves(r,c,dir,isKing) {
            const moves = [], dirs = isKing ? [[-1,-1],[-1,1],[1,-1],[1,1]] : [[dir,-1],[dir,1]];
            dirs.forEach(([dr,dc]) => {
                let nr = r+dr, nc = c+dc;
                if(nr>=0&&nr<8&&nc>=0&&nc<8 && !board[nr][nc]) moves.push([nr,nc]);
                else if(nr>=0&&nr<8&&nc>=0&&nc<8 && board[nr][nc] && board[nr][nc].color !== board[r][c].color) {
                    nr += dr; nc += dc;
                    if(nr>=0&&nr<8&&nc>=0&&nc<8 && !board[nr][nc]) moves.push([nr,nc]);
                }
            });
            const captures = moves.filter(m => Math.abs(m[0]-r)===2);
            return captures.length ? captures : moves;
        }

        function handleCellClick(e) {
            if(!selectedPiece || !isMyTurn) return;
            const fr = +selectedPiece.parentNode.dataset.row, fc = +selectedPiece.parentNode.dataset.col;
            const tr = +e.currentTarget.dataset.row, tc = +e.currentTarget.dataset.col;
            if(getPossibleMoves(fr,fc, board[fr][fc].color==='red'?-1:1, board[fr][fc].king).some(([mr,mc])=>mr===tr&&mc===tc)) {
                animateMove(selectedPiece, fr, fc, tr, tc, () => {
                    movePiece(fr, fc, tr, tc);
                    clearHighlights(); selectedPiece = null;
                    if (isMyTurn) yourScore++; else opponentScore++;
                    updateScores();
                    switchTurn();
                    socket.emit('move', {gameId, board, currentPlayer, scores: {your: yourScore, opponent: opponentScore}});
                    checkWin();
                });
            }
        }

        function animateMove(piece, fr, fc, tr, tc, cb) {
            const fromCell = piece.parentNode, toCell = document.querySelector(`[data-row="${tr}"][data-col="${tc}"]`);
            const rect1 = fromCell.getBoundingClientRect(), rect2 = toCell.getBoundingClientRect();
            piece.style.position = 'fixed'; piece.style.zIndex = 1000; piece.style.transition = 'all 0.6s cubic-bezier(0.25,0.46,0.45,0.94)';
            piece.style.left = rect1.left + 'px'; piece.style.top = rect1.top + 'px';
            setTimeout(() => { piece.style.left = rect2.left + 'px'; piece.style.top = rect2.top + 'px'; }, 50);
            setTimeout(() => { piece.style.position = ''; piece.style.left = ''; piece.style.top = ''; piece.style.zIndex = ''; cb(); }, 650);
        }

        function movePiece(fr, fc, tr, tc) {
            board[tr][tc] = board[fr][fc]; board[fr][fc] = null;
            if(Math.abs(tr-fr)===2) {
                const mr = (fr+tr)/2, mc = (fc+tc)/2;
                board[mr][mc] = null;
                document.querySelector(`[data-row="${mr}"][data-col="${mc}"]`).innerHTML = '';
            }
            const targetCell = document.querySelector(`[data-row="${tr}"][data-col="${tc}"]`);
            targetCell.appendChild(document.querySelector(`[data-row="${fr}"][data-col="${fc}"]`).firstChild);
            const piece = board[tr][tc];
            if((piece.color==='red' && tr===0) || (piece.color==='black' && tr===7)) {
                piece.king = true;
                targetCell.firstChild.innerHTML = 'ðŸ‘‘';
                targetCell.firstChild.classList.add('king');
            }
        }

        function clearHighlights() { document.querySelectorAll('.possible-move').forEach(el => el.classList.remove('possible-move')); }

        function switchTurn() {
            currentPlayer = currentPlayer === 'red' ? 'black' : 'red';
            isMyTurn = currentPlayer === playerColor;
            updateTurnHighlight();
            document.getElementById('status').textContent = isMyTurn ? 'SÄ±ra Sende!' : 'Rakibin SÄ±rasÄ±...';
            if (isMyTurn) startTurnTimer(); else if (gameTimer) clearInterval(gameTimer);
        }

        function updateTurnHighlight() {
            document.querySelectorAll('.cell').forEach(c => c.classList.remove('turn-highlight'));
            const start = currentPlayer === 'red' ? 5 : 0, end = currentPlayer === 'red' ? 8 : 3;
            for(let r=start; r<end; r++) for(let c=0; c<8; c++) {
                const cell = document.querySelector(`[data-row="${r}"][data-col="${c}"]`);
                if (cell) cell.classList.add('turn-highlight');
            }
        }

        function updateScores() {
            document.getElementById('your-score').textContent = yourScore;
            document.getElementById('opponent-score').textContent = opponentScore;
        }

        function checkWin() {
            const redCount = board.flat().filter(p => p && p.color === 'red').length;
            const blackCount = board.flat().filter(p => p && p.color === 'black').length;
            if (redCount === 0 || blackCount === 0) {
                const winner = redCount === 0 ? 'Siyah' : 'KÄ±rmÄ±zÄ±';
                showNotification(`${winner} KazandÄ±! Tebrikler!`, 'success');
                socket.emit('endGame', gameId);
                if (gameTimer) clearInterval(gameTimer);
                document.getElementById('board').style.display = 'none';
                document.getElementById('status').textContent = 'Oyun Bitti! Yeni Oyun Ä°Ã§in Butona TÄ±kla.';
                document.querySelectorAll('#mode-selection button').forEach(btn => btn.disabled = false);
            }
        }

        function renderBoardFromState() {
            document.querySelectorAll('.cell').forEach(cell => {
                cell.innerHTML = '';
                const r = +cell.dataset.row, c = +cell.dataset.col;
                if (board[r][c]) placePiece(r, c, board[r][c].color, board[r][c].king);
            });
        }

        function startSearch() {
            if (!username) { showNotification('LÃ¼tfen kullanÄ±cÄ± adÄ±nÄ± gir!', 'error'); return; }
            document.getElementById('lobby').style.display = 'block';
            document.querySelectorAll('#mode-selection button').forEach(btn => btn.disabled = true);
            let searchCount = 0;
            searchTimer = setInterval(() => {
                searchCount++;
                document.getElementById('search-timer').textContent = `(${searchCount}s)`;
            }, 1000);
        }

        // Event Listeners
        document.getElementById('username-input').addEventListener('input', e => username = e.target.value.trim());
        document.getElementById('ranked-play').addEventListener('click', () => {
            mode = 'ranked';
            document.getElementById('lobby-title').textContent = 'EÅŸleÅŸme AranÄ±yor...';
            document.getElementById('room-code').style.display = 'none';
            document.getElementById('room-code-input').style.display = 'none';
            document.getElementById('join-room').style.display = 'none';
            startSearch();
            socket.emit('joinQueue', { username, mode });
        });

        document.getElementById('create-room').addEventListener('click', () => {
            mode = 'private';
            document.getElementById('lobby-title').textContent = 'Oda OluÅŸturuluyor...';
            document.getElementById('room-code-input').style.display = 'none';
            document.getElementById('join-room').style.display = 'none';
            startSearch();
            socket.emit('createRoom', username);
        });

        document.getElementById('join-room').addEventListener('click', () => {
            const code = document.getElementById('room-code-input').value.trim().toUpperCase();
            if (code.length !== 4 || !/^[A-Z0-9]{4}$/.test(code)) { showNotification('GeÃ§erli 4 haneli kod girin (harf/rakam)!', 'error'); return; }
            mode = 'private';
            document.getElementById('lobby-title').textContent = 'Odaya KatÄ±lÄ±nÄ±yor...';
            document.getElementById('room-code').style.display = 'none';
            startSearch();
            socket.emit('joinRoom', { username, code });
        });

        socket.on('connect', () => {
            updateConnectionStatus(true);
            showNotification('Sunucuya baÄŸlandÄ±!', 'success');
        });

        socket.on('disconnect', () => {
            updateConnectionStatus(false);
            showNotification('BaÄŸlantÄ± koptu! Yeniden baÄŸlanÄ±lÄ±yor...', 'error');
        });

        socket.on('queueUpdate', data => {
            updateLobbyProgress(data.count);
        });

        socket.on('roomCreated', data => {
            document.getElementById('lobby-title').textContent = 'Oda OluÅŸturuldu!';
            document.getElementById('room-code').textContent = data.code;
            document.getElementById('room-code').style.display = 'block';
            document.getElementById('waiting-players').textContent = 'ArkadaÅŸÄ±nÄ± bekliyoruz...';
            updateLobbyProgress(1);
            showNotification(`Oda kodu: ${data.code} - ArkadaÅŸÄ±na paylaÅŸ!`, 'success');
        });

        socket.on('roomJoined', data => {
            document.getElementById('lobby').style.display = 'none';
            gameId = data.gameId; playerColor = data.color;
            initBoard();
            isMyTurn = playerColor === 'red';
            switchTurn();
            showNotification(`Odaya katÄ±ldÄ±n! Sen ${playerColor === 'red' ? 'KÄ±rmÄ±zÄ±' : 'Siyah'} taraftasÄ±n.`, 'success');
            yourScore = 0; opponentScore = 0; updateScores();
        });

        socket.on('gameStart', data => {
            if (searchTimer) clearInterval(searchTimer);
            document.getElementById('lobby').style.display = 'none';
            document.getElementById('search-timer').textContent = '';
            gameId = data.gameId; playerColor = data.color; username = data.username || username;
            initBoard();
            isMyTurn = playerColor === 'red';
            switchTurn();
            showNotification(`Oyun baÅŸladÄ±! Sen ${playerColor === 'red' ? 'KÄ±rmÄ±zÄ±' : 'Siyah'} taraftasÄ±n.`, 'success');
            yourScore = 0; opponentScore = 0; updateScores();
        });

        socket.on('updateState', data => {
            board = data.board; currentPlayer = data.currentPlayer;
            yourScore = data.scores?.your || yourScore;
            opponentScore = data.scores?.opponent || opponentScore;
            isMyTurn = currentPlayer === playerColor;
            renderBoardFromState();
            updateScores();
            updateTurnHighlight();
            document.getElementById('status').textContent = isMyTurn ? 'SÄ±ra Sende!' : 'Rakibin SÄ±rasÄ±...';
            if (isMyTurn) startTurnTimer();
            checkWin();
        });

        socket.on('opponentDisconnected', () => {
            showNotification('Rakip baÄŸlantÄ± koptu! Sen kazandÄ±n!', 'success');
            endGame();
        });

        function endGame() {
            if (gameTimer) clearInterval(gameTimer);
            if (searchTimer) clearInterval(searchTimer);
            document.getElementById('board').style.display = 'none';
            document.querySelectorAll('#mode-selection button').forEach(btn => btn.disabled = false);
        }

        // Private room butonlarÄ±
        document.getElementById('create-room').addEventListener('click', () => {
            document.getElementById('room-code-input').style.display = 'none';
            document.getElementById('join-room').style.display = 'none';
        });
        // Join room iÃ§in input gÃ¶ster (buton tÄ±klanÄ±nca, ama create'de gizle)
    </script>
</body>
</html>
