<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Online Dama Oyunu</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>

    <style>
        /* Basit CSS stil ÅŸemasÄ± (style.css dosyanÄ±z varsa bu kÄ±sÄ±m oraya taÅŸÄ±nmalÄ±) */
        :root {
            --primary-color: #3498db;
            --secondary-color: #2ecc71;
            --dark-bg: #2c3e50;
            --light-bg: #ecf0f1;
            --square-light: #f5f5dc;
            --square-dark: #8b4513;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--dark-bg);
            color: #fff;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        #app-container {
            background: #34495e;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            width: 90%;
            max-width: 500px;
            text-align: center;
        }

        /* Ekranlar */
        .screen { display: none; }
        .screen.active { display: block; }
        
        /* Logo ve BaÅŸlÄ±klar */
        .logo-text { font-size: 2.5em; margin-bottom: 5px; font-weight: 800; }
        .logo-span { color: var(--primary-color); }
        .info-text { margin-top: 10px; font-size: 0.9em; opacity: 0.8; }
        .status-conn { color: #f39c12; }
        .status-conn.green { color: var(--secondary-color); }
        .status-conn.red { color: #e74c3c; }

        /* Butonlar */
        .main-btn, .secondary-btn {
            padding: 12px 20px;
            margin: 8px 5px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        .main-btn { background-color: var(--primary-color); color: white; }
        .main-btn:hover:not(:disabled) { background-color: #2980b9; }
        .main-btn:disabled { background-color: #7f8c8d; cursor: not-allowed; }
        .main-btn.green-btn { background-color: var(--secondary-color); }
        .secondary-btn { background-color: #e74c3c; color: white; }

        /* Lobi Kontrolleri */
        .lobby-controls { margin-top: 20px; }
        .join-group { display: flex; gap: 5px; margin-top: 10px; }
        #roomIdInput {
            flex-grow: 1;
            padding: 10px;
            border-radius: 8px;
            border: 2px solid #bdc3c7;
            text-align: center;
            font-size: 1em;
        }

        /* Oyun TahtasÄ± */
        #board {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            width: 100%;
            max-width: 400px;
            height: 400px;
            margin: 20px auto;
            border: 5px solid #c0392b;
        }
        .square {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        .square.light { background-color: var(--square-light); }
        .square.dark { background-color: var(--square-dark); }
        .square.possible-move { background-color: rgba(255, 255, 0, 0.5); cursor: pointer; }

        /* TaÅŸlar */
        .piece {
            width: 80%;
            height: 80%;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.6);
            border: 2px solid rgba(255, 255, 255, 0.3);
            transition: transform 0.1s;
        }
        .piece.black { background-color: #000; }
        .piece.white { background-color: #fff; }
        .piece.king { border: 4px solid gold; box-shadow: 0 0 10px gold; }
        .piece.selected { transform: scale(1.1); border-color: var(--primary-color); }

        /* GÃ¶stergeler */
        .turn-mine { color: var(--secondary-color); }
        .turn-opponent { color: #e74c3c; }
    </style>
</head>
<body>
    <div id="app-container">
        <div id="lobby" class="screen active">
            <h1 class="logo-text">CHEC<span class="logo-span">KERS</span> ONLINE</h1>
            <p id="status" class="info-text status-conn">Sunucuya baÄŸlanÄ±lÄ±yor...</p>
            
            <div id="auth-status">
                <p id="player-name">GiriÅŸ YapÄ±lÄ±yor...</p>
                <script async src="https://telegram.org/js/telegram-widget.js?24" 
                    data-telegram-login="[BOT_KULLANICI_ADINIZ]" 
                    data-size="large" 
                    data-auth-url="[SUNUCU_ADRESÄ°NÄ°Z]/telegram-auth" 
                    data-request-access="write"></script>
            </div>
            
            <div class="lobby-controls">
                <button id="rankedBtn" class="main-btn green-btn" disabled>
                    <i class="fas fa-medal"></i> Dereceli EÅŸleÅŸme Bul
                </button>

                <button id="createBtn" class="main-btn" disabled>
                    <i class="fas fa-plus-circle"></i> Yeni Oda Kur
                </button>
                
                <div class="join-group">
                    <input type="text" id="roomIdInput" placeholder="Oda Kodunu Girin (4 Haneli)" maxlength="4">
                    <button id="joinBtn" class="main-btn" disabled>
                        <i class="fas fa-sign-in-alt"></i> KatÄ±l
                    </button>
                </div>
                
                <p id="roomCodeDisplay" class="info-text"></p>
            </div>
        </div>
        
        <div id="game" class="screen">
            <div class="game-header">
                <p id="playerRoleDisplay" class="role-text"></p>
                <h2 id="turnIndicator">SÄ±ra: Bekleniyor...</h2>
                <button id="leaveBtn" class="secondary-btn"><i class="fas fa-times-circle"></i> AyrÄ±l</button>
            </div>
            
            <div class="board-wrapper">
                <div id="board">
                    </div>
            </div>
        </div>
    </div>

    <script>
        // Sunucu adresiniz (Render URL'niz)
        const SERVER_URL = 'https://mario-io-1.onrender.com'; // Kendi adresinizle deÄŸiÅŸtirin! 
        const socket = io(SERVER_URL);

        // --- DOM Elementleri ---
        const lobbyDiv = document.getElementById('lobby');
        const gameDiv = document.getElementById('game');
        const statusDiv = document.getElementById('status');
        const boardDiv = document.getElementById('board');
        const turnIndicator = document.getElementById('turnIndicator');
        const roomIdInput = document.getElementById('roomIdInput');
        const roomCodeDisplay = document.getElementById('roomCodeDisplay');
        const createBtn = document.getElementById('createBtn');
        const joinBtn = document.getElementById('joinBtn');
        const leaveBtn = document.getElementById('leaveBtn');
        const playerNameDisplay = document.getElementById('player-name');
        const playerRoleDisplay = document.getElementById('playerRoleDisplay');
        const rankedBtn = document.getElementById('rankedBtn'); // YENÄ° Dereceli Buton

        // --- Oyun Durum DeÄŸiÅŸkenleri ---
        let currentRoomId = null;
        let playerRole = null; // 'player1' veya 'player2'
        let currentBoard = null;
        let currentTurn = null;
        let currentUsername = null; // Misafir veya Telegram kullanÄ±cÄ± adÄ±
        let selectedPiece = null; // SeÃ§ili taÅŸÄ±n {r, c} konumu

        // --- YENÄ°: Misafir AdÄ± OluÅŸturma Fonksiyonu ---
        function generateGuestName() {
            const randomNumber = Math.floor(Math.random() * 900) + 100;
            return `Guest${randomNumber}`;
        }

        // --- YENÄ°: KullanÄ±cÄ± AdÄ±nÄ± Kontrol Etme (URL veya Guest) ---
        function checkAndSetUsername() {
            const urlParams = new URLSearchParams(window.location.search);
            const tgUsername = urlParams.get('username');
            const tgId = urlParams.get('id');
            
            if (tgUsername) {
                currentUsername = tgUsername;
                playerNameDisplay.textContent = `HoÅŸ Geldin, @${tgUsername}`;
            } else if (tgId) {
                currentUsername = `User${tgId}`;
                playerNameDisplay.textContent = `HoÅŸ Geldin, ${currentUsername}`;
            } else {
                // Telegram ile giriÅŸ yapmayanlar iÃ§in Misafir adÄ± atama
                currentUsername = generateGuestName(); 
                playerNameDisplay.textContent = `Misafir: ${currentUsername}`;
                // Telegram widget'Ä±nÄ± kaldÄ±r (Misafir giriÅŸi yapÄ±ldÄ±)
                const tgWidget = document.querySelector('[data-telegram-login]');
                if(tgWidget) tgWidget.style.display = 'none';
            }
        }
        checkAndSetUsername(); // Sayfa yÃ¼klendiÄŸinde Ã§alÄ±ÅŸtÄ±r

        // --- SOCKET BAÄžLANTILARI ---

        socket.on('connect', () => {
            statusDiv.textContent = 'âœ… Sunucuya baÄŸlandÄ±.';
            statusDiv.classList.remove('red');
            statusDiv.classList.add('green');

            // KullanÄ±cÄ± adÄ±nÄ± sunucuya bildir
            socket.emit('playerIdentity', { username: currentUsername });
            
            // ButonlarÄ± aktif et
            createBtn.disabled = false;
            joinBtn.disabled = false;
            rankedBtn.disabled = false;
        });

        socket.on('disconnect', () => {
            statusDiv.textContent = 'âŒ Sunucu baÄŸlantÄ±sÄ± kesildi.';
            statusDiv.classList.remove('green');
            statusDiv.classList.add('red');
            
            createBtn.disabled = true;
            joinBtn.disabled = true;
            rankedBtn.disabled = true;
        });
        
        // Sunucudan eÅŸleÅŸme bulundu mesajÄ± (Dereceli lobi iÃ§in kritik)
        socket.on('matchFound', (data) => {
            currentRoomId = data.roomId;
            playerRole = data.role;
            // 'gameStart' olayÄ±nÄ±n hemen ardÄ±ndan gelmesi beklenir.
            statusDiv.textContent = `EÅŸleÅŸme bulundu! Oyun baÅŸlÄ±yor... ðŸŽ‰`;
        });
        
        // Dereceli arama durum gÃ¼ncellemeleri
        socket.on('matchMakingStatus', (message) => {
            statusDiv.textContent = message;
        });

        socket.on('gameStart', (data) => {
            lobbyDiv.classList.remove('active');
            gameDiv.classList.add('active');
            
            const myColor = playerRole === 'player1' ? 'Siyah' : 'Beyaz';
            const opponentName = playerRole === 'player1' ? data.player2Name : data.player1Name;
            
            playerRoleDisplay.textContent = `Siz: ${myColor} | Rakip: ${opponentName}`;
            currentRoomId = currentRoomId || data.roomId; // Dereceli olmayan odalar iÃ§in 
            updateBoard(data.board);
            updateTurn(data.turn);
        });

        socket.on('boardUpdate', (data) => {
            updateBoard(data.board);
            updateTurn(data.turn);
        });

        socket.on('opponentDisconnected', (message) => {
            alert(message);
            resetGame();
        });

        // --- LOBÄ° BUTONLARI ---
        
        // YENÄ°: Dereceli EÅŸleÅŸme Butonu
        rankedBtn.addEventListener('click', () => {
            statusDiv.textContent = 'Dereceli eÅŸleÅŸme aranÄ±yor... LÃ¼tfen bekleyin. â³';
            
            // TÃ¼m lobi butonlarÄ±nÄ± devre dÄ±ÅŸÄ± bÄ±rak
            createBtn.disabled = true;
            joinBtn.disabled = true;
            rankedBtn.disabled = true;
            
            // Sunucuya dereceli lobiye katÄ±lma isteÄŸi gÃ¶nder
            socket.emit('findRankedMatch');
        });

        createBtn.addEventListener('click', () => {
            // Sunucuya oda oluÅŸturma isteÄŸi gÃ¶nder
            socket.emit('createGame', (response) => {
                if (response.success) {
                    currentRoomId = response.roomId;
                    playerRole = response.role;
                    roomCodeDisplay.textContent = `Oda Kodunuz: ${currentRoomId}. Rakip bekleniyor...`;
                    statusDiv.textContent = 'Ã–zel oda baÅŸarÄ±yla oluÅŸturuldu.';
                } else {
                    alert('Oda oluÅŸturulamadÄ±: ' + response.message);
                }
            });
        });

        joinBtn.addEventListener('click', () => {
            const roomId = roomIdInput.value.trim();
            if (roomId.length === 4) {
                // Sunucuya odaya katÄ±lma isteÄŸi gÃ¶nder
                socket.emit('joinGame', { roomId: roomId }, (response) => {
                    if (response.success) {
                        currentRoomId = response.roomId;
                        playerRole = response.role;
                        statusDiv.textContent = 'Odaya baÅŸarÄ±yla katÄ±ldÄ±nÄ±z.';
                        // Oyunun baÅŸlamasÄ± 'gameStart' ile sunucudan gelecek.
                    } else {
                        alert(response.message);
                    }
                });
            } else {
                alert('LÃ¼tfen 4 haneli oda kodu girin.');
            }
        });

        leaveBtn.addEventListener('click', () => {
            // BasitÃ§e yeniden baÄŸlanarak oyundan Ã§Ä±kÄ±ÅŸÄ± simÃ¼le et
            socket.disconnect();
            socket.connect();
            resetGame();
        });

        // --- OYUN ARAYÃœZÃœ VE HAREKET MANTIÄžI ---

        function clearSelections() {
            selectedPiece = null;
            document.querySelectorAll('.piece.selected').forEach(p => p.classList.remove('selected'));
            document.querySelectorAll('.square.possible-move').forEach(s => s.classList.remove('possible-move'));
        }
        
        function handlePieceClick(event) {
            event.stopPropagation();
            const piece = event.currentTarget;
            const square = piece.parentElement;
            const clickedPos = {
                row: parseInt(square.dataset.row),
                col: parseInt(square.dataset.col)
            };
            
            // Hata DÃ¼zeltme: TaÅŸ tipi kontrolÃ¼
            const pieceType = currentBoard[clickedPos.row][clickedPos.col];
            const isMyPiece = (playerRole === 'player1' && (pieceType === 1 || pieceType === 3)) ||
                             (playerRole === 'player2' && (pieceType === 2 || pieceType === 4));
            
            if (currentTurn === playerRole && isMyPiece) {
                clearSelections();
                
                selectedPiece = clickedPos;
                piece.classList.add('selected');

                // Basit bir gÃ¶rsel geri bildirim iÃ§in olasÄ± hamleleri vurgula (GerÃ§ek kural sunucuda)
                // Ä°stemci tarafÄ±nda gerÃ§ek Dama kurallarÄ±nÄ± uygulamak Ã§ok karmaÅŸÄ±k olduÄŸundan 
                // burada sadece boÅŸ kareleri veya uygun zÄ±plama hedeflerini (Ã§ok basitÃ§e) iÅŸaretleyebiliriz.
                
                // Ã–rnek: Ã‡apraz boÅŸ kareleri iÅŸaretle (Sadece gÃ¶rsel amaÃ§lÄ±, kural sunucuda kontrol edilir)
                const directions = pieceType === 3 || pieceType === 4 
                    ? [[-1, -1], [-1, 1], [1, -1], [1, 1]] // Kral
                    : (playerRole === 'player1' ? [[-1, -1], [-1, 1]] : [[1, -1], [1, 1]]); // Normal taÅŸ
                
                directions.forEach(([dr, dc]) => {
                    const r = clickedPos.row + dr;
                    const c = clickedPos.col + dc;
                    if (r >= 0 && r < 8 && c >= 0 && c < 8 && currentBoard[r][c] === 0) {
                        const targetSquare = document.querySelector(`[data-row="${r}"][data-col="${c}"]`);
                        if (targetSquare) targetSquare.classList.add('possible-move');
                    }
                });
            } else {
                clearSelections();
            }
        }
        
        function handleSquareClick(event) {
            const square = event.currentTarget;
            const target = {
                row: parseInt(square.dataset.row),
                col: parseInt(square.dataset.col)
            };

            // EÄŸer bir taÅŸ seÃ§iliyse ve tÄ±klanan kare geÃ§erli bir hamleyse (vurgulanan)
            if (selectedPiece && square.classList.contains('possible-move')) {
                // Hamleyi sunucuya gÃ¶nder
                socket.emit('move', { 
                    roomId: currentRoomId, 
                    from: selectedPiece, 
                    to: target 
                });
                
                // SeÃ§imi temizle
                clearSelections();
            }
            // SeÃ§ili taÅŸ yoksa veya tÄ±klanan kare hamle yeri deÄŸilse bir ÅŸey yapma (taÅŸ seÃ§me iÅŸi taÅŸ tÄ±klamasÄ±na ait)
        }

        // --- ARAYÃœZ GÃœNCELLEME ---

        function updateBoard(board) {
            currentBoard = board;
            boardDiv.innerHTML = '';
            clearSelections(); // Tahta deÄŸiÅŸtiÄŸinde seÃ§imi temizle
            
            for (let r = 0; r < 8; r++) {
                for (let c = 0; c < 8; c++) {
                    const square = document.createElement('div');
                    square.className = `square ${(r + c) % 2 === 0 ? 'light' : 'dark'}`;
                    square.dataset.row = r;
                    square.dataset.col = c;
                    square.addEventListener('click', handleSquareClick); // Kare tÄ±klama
                    
                    const pieceType = board[r][c];
                    if (pieceType !== 0) {
                        const piece = document.createElement('div');
                        let pieceClass = '';
                        let isKing = false;

                        if (pieceType === 1 || pieceType === 3) pieceClass = 'black'; // 1: Siyah, 3: Siyah Kral
                        if (pieceType === 2 || pieceType === 4) pieceClass = 'white'; // 2: Beyaz, 4: Beyaz Kral
                        if (pieceType === 3 || pieceType === 4) isKing = true;
                        
                        piece.className = `piece ${pieceClass} ${isKing ? 'king' : ''}`;
                        piece.addEventListener('click', handlePieceClick); // TaÅŸ tÄ±klama
                        square.appendChild(piece);
                    }

                    boardDiv.appendChild(square);
                }
            }
        }

        function updateTurn(turn) {
            currentTurn = turn;
            const isMyTurn = playerRole === turn;
            
            turnIndicator.textContent = isMyTurn ? 'SIRA SÄ°ZDE! ðŸŸ¢' : 'Rakibinizin sÄ±rasÄ±... ðŸ”´';
            turnIndicator.className = isMyTurn ? 'turn-mine' : 'turn-opponent';
        }

        function resetGame() {
            currentRoomId = null;
            playerRole = null;
            currentBoard = null;
            currentTurn = null;
            clearSelections();
            
            gameDiv.classList.remove('active');
            lobbyDiv.classList.add('active');
            roomCodeDisplay.textContent = '';
            boardDiv.innerHTML = '';
            turnIndicator.textContent = 'SÄ±ra: Bekleniyor...';
            
            // Lobi butonlarÄ±nÄ± tekrar aktif et
            createBtn.disabled = false;
            joinBtn.disabled = false;
            rankedBtn.disabled = false;
        }
        
        // Ä°lk yÃ¼kleme iÃ§in boÅŸ tahtayÄ± gÃ¶ster (sadece gÃ¶rsel)
        updateBoard(Array(8).fill(0).map(() => Array(8).fill(0)));
    </script>
</body>
</html>
