<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Online Dama (Checkers)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.js"></script>
    <style>
        :root {
            --board-size: 8;
            --cell-size: 12.5vw; /* Mobil uyumlu hÃ¼cre boyutu (Viewport Width) */
            --max-cell-size: 70px; /* MasaÃ¼stÃ¼ iÃ§in maksimum boyut */
            --black-cell: #4e342e;
            --white-cell: #ffecb3;
            --highlight-color: #4caf50; 
            --turn-light-color: #ffeb3b;
            --player-1-color: #e53935;
            --player-2-color: #455a64;
            --main-bg: #212121;
            --primary-color: #7cb342; /* Lobi butonu */
            --ranked-color: #fdd835; /* Dereceli butonu */
        }

        /* Temel Stil ve Mobil Uyum */
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: var(--main-bg);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: white;
            padding: 20px 5px;
            box-sizing: border-box;
            overflow-x: hidden;
        }
        
        /* Genel Konteynerler */
        #app-container {
            width: 100%;
            max-width: 550px; /* Maksimum geniÅŸlik sÄ±nÄ±rlamasÄ± */
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 { margin-bottom: 20px; font-size: 2em; }
        
        /* Buton Stilleri ve Animasyonlar */
        button {
            width: 90%;
            max-width: 300px;
            padding: 15px 10px;
            margin: 10px 0;
            font-size: 1.2em;
            cursor: pointer;
            border: none;
            border-radius: 12px;
            color: var(--main-bg);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
            font-weight: bold;
        }
        
        /* Animasyonlu Buton Efektleri */
        button:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
        }
        button:active {
            transform: translateY(-1px) scale(0.98);
        }
        
        #create-lobby, #join-lobby { background-color: var(--primary-color); }
        #rank-match { background-color: var(--ranked-color); }

        /* Ana MenÃ¼ ve Oyun TahtasÄ± GÃ¶rÃ¼nÃ¼rlÃ¼ÄŸÃ¼ */
        #game-screen { display: none; width: 100%; align-items: center; flex-direction: column;}
        #main-menu { display: flex; flex-direction: column; align-items: center; width: 100%; padding-top: 10vh;}
        
        /* Oyun Bilgisi ve BaÄŸlantÄ± Durumu */
        #game-info {
            color: #ccc;
            margin-bottom: 10px;
            font-size: 1.1em;
            text-align: center;
        }
        #connection-status { font-weight: bold; }

        /* Tahta KonumlandÄ±rmasÄ± */
        #board-container {
            max-width: 100vw;
            width: calc(var(--cell-size) * 8);
            margin: 10px auto;
            border: 6px solid #8d6e63;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.7);
            /* MasaÃ¼stÃ¼nde hÃ¼cre boyutunu sÄ±nÄ±rlamak iÃ§in */
            max-width: calc(var(--max-cell-size) * 8 + 12px); 
        }

        #board {
            display: grid;
            grid-template-columns: repeat(var(--board-size), min(var(--cell-size), var(--max-cell-size)));
            grid-template-rows: repeat(var(--board-size), min(var(--cell-size), var(--max-cell-size)));
        }

        .cell {
            /* Mobil cihazlarda 1:1 oranÄ± korumak iÃ§in */
            width: 100%;
            height: 100%; 
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
        }
        .light { background-color: var(--white-cell); }
        .dark { background-color: var(--black-cell); }
        
        /* TaÅŸ Stilleri ve Animasyon */
        .piece {
            width: 80%;
            height: 80%;
            border-radius: 50%;
            box-shadow: 0 3px 5px rgba(0, 0, 0, 0.6);
            border: 2px solid rgba(255, 255, 255, 0.4);
            z-index: 5;
            transition: transform 0.2s ease-out; /* HÄ±zlÄ± animasyon */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .player-1 { background-color: var(--player-1-color); }
        .player-2 { background-color: var(--player-2-color); }
        .king { color: var(--turn-light-color); font-weight: bold; border: 3px solid var(--turn-light-color);}

        /* SeÃ§im ve Hamle GÃ¶stergeleri */
        .selected-piece {
            transform: scale(1.15) translateY(-5px); /* Daha belirgin yÃ¼kselme */
            box-shadow: 0 0 15px 3px var(--highlight-color);
        }
        .valid-move::after {
            content: '';
            position: absolute;
            width: 35%;
            height: 35%;
            border-radius: 50%;
            background-color: var(--highlight-color);
            opacity: 0.9;
            z-index: 10;
        }

        /* SÄ±ra GÃ¶stergesi (Alt ve Ãœst BÃ¶lgeler) */
        .is-turn {
            box-shadow: inset 0 0 8px 1px var(--turn-light-color);
        }
        .player-turn-light {
            box-shadow: 0 0 15px var(--turn-light-color);
            border: 1px solid var(--turn-light-color);
        }
    </style>
</head>
<body>
    <div id="app-container">
        <h1>Online Dama ðŸ‘‘</h1>

        <div id="connection-indicator">
            <span id="connection-status">BaÄŸlanÄ±yor...</span>
        </div>

        <div id="main-menu">
            <h2>Hemen BaÅŸla</h2>
            <button id="rank-match">ðŸ‘‘ Dereceli Oyna</button>
            <hr style="width: 70%; border-color: #333; margin: 20px 0;">
            <h2>Ã–zel Oda</h2>
            <button id="create-lobby">ðŸ”— Lobi Kur</button>
            <button id="join-lobby">ðŸšª Odaya KatÄ±l</button>
        </div>

        <div id="game-screen">
            <div id="game-info">
                Oda: <span id="lobby-id-text">---</span> | SÄ±ra: <span id="current-player-text">Bekleniyor...</span>
            </div>
            
            <div id="board-container">
                <div id="board">
                    </div>
            </div>
        </div>
    </div>

    <script>
        // *** CONFIGURATION ***
        // Render sunucu adresi
        const SERVER_URL = 'https://mario-io-1.onrender.com'; 
        const socket = io(SERVER_URL);
        const boardSize = 8;
        
        // *** DOM ELEMENTS ***
        const mainMenu = document.getElementById('main-menu');
        const gameScreen = document.getElementById('game-screen');
        const board = document.getElementById('board');
        const currentPlayerText = document.getElementById('current-player-text');
        const connectionStatus = document.getElementById('connection-status');
        const lobbyIdText = document.getElementById('lobby-id-text');
        
        // *** GAME STATE ***
        let selectedPiece = null;
        let currentPlayer = 1; 
        let playerRole = 0; // 1 veya 2 (Bu istemcide oynayan oyuncu)
        let lobbyId = null;
        let isMyTurn = false;
        
        // Tahta baÅŸlangÄ±Ã§ durumu
        let gameState = [
            [0, 2, 0, 2, 0, 2, 0, 2], // 2 = Oyuncu 2
            [2, 0, 2, 0, 2, 0, 2, 0],
            [0, 2, 0, 2, 0, 2, 0, 2],
            [0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0],
            [1, 0, 1, 0, 1, 0, 1, 0], // 1 = Oyuncu 1
            [0, 1, 0, 1, 0, 1, 0, 1],
            [1, 0, 1, 0, 1, 0, 1, 0]
        ];
        
        // **********************************
        // *** GÃ–RSEL VE AKIÅž YÃ–NETÄ°MÄ° ***
        // **********************************
        
        function showGameScreen() {
            mainMenu.style.display = 'none';
            gameScreen.style.display = 'flex';
        }

        function createBoard(state) {
            board.innerHTML = '';
            for (let r = 0; r < boardSize; r++) {
                for (let c = 0; c < boardSize; c++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell ' + (((r + c) % 2 === 0) ? 'light' : 'dark');
                    cell.dataset.row = r;
                    cell.dataset.col = c;
                    cell.addEventListener('click', handleCellClick);
                    
                    placePiece(cell, state[r][c]);
                    board.appendChild(cell);
                }
            }
            updateTurnLight();
        }

        function placePiece(cell, pieceOwner) {
            cell.innerHTML = ''; 
            if (pieceOwner > 0) {
                const piece = document.createElement('div');
                piece.className = `piece player-${pieceOwner}`;
                piece.dataset.owner = pieceOwner;
                // 3 ve 4 King varsayÄ±lÄ±yor
                if (pieceOwner > 2) piece.classList.add('king'); 
                piece.textContent = piece.classList.contains('king') ? 'â™”' : ''; 
                cell.appendChild(piece);
            }
        }

        function updateGameInfo() {
             lobbyIdText.textContent = lobbyId || "---";
             const roleText = (playerRole === 1) ? 'KÄ±rmÄ±zÄ± (Siz)' : (playerRole === 2) ? 'Gri (Siz)' : '';
             currentPlayerText.textContent = `Oyuncu ${currentPlayer} (${roleText})`;
        }

        function updateTurnLight() {
            document.querySelectorAll('.cell').forEach(cell => {
                cell.classList.remove('is-turn', 'player-turn-light');
            });
            
            // SÄ±ra kimdeyse, o oyuncunun tarafÄ±ndaki koyu hÃ¼creleri Ä±ÅŸÄ±klandÄ±r
            const targetCells = (currentPlayer === 1) 
                ? Array.from(document.querySelectorAll('.cell[data-row="5"], .cell[data-row="6"], .cell[data-row="7"]'))
                : Array.from(document.querySelectorAll('.cell[data-row="0"], .cell[data-row="1"], .cell[data-row="2"]'));
            
            targetCells.forEach(cell => {
                if (cell.classList.contains('dark')) {
                    cell.classList.add('is-turn', 'player-turn-light');
                }
            });
            updateGameInfo();
        }

        // --- ANIMASYON: TAÅžIN KAYMASI ---
        function applyMoveAndAnimate(fromR, fromC, toR, toC, isOpponent = false) {
            const oldCell = board.querySelector(`[data-row="${fromR}"][data-col="${fromC}"]`);
            const newCell = board.querySelector(`[data-row="${toR}"][data-col="${toC}"]`);
            const movingPiece = oldCell ? oldCell.querySelector('.piece') : null;
            
            if (!movingPiece) return;

            // 1. Oyun Durumunu GÃ¼ncelle
            const pieceOwner = gameState[fromR][fromC];
            gameState[toR][toC] = pieceOwner;
            gameState[fromR][fromC] = 0;

            // 2. DOM Transferi (CSS transition ile animasyonlu hareket efekti)
            oldCell.removeChild(movingPiece);
            newCell.appendChild(movingPiece);
            
            // Kral yapma kontrolÃ¼
            if ((toR === 0 && pieceOwner === 1) || (toR === 7 && pieceOwner === 2)) {
                movingPiece.classList.add('king');
                movingPiece.textContent = 'â™”';
                gameState[toR][toC] = (pieceOwner === 1) ? 3 : 4; // Kral durumu
            }

            // SÄ±rayÄ± deÄŸiÅŸtir
            if (!isOpponent) {
                currentPlayer = (currentPlayer === 1) ? 2 : 1;
                isMyTurn = false; // Hamleniz bitti
            } else {
                 currentPlayer = (currentPlayer === 1) ? 2 : 1;
                 isMyTurn = true; // Rakip oynadÄ±ÄŸÄ± iÃ§in sÄ±ra size geÃ§ti
            }
            clearHighlights();
            updateTurnLight();
        }

        // Basit Hamle KontrolÃ¼ (Sadece GÃ¶rsel AmaÃ§lÄ±dÄ±r, GerÃ§ek Kontrol Sunucuda OlmalÄ±)
        function getValidMoves(r, c, pieceOwner, isKing) {
            const moves = [];
            const directions = (pieceOwner === 1) ? [-1] : [1]; 
            if (isKing) directions.push(1, -1); 

            for (const direction of directions) {
                const nextRow = r + direction;
                if (nextRow >= 0 && nextRow < boardSize) {
                    // Sol Ã§apraz
                    if (c - 1 >= 0 && gameState[nextRow][c - 1] === 0) {
                        moves.push({ row: nextRow, col: c - 1 });
                    }
                    // SaÄŸ Ã§apraz
                    if (c + 1 < boardSize && gameState[nextRow][c + 1] === 0) {
                        moves.push({ row: nextRow, col: c + 1 });
                    }
                }
            }
            return moves;
        }

        function clearHighlights() {
            document.querySelectorAll('.selected-piece').forEach(p => p.classList.remove('selected-piece'));
            document.querySelectorAll('.valid-move').forEach(cell => cell.classList.remove('valid-move'));
        }
        
        
        // **********************************
        // *** SOCKET.IO Ä°LETÄ°ÅžÄ°M KISMI ***
        // **********************************

        socket.on('connect', () => {
            connectionStatus.textContent = `Online (${socket.id.substring(0, 4)}...)`;
            connectionStatus.style.color = '#76ff03';
            console.log(`Sunucuya baÄŸlandÄ±: ${socket.id}`);
        });

        socket.on('disconnect', () => {
            connectionStatus.textContent = 'BaÄŸlantÄ± Kesildi!';
            connectionStatus.style.color = '#ff1744';
            alert("Sunucu baÄŸlantÄ±sÄ± kesildi veya oyundan dÃ¼ÅŸtÃ¼nÃ¼z.");
        });
        
        socket.on('lobby_created', (data) => {
            lobbyId = data.lobbyId;
            playerRole = data.playerRole;
            alert(`Lobi Kuruldu! Kod: ${lobbyId}. Rakibinizi bekliyor.`);
            showGameScreen();
            updateGameInfo();
        });

        socket.on('lobby_joined', (data) => {
            lobbyId = data.lobbyId;
            playerRole = data.playerRole;
            alert(`Odaya KatÄ±ldÄ±nÄ±z! Kod: ${lobbyId}. Rakibinizle karÅŸÄ±laÅŸacaksÄ±nÄ±z.`);
            showGameScreen();
            updateGameInfo();
        });
        
        socket.on('player2_joined', (username) => {
            alert(`Rakip katÄ±ldÄ±: ${username}. Oyun baÅŸlÄ±yor!`);
        });

        // Oyun BaÅŸladÄ± (Lobi veya Dereceli EÅŸleÅŸme SonrasÄ±)
        socket.on('game_start', (data) => {
            gameState = data.initialState; // Sunucudan gelen baÅŸlangÄ±Ã§ durumu
            currentPlayer = data.turn;
            isMyTurn = (playerRole === currentPlayer);
            
            createBoard(gameState);
            updateTurnLight();
            if (isMyTurn) alert("SÄ±ra sizde!");
        });

        socket.on('rank_match_start', (data) => {
            lobbyId = data.lobbyId;
            playerRole = data.playerRole;
            alert(`ðŸ‘‘ Dereceli EÅŸleÅŸme Bulundu! Oda: ${lobbyId}.`);
            showGameScreen();
        });
        
        socket.on('waiting_for_opponent', (message) => {
            alert(message);
        });

        // Rakip Hamle YaptÄ±
        socket.on('opponent_moved', (move) => {
            applyMoveAndAnimate(move.from.r, move.from.c, move.to.r, move.to.c, true);
        });
        
        socket.on('opponent_disconnected', (message) => {
            alert(message);
        });
        
        socket.on('error', (message) => {
            alert("Hata: " + message);
        });
        
        // **********************************
        // *** OYUN Ä°Ã‡Ä° ETKÄ°LEÅžÄ°M ***
        // **********************************

        function handleCellClick(event) {
            if (!isMyTurn || !lobbyId) {
                if(lobbyId) console.log("SÄ±ra sizde deÄŸil!");
                else alert("Ã–nce bir oyuna katÄ±lÄ±n!");
                return;
            }

            const cell = event.currentTarget;
            const r = parseInt(cell.dataset.row);
            const c = parseInt(cell.dataset.col);
            const piece = cell.querySelector('.piece');

            clearHighlights(); 

            // 1. TaÅŸ SeÃ§me
            if (piece && parseInt(piece.dataset.owner) === currentPlayer && parseInt(piece.dataset.owner) === playerRole) {
                selectedPiece = { r, c, piece: piece };
                piece.classList.add('selected-piece'); 

                // GeÃ§erli hamleleri gÃ¶ster (GÃ¶rsel ipucu)
                const isKing = piece.classList.contains('king');
                const moves = getValidMoves(r, c, currentPlayer, isKing); 
                
                moves.forEach(move => {
                    const targetCell = board.querySelector(`[data-row="${move.row}"][data-col="${move.col}"]`);
                    targetCell.classList.add('valid-move');
                });
            }
            // 2. Hamle Yapma ve Sunucuya GÃ¶nderme
            else if (selectedPiece && cell.classList.contains('valid-move')) {
                const fromR = selectedPiece.r;
                const fromC = selectedPiece.c;
                const toR = r;
                const toC = c;
                
                // Hamleyi sunucuya gÃ¶nder
                socket.emit('make_move', { 
                    lobbyId: lobbyId, 
                    move: { from: {r: fromR, c: fromC}, to: {r: toR, c: toC} }
                });

                // Kendi tahtanÄ±zda hamleyi uygulayÄ±n ve animasyonu baÅŸlatÄ±n (Rakip beklemesin)
                applyMoveAndAnimate(fromR, fromC, toR, toC, false);
            }
            // 3. GeÃ§ersiz TÄ±klama
            else {
                selectedPiece = null;
            }
        }
        
        // **********************************
        // *** LOBÄ° BUTONLARI ***
        // **********************************

        document.getElementById('create-lobby').addEventListener('click', () => {
            if (lobbyId) { alert("Zaten bir oyuna katÄ±lmÄ±ÅŸsÄ±nÄ±z!"); return; }
            const username = prompt("KullanÄ±cÄ± adÄ±nÄ±z (Ã–rn: Oyuncu1):");
            if (username && socket.connected) {
                socket.emit('create_lobby', username);
            } else if (!socket.connected) {
                alert("BaÄŸlantÄ± bekleniyor... Tekrar deneyin.");
            }
        });

        document.getElementById('join-lobby').addEventListener('click', () => {
            if (lobbyId) { alert("Zaten bir oyuna katÄ±lmÄ±ÅŸsÄ±nÄ±z!"); return; }
            const lobbyCode = prompt("Oda kodunu girin (Ã–rn: A1B2):");
            const username = prompt("KullanÄ±cÄ± adÄ±nÄ±z (Ã–rn: Oyuncu2):");
            if (lobbyCode && username && socket.connected) {
                socket.emit('join_lobby', { lobbyId: lobbyCode.toUpperCase(), username: username });
            } else if (!socket.connected) {
                alert("BaÄŸlantÄ± bekleniyor... Tekrar deneyin.");
            }
        });

        document.getElementById('rank-match').addEventListener('click', () => {
             if (lobbyId) { alert("Zaten bir oyuna katÄ±lmÄ±ÅŸsÄ±nÄ±z!"); return; }
            const username = prompt("KullanÄ±cÄ± adÄ±nÄ±z (Dereceli):");
            if (username && socket.connected) {
                alert("Dereceli eÅŸleÅŸme aranÄ±yor... LÃ¼tfen bekleyiniz.");
                socket.emit('start_rank_match', username);
            } else if (!socket.connected) {
                alert("BaÄŸlantÄ± bekleniyor... Tekrar deneyin.");
            }
        });


    </script>
</body>
</html>
