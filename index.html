<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Online Dama Oyunu</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>

    <style>
        /* --- TasarÄ±m ve Animasyonlar (Ã–nceki yanÄ±ttaki CSS aynÄ± kalÄ±r) --- */
        :root {
            --primary-color: #3498db; 
            --secondary-color: #2ecc71; 
            --tertiary-color: #e74c3c; 
            --dark-bg: #1e2a38; 
            --card-bg: #2c3e50; 
            --square-light: #f5f5dc;
            --square-dark: #8b4513;
        }

        body { font-family: 'Roboto', sans-serif; background: linear-gradient(135deg, var(--dark-bg), #141c24); color: #fff; margin: 0; height: 100vh; overflow: hidden; display: flex; justify-content: center; align-items: center; }
        
        #app-container { width: 100%; height: 100%; max-width: none; max-height: none; padding: 10px; box-sizing: border-box; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        
        .screen { display: none; width: 90%; max-width: 550px; }
        .screen.active { display: block; }
        
        /* LOBÄ° STÄ°LÄ° */
        #lobby { background: var(--card-bg); padding: 40px 30px; border-radius: 15px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6); animation: fadeIn 0.8s ease-out; border: 1px solid rgba(255, 255, 255, 0.1); }
        @keyframes fadeIn { 0% { opacity: 0; transform: translateY(20px); } 100% { opacity: 1; transform: translateY(0); } }

        .logo-text { font-size: 3.5em; margin-bottom: 5px; font-weight: 900; letter-spacing: 2px; text-shadow: 3px 3px #000; }
        .logo-span { color: var(--primary-color); }
        .info-text { margin-top: 10px; font-size: 1em; opacity: 0.9; }
        #status { color: var(--tertiary-color); font-weight: bold; }
        #status.green { color: var(--secondary-color); }
        
        /* Butonlar */
        .main-btn, .secondary-btn { padding: 14px 25px; margin: 10px; border: none; border-radius: 10px; cursor: pointer; font-size: 1.1em; font-weight: 700; transition: all 0.3s cubic-bezier(.25,.8,.25,1); box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3); }
        .main-btn { background-color: var(--primary-color); color: #fff; }
        .main-btn:hover:not(:disabled) { background-color: #2980b9; transform: translateY(-3px); box-shadow: 0 8px 10px rgba(0, 0, 0, 0.4); }
        .main-btn:disabled { background-color: #55606d; cursor: not-allowed; color: #bbb; }
        .main-btn.red-btn { background-color: var(--tertiary-color); color: white; }

        /* Overlay'ler ve Oyun TahtasÄ± stilleri aynÄ± kalÄ±r */
        .sub-screen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); display: none; justify-content: center; align-items: center; z-index: 100; }
        .sub-screen-content { background: var(--card-bg); padding: 40px; border-radius: 15px; box-shadow: 0 0 50px rgba(0, 0, 0, 0.9); text-align: center; animation: slideUp 0.4s ease-out; }
        @keyframes slideUp { 0% { opacity: 0; transform: translateY(50px); } 100% { opacity: 1; transform: translateY(0); } }
        .sub-screen-overlay.active { display: flex; }
        
        #currentRoomCode span { font-size: 2.5em; color: var(--secondary-color); font-weight: 900; letter-spacing: 5px; display: block; margin: 10px 0; text-shadow: 1px 1px #000; }
        #board { width: 95vmin; height: 95vmin; max-width: 450px; max-height: 450px; margin: 20px auto; border: 5px solid var(--primary-color); box-shadow: 0 0 20px rgba(0, 0, 0, 0.5); transition: transform 0.5s; }
        #board.player2-view { transform: rotate(180deg); }
        #board.player2-view .piece { transform: rotate(180deg); }
        .piece.selected { box-shadow: 0 0 15px var(--secondary-color), 0 0 5px var(--secondary-color); }

        @media (max-width: 600px) {
            #lobby { padding: 30px 15px; }
            .logo-text { font-size: 2.5em; }
            .main-btn, .secondary-btn { padding: 12px 18px; font-size: 1em; }
            #board { width: 98vmin; height: 98vmin; }
        }
    </style>
</head>
<body>
    <div id="app-container">
        <div id="lobby" class="screen active">
            <h1 class="logo-text">CHEC<span class="logo-span">KERS</span> ONLINE</h1>
            <p id="status" class="info-text">Sunucuya baÄŸlanÄ±lÄ±yor...</p>
            
            <div id="auth-status">
                <p id="player-name" style="font-weight: bold; color: var(--secondary-color); margin-top: 20px;">GiriÅŸ YapÄ±lÄ±yor...</p>
            </div>
            
            <div class="lobby-controls">
                <button id="rankedBtn" class="main-btn" disabled>
                    <i class="fas fa-medal"></i> Dereceli EÅŸleÅŸme Bul
                </button>

                <button id="createGameBtn" class="main-btn" disabled>
                    <i class="fas fa-plus-circle"></i> Oda Kur
                </button>
                
                <button id="showJoinBtn" class="main-btn" disabled>
                    <i class="fas fa-sign-in-alt"></i> Odaya KatÄ±l
                </button>
            </div>
        </div>
        
        <div id="game" class="screen">
            <div class="game-header">
                <p id="playerRoleDisplay" class="role-text" style="font-size: 1.1em; font-weight: bold;"></p>
                <h2 id="turnIndicator" style="margin: 10px 0;">SÄ±ra: Bekleniyor...</h2>
                <button id="leaveBtn" class="secondary-btn red-btn"><i class="fas fa-times-circle"></i> AyrÄ±l</button>
            </div>
            
            <div class="board-wrapper">
                <div id="board">
                </div>
            </div>
        </div>
    </div>

    <div id="createOverlay" class="sub-screen-overlay">
        <div class="sub-screen-content">
            <h3><i class="fas fa-door-open"></i> Yeni Oda Kuruldu</h3>
            <p id="currentRoomCode" class="info-text">Oda Kodu: <span>****</span></p>
            <p id="createStatus" class="info-text">Rakip bekleniyor...</p>
            <button id="cancelCreateBtn" class="secondary-btn red-btn"><i class="fas fa-times"></i> Ä°ptal Et/Kapat</button>
        </div>
    </div>

    <div id="joinOverlay" class="sub-screen-overlay">
        <div class="sub-screen-content">
            <h3><i class="fas fa-sign-in-alt"></i> Odaya KatÄ±l</h3>
            <input type="text" id="roomIdInput" placeholder="4 Haneli Oda Kodunu Girin" maxlength="4" style="font-size: 1.5em; width: 100%; text-align: center;">
            <button id="joinBtn" class="main-btn" style="margin-top: 15px;"><i class="fas fa-check"></i> KatÄ±l</button>
            <button id="cancelJoinBtn" class="secondary-btn red-btn"><i class="fas fa-times"></i> Ä°ptal</button>
        </div>
    </div>

    <div id="matchmakingOverlay" class="sub-screen-overlay">
        <div class="sub-screen-content">
            <h3><i class="fas fa-search"></i> Dereceli EÅŸleÅŸme AranÄ±yor</h3>
            <div class="spinner" style="border: 8px solid rgba(255, 255, 255, 0.1); border-top: 8px solid var(--primary-color); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin-bottom: 20px;"></div>
            <p id="matchmakingStatusText" class="info-text" style="font-size: 1.2em;">Kuyrukta bekleniyor...</p>
            <button id="cancelRankedBtn" class="main-btn red-btn" style="margin-top: 15px;"><i class="fas fa-times"></i> AramayÄ± Ä°ptal Et</button>
        </div>
    </div>

    <script>
        // LÃ¼tfen burayÄ± KENDÄ° Ã‡ALIÅžAN SUNUCU ADRESÄ°NÄ°ZLE DEÄžÄ°ÅžTÄ°RÄ°N!
        const SERVER_URL = 'https://mario-io-1.onrender.com'; 
        const socket = io(SERVER_URL);

        // --- DOM Elementleri ve DeÄŸiÅŸkenler ---
        // (AynÄ± kalÄ±r)

        const lobbyDiv = document.getElementById('lobby');
        const gameDiv = document.getElementById('game');
        const statusDiv = document.getElementById('status');
        const boardDiv = document.getElementById('board');
        const turnIndicator = document.getElementById('turnIndicator');
        const playerNameDisplay = document.getElementById('player-name');
        const rankedBtn = document.getElementById('rankedBtn');
        const createGameBtn = document.getElementById('createGameBtn');
        const showJoinBtn = document.getElementById('showJoinBtn');
        const leaveBtn = document.getElementById('leaveBtn');

        const createOverlay = document.getElementById('createOverlay');
        const currentRoomCode = document.getElementById('currentRoomCode').querySelector('span');
        const cancelCreateBtn = document.getElementById('cancelCreateBtn');
        const joinOverlay = document.getElementById('joinOverlay');
        const roomIdInput = document.getElementById('roomIdInput');
        const joinBtn = document.getElementById('joinBtn');
        const cancelJoinBtn = document.getElementById('cancelJoinBtn');
        const matchmakingOverlay = document.getElementById('matchmakingOverlay');
        const cancelRankedBtn = document.getElementById('cancelRankedBtn');
        const matchmakingStatusText = document.getElementById('matchmakingStatusText');

        let currentRoomId = null;
        let playerRole = null;
        let currentBoard = null;
        let currentTurn = null;
        let currentUsername = null; 
        let selectedPiece = null; 
        
        // --- Telegram ve Misafir KullanÄ±cÄ± AdÄ± YÃ¶netimi (AynÄ± kalÄ±r) ---
        function generateGuestName() {
            const randomNumber = Math.floor(Math.random() * 900) + 100;
            return `Guest${randomNumber}`;
        }

        function checkAndSetUsername() {
            const urlParams = new URLSearchParams(window.location.search);
            const tgId = urlParams.get('id'); 
            const tgUsername = urlParams.get('username'); 
            
            if (tgUsername) {
                currentUsername = `@${tgUsername}`;
                playerNameDisplay.textContent = `HoÅŸ Geldin, ${currentUsername}`;
            } else if (tgId) {
                currentUsername = `User_${tgId}`;
                playerNameDisplay.textContent = `HoÅŸ Geldin, ${currentUsername}`;
            } else {
                currentUsername = generateGuestName(); 
                playerNameDisplay.textContent = `Misafir: ${currentUsername}`;
            }
        }
        checkAndSetUsername(); 
        
        // --- YARDIMCI FONKSÄ°YONLAR ---
        function setLobbyButtons(enabled) {
            rankedBtn.disabled = !enabled;
            createGameBtn.disabled = !enabled;
            showJoinBtn.disabled = !enabled;
        }

        function toggleOverlay(overlayElement, show) {
            // Overlay aÃ§Ä±ldÄ±ÄŸÄ±nda tÃ¼m lobi butonlarÄ±nÄ± devre dÄ±ÅŸÄ± bÄ±rak
            if (show) {
                overlayElement.classList.add('active');
                lobbyDiv.style.transform = 'scale(0.9)';
                setLobbyButtons(false);
            } else {
                overlayElement.classList.remove('active');
                lobbyDiv.style.transform = 'scale(1)';
                // Sadece arama yapÄ±lmÄ±yorsa butonlarÄ± aÃ§
                if (socket.connected && !matchmakingOverlay.classList.contains('active')) {
                    setLobbyButtons(true);
                }
            }
        }

        function resetGame() {
            currentRoomId = null;
            playerRole = null;
            currentBoard = null;
            currentTurn = null;
            clearSelections();
            
            gameDiv.classList.remove('active');
            lobbyDiv.classList.add('active');
            turnIndicator.textContent = 'SÄ±ra: Bekleniyor...';
            boardDiv.classList.remove('player2-view');
            
            toggleOverlay(matchmakingOverlay, false);
            toggleOverlay(createOverlay, false);
            toggleOverlay(joinOverlay, false);
            
            if(socket.connected) {
                setLobbyButtons(true);
            }
        }
        
        // --- SOCKET BAÄžLANTILARI ---

        socket.on('connect', () => {
            statusDiv.textContent = 'âœ… Sunucuya baÄŸlanÄ±lÄ±yor...'; // Durum gÃ¼ncellendi
            statusDiv.classList.add('green');
            // BaÄŸlandÄ±ktan sonra kimliÄŸi hemen sunucuya gÃ¶nder
            socket.emit('playerIdentity', { username: currentUsername });
            resetGame(); 
        });

        // YENÄ°: Sunucudan "hazÄ±r" onayÄ± geldiÄŸinde butonlarÄ± aÃ§
        socket.on('readyToPlay', () => {
            statusDiv.textContent = 'âœ… Sunucuya baÄŸlandÄ±.';
            setLobbyButtons(true);
        });

        socket.on('connect_error', (err) => {
            statusDiv.textContent = `âŒ BaÄŸlantÄ± hatasÄ±: ${err.message}. Adres: ${SERVER_URL}`;
            statusDiv.classList.remove('green');
            setLobbyButtons(false);
        });

        socket.on('disconnect', () => {
            statusDiv.textContent = 'âŒ Sunucu baÄŸlantÄ±sÄ± kesildi.';
            statusDiv.classList.remove('green');
            setLobbyButtons(false);
            if(gameDiv.classList.contains('active')) {
                alert('Sunucu baÄŸlantÄ±sÄ± kesildi. LÃ¼tfen sayfayÄ± yenileyin.');
                resetGame();
            }
        });

        // EÅŸleÅŸme Bulundu (matchFound) geldiÄŸinde overlay'i kapat ve durumu hazÄ±rla.
        socket.on('matchFound', (data) => {
            toggleOverlay(matchmakingOverlay, false);
            currentRoomId = data.roomId;
            playerRole = data.role;
            statusDiv.textContent = `EÅŸleÅŸme bulundu! Oyun baÅŸlÄ±yor... ðŸŽ‰`;
        });
        
        // Oyun BaÅŸladÄ± (gameStart) geldiÄŸinde oyunu baÅŸlat.
        socket.on('gameStart', (data) => {
            // ... (Ã–nceki yanÄ±ttaki gameStart mantÄ±ÄŸÄ± aynÄ± kalÄ±r) ...
            lobbyDiv.classList.remove('active');
            gameDiv.classList.add('active');
            toggleOverlay(createOverlay, false); 
            toggleOverlay(joinOverlay, false);

            const myColor = playerRole === 'player1' ? 'Siyah' : 'Beyaz';
            const opponentName = playerRole === 'player1' ? data.player2Name : data.player1Name;
            
            playerRoleDisplay.textContent = `Siz: ${myColor} | Rakip: ${opponentName}`;
            currentRoomId = currentRoomId || data.roomId;
            updateBoard(data.board);
            updateTurn(data.turn);

            if (playerRole === 'player2') {
                boardDiv.classList.add('player2-view');
            } else {
                boardDiv.classList.remove('player2-view');
            }
        });

        // DiÄŸer olaylar (boardUpdate, invalidMove, gameOver, opponentDisconnected) aynÄ± kalÄ±r.
        // ...
        
        // --- LOBÄ° KONTROL OLAYLARI ---

        // Dereceli Arama BaÅŸlat
        rankedBtn.addEventListener('click', () => {
            toggleOverlay(matchmakingOverlay, true);
            matchmakingStatusText.textContent = 'EÅŸleÅŸme aranÄ±yor...';
            socket.emit('findRankedMatch');
        });

        // Oda Kurma
        createGameBtn.addEventListener('click', () => {
            toggleOverlay(createOverlay, true);
            currentRoomCode.textContent = '....'; 

            socket.emit('createGame', (response) => {
                if (response.success) {
                    currentRoomId = response.roomId;
                    playerRole = response.role;
                    currentRoomCode.textContent = currentRoomId; 
                    document.getElementById('createStatus').textContent = 'Rakip bekleniyor...';
                } else {
                    currentRoomCode.textContent = 'HATA';
                    document.getElementById('createStatus').textContent = 'Oda kurulamadÄ±: ' + response.message;
                }
            });
        });

        // ... (Kalan buton olaylarÄ± ve oyun mantÄ±ÄŸÄ± fonksiyonlarÄ± aynÄ± kalÄ±r) ...
        
        // Ä°lk tahtayÄ± Ã§iz
        updateBoard(Array(8).fill(0).map(() => Array(8).fill(0)));
    </script>
</body>
</html>
