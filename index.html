<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PROFESYONEL KRÄ°PTO SÄ°MÃœLASYONU | Telegram GiriÅŸli</title>
    
    <style>
        /* ------------------------------------------- */
        /* BINANCE TARZI CSS STÄ°LLERÄ° */
        /* ------------------------------------------- */
        body {
            font-family: 'Open Sans', Arial, sans-serif;
            background-color: #1e2329;
            color: #eaecef;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            overflow: hidden;
        }

        .grafik-kapsayici {
            background-color: #131722;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            width: 95%;
            max-width: 1000px;
            display: flex;
            flex-direction: column;
        }

        .baslik {
            color: #f0b90b;
            font-size: 1.8em;
            text-align: left;
            margin-bottom: 20px;
            border-bottom: 1px solid #2b3137;
            padding-bottom: 10px;
        }

        #grafikAlani {
            position: relative;
            border: 1px solid #2b3137;
            border-radius: 4px;
            overflow: hidden;
            background-color: #131722;
            flex-grow: 1;
        }
        
        #kriptoGrafik, #hacimGrafik {
            display: block;
            position: absolute;
            left: 0;
        }
        #kriptoGrafik { top: 0; }
        #hacimGrafik { bottom: 0; border-top: 1px solid #2b3137; }

        .fiyat-etiketi {
            position: absolute;
            right: 0;
            padding: 5px 10px;
            background-color: #131722;
            border: 1px solid #f0b90b;
            color: #f0b90b;
            font-weight: bold;
            font-size: 1.1em;
            z-index: 10;
            transition: top 0.1s linear;
        }

        .y-ekseni-etiketleri {
            position: absolute;
            right: 0;
            height: 100%;
            width: 80px;
            color: #8f959e;
            font-size: 0.8em;
            pointer-events: none;
            z-index: 5;
        }
        .y-ekseni-etiketleri div {
            position: absolute;
            right: 5px;
            transform: translateY(-50%);
            border-bottom: 1px dashed #2b3137;
            white-space: nowrap;
        }
        
        .kontrol-alani {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding: 15px;
            background-color: #1e2329;
            border-radius: 6px;
        }

        .bakiye-gosterge p { font-size: 1.1em; font-weight: bold; }
        .bakiye-deger { color: #f0b90b; margin-left: 10px; font-size: 1.4em; }

        .bahis-alani, .liderlik-kontrol { display: flex; gap: 10px; align-items: center; }

        #bahisMiktari { padding: 10px; border: 1px solid #2b3137; border-radius: 4px; background-color: #2b3137; color: #eaecef; width: 100px; text-align: center; }

        .btn-bahis { padding: 10px 15px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; transition: background-color 0.2s; }
        .yukselis { background-color: #03a66d; color: #fff; }
        .dusme { background-color: #ea3943; color: #fff; }
        .kapat-btn { background-color: #f0b90b; color: #131722; margin-left: 15px; }
        .btn-bahis:disabled { background-color: #3e444b; cursor: not-allowed; color: #8f959e; }

        .pozisyon-bilgi {
            margin-top: 20px;
            padding: 10px;
            background-color: #2b3137;
            border-radius: 4px;
            display: flex;
            justify-content: space-around;
            font-size: 0.9em;
        }
        
        #pozisyonDurumu { color: #f0b90b; font-weight: bold; }
        .kar { color: #03a66d; }
        .zarar { color: #ea3943; }

        .uyari { margin-top: 15px; color: #f0b90b; text-align: center; font-size: 0.8em; border-top: 1px dashed #2b3137; padding-top: 10px; }

        /* GÄ°RÄ°Å EKRANI VE MODAL STÄ°LLERÄ° */
        #girisEkrani {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #1e2329; display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 100; text-align: center;
        }
        #girisEkrani h2 { color: #f0b90b; margin-bottom: 30px; }
        #oyunKapsayici { display: none; }
        
        .modal { display: none; position: fixed; z-index: 200; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.8); }
        .modal-icerik { background-color: #131722; margin: 10% auto; padding: 30px; border: 1px solid #2b3137; width: 80%; max-width: 500px; border-radius: 8px; box-shadow: 0 0 20px rgba(240, 185, 11, 0.2); }
        #liderlikBaslik { color: #f0b90b; text-align: center; margin-bottom: 20px; }
        .kapat-buton { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        #leaderboardTablo { width: 100%; border-collapse: collapse; color: #eaecef; }
        #leaderboardTablo th, #leaderboardTablo td { padding: 10px; text-align: left; border-bottom: 1px solid #2b3137; }
        #leaderboardTablo th { color: #f0b90b; background-color: #1e2329; }
        .sira-bir td { background-color: rgba(240, 185, 11, 0.2); color: #f0b90b; font-weight: bold; font-size: 1.1em; }

    </style>
</head>
<body>
    
    <div id="girisEkrani">
        <h2>Telegram ile GiriÅŸ YapÄ±n ve Sanal Bakiyenizi YÃ¶netin!</h2>
        <p style="color: #eaecef;">(SimÃ¼lasyon Ä°Ã§in AÅŸaÄŸÄ±daki Butona TÄ±klayÄ±n)</p>
        <button onclick="simuleGiris(1234567, 'TestUser')" style="padding: 15px 30px; font-size: 1.2em; background-color: #0088cc; color: white; border: none; border-radius: 8px; cursor: pointer;">
            SimÃ¼le Telegram GiriÅŸi
        </button>
    </div>

    <div class="grafik-kapsayici" id="oyunKapsayici">
        <h1 class="baslik">FAKE COIN (FKN/USDT) | KaldÄ±raÃ§lÄ± Ä°ÅŸlem SimÃ¼lasyonu</h1>
        
        <div id="grafikAlani" style="height: 480px;">
            <canvas id="kriptoGrafik" width="950" height="380"></canvas>
            <canvas id="hacimGrafik" width="950" height="100"></canvas>
            <div id="canliFiyatEtiketi" class="fiyat-etiketi">$50,000.00</div>
            <div id="yEkseniEtiketleri" class="y-ekseni-etiketleri"></div>
        </div>
        
        <div class="kontrol-alani">
            <div class="bakiye-gosterge">
                <p>SANAL BAKÄ°YE: <span id="sanalBakiye" class="bakiye-deger">$10,000.00</span></p>
            </div>
            
            <div class="bahis-alani">
                <input type="number" id="bahisMiktari" value="100" min="1" placeholder="Bahis MiktarÄ±">
                <button id="btnYukselis" class="btn-bahis yukselis">ğŸ“ˆ LONG (AL)</button>
                <button id="btnDusme" class="btn-bahis dusme">ğŸ“‰ SHORT (SAT)</button>
            </div>
            
            <div class="liderlik-kontrol">
                <button id="btnLiderler" class="btn-bahis kapat-btn">ğŸ† Liderlik Tablosu</button>
            </div>
        </div>

        <div class="pozisyon-bilgi">
            <p>Pozisyon: <span id="pozisyonDurumu" style="color: grey;">KapalÄ±</span></p>
            <p>GiriÅŸ FiyatÄ±: <span id="girisFiyati">--</span></p>
            <p>Bahis MiktarÄ±: <span id="pozisyonMiktari">--</span></p>
            <p>AnlÄ±k K/Z: <span id="karZarar" class="kar">$0.00</span></p>
            <button id="btnPozisyonKapat" class="btn-bahis kapat-btn" disabled>Pozisyon Kapat</button>
        </div>

        <p class="uyari">âš ï¸ Bu simÃ¼lasyon, tamamen sahte ve rastgele verilerle Ã§alÄ±ÅŸÄ±r. GerÃ§ek finansal durumlarÄ± yansÄ±tmamaktadÄ±r. EÄŸlence amaÃ§lÄ±dÄ±r.</p>
    </div>

    <div id="leaderboardModal" class="modal">
        <div class="modal-icerik">
            <span class="kapat-buton" onclick="kapatModal()">&times;</span>
            <h3 id="liderlikBaslik">ğŸ† En Zengin 10 YatÄ±rÄ±mcÄ±</h3>
            <table id="leaderboardTablo">
                </table>
        </div>
    </div>

    <script>
        // --- API Yolu ---
        // BURAYI KENDÄ° RENDER BACKEND URL'Ä°NÄ°ZLE DEÄÄ°ÅTÄ°RÄ°N
        const RENDER_API_URL = 'http://localhost:3000/api'; // Yerel test iÃ§in
        // GerÃ§ek Render URL'i Ã–rn: 'https://fake-crypto-api.onrender.com/api'

        // --- Canvas ve HTML Element TanÄ±mlamalarÄ± ---
        const priceCanvas = document.getElementById('kriptoGrafik');
        const priceCtx = priceCanvas.getContext('2d');
        const priceWidth = priceCanvas.width;
        const priceHeight = priceCanvas.height;

        const volumeCanvas = document.getElementById('hacimGrafik');
        const volumeCtx = volumeCanvas.getContext('2d');
        const volumeWidth = volumeCanvas.width;
        const volumeHeight = volumeCanvas.height;

        const bakiyeElement = document.getElementById('sanalBakiye');
        const canliFiyatEtiketi = document.getElementById('canliFiyatEtiketi');
        const yEkseniEtiketleriDiv = document.getElementById('yEkseniEtiketleri');
        const miktarInput = document.getElementById('bahisMiktari');
        const btnYukselis = document.getElementById('btnYukselis');
        const btnDusme = document.getElementById('btnDusme');
        const btnKapat = document.getElementById('btnPozisyonKapat');
        const pozisyonDurumuElement = document.getElementById('pozisyonDurumu');
        const girisFiyatiElement = document.getElementById('girisFiyati');
        const pozisyonMiktariElement = document.getElementById('pozisyonMiktari');
        const karZararElement = document.getElementById('karZarar');

        const btnLiderler = document.getElementById('btnLiderler');
        const leaderboardModal = document.getElementById('leaderboardModal');
        const leaderboardTablo = document.getElementById('leaderboardTablo');

        // --- Oyun ve KalÄ±cÄ± Veri DeÄŸiÅŸkenleri ---
        let mumVerisi = []; // [open, high, low, close, volume]
        const MAX_MUM_SAYISI = 100;
        let sonFiyat = 50000.00;
        const KALDIRAÃ‡ = 10;
        let ANIMATION_SPEED = 250; // Mum gÃ¼ncelleme hÄ±zÄ± (ms)
        const CIZIM_ARALIGI = 16; // 60 FPS Ã§izim hÄ±zÄ±

        let sanalBakiye = 10000.00; // VarsayÄ±lan, API'den gÃ¼ncellenecek
        let pozisyon = { acik: false, tip: '', girisFiyati: 0, miktar: 0, kaldÄ±raÃ§: KALDIRAÃ‡ };
        
        // KalÄ±cÄ± Veri
        let USER_TELEGRAM_ID = null;
        let AUTH_TOKEN = null;
        let lastUpdateTime = Date.now();

        // --- Grafik Animasyon DeÄŸiÅŸkenleri ---
        let hedefCanliFiyatY = 0;
        let mevcutCanliFiyatY = 0;
        let animationFrameId; // requestAnimationFrame iÃ§in

        // -------------------------------------------
        // 1. GÄ°RÄ°Å VE API MANTIKLARI
        // -------------------------------------------

        async function simuleGiris(id, username) {
            // GerÃ§ek senaryoda, Telegram Widget'Ä± bu veriyi sunucuya gÃ¶nderir. 
            // Biz burada sunucu ile konuÅŸmayÄ± simÃ¼le ediyoruz.
            
            USER_TELEGRAM_ID = id;

            try {
                // Sunucuya POST isteÄŸi gÃ¶nderme simÃ¼lasyonu
                const response = await fetch(`${RENDER_API_URL}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    // GerÃ§ek Telegram verileri: id, username, photo_url, hash vb.
                    body: JSON.stringify({ id: id, username: username || `User_${id}` })
                });

                const data = await response.json();

                if (data.success) {
                    AUTH_TOKEN = data.token;
                    sanalBakiye = data.bakiye;
                    
                    document.getElementById('girisEkrani').style.display = 'none';
                    document.getElementById('oyunKapsayici').style.display = 'flex';
                    
                    baslatOyun();
                } else {
                    alert(`GiriÅŸ BaÅŸarÄ±sÄ±z: ${data.error || 'Bilinmeyen Hata'}`);
                }
            } catch (error) {
                console.error('GiriÅŸ veya API HatasÄ±:', error);
                alert('Sunucuya baÄŸlanÄ±lamÄ±yor. LÃ¼tfen Render API URL\'ini kontrol edin.');
            }
        }

        async function pozisyonKapat() {
            if (!pozisyon.acik || !AUTH_TOKEN) return;

            const karZarar = hesaplaKarZarar();
            const toplamKazanilan = pozisyon.miktar + karZarar;
            
            // Pozisyonu yerel olarak kapat
            pozisyon = { acik: false, tip: '', girisFiyati: 0, miktar: 0, kaldÄ±raÃ§: KALDIRAÃ‡ };

            try {
                // Sunucuya bakiye gÃ¼ncelleme isteÄŸi
                const response = await fetch(`${RENDER_API_URL}/update-bakiye`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH_TOKEN}` 
                    },
                    body: JSON.stringify({ karZarar: karZarar })
                });

                const data = await response.json();

                if (data.success) {
                    sanalBakiye = data.yeniBakiye;
                    alert(`Pozisyon KapandÄ±! K/Z: ${formatPara(karZarar)}. Yeni KalÄ±cÄ± Bakiye: ${formatPara(sanalBakiye)}`);
                    guncelleUI();
                } else {
                    alert(`Hata: Bakiye sunucuya kaydedilemedi. ${data.error}`);
                    // Hata durumunda, pozisyonu yerelde kapatÄ±p kullanÄ±cÄ±ya bildirdik.
                    guncelleUI();
                }
            } catch (error) {
                console.error('Bakiye API HatasÄ±:', error);
                alert('Ä°nternet baÄŸlantÄ±sÄ± veya sunucu hatasÄ±. Bakiye kaydedilemedi.');
                guncelleUI();
            }
        }

        // --- Liderlik Tablosu MantÄ±ÄŸÄ± (Frontend) ---

        btnLiderler.addEventListener('click', () => {
            leaderboardModal.style.display = 'block';
            liderleriCekVeGoster();
        });

        function kapatModal() { leaderboardModal.style.display = 'none'; }
        window.onclick = (event) => { if (event.target === leaderboardModal) kapatModal(); }

        async function liderleriCekVeGoster() {
            leaderboardTablo.innerHTML = `<tr><td colspan="3" style="text-align: center; color: #f0b90b;">YÃ¼kleniyor...</td></tr>`;

            try {
                const response = await fetch(`${RENDER_API_URL}/leaderboard`);
                const data = await response.json();

                if (data.success) {
                    const top10 = data.leaderboard;
                    let html = '<thead><tr><th>SÄ±ra</th><th>KullanÄ±cÄ± AdÄ±</th><th>Bakiye</th></tr></thead><tbody>';

                    top10.forEach(kisi => {
                        const bakiyeStr = formatPara(kisi.bakiye);
                        const sinif = kisi.sira === 1 ? 'sira-bir' : '';
                        
                        html += `<tr class="${sinif}">
                                    <td>${kisi.sira}</td>
                                    <td>${kisi.username}</td>
                                    <td>${bakiyeStr}</td>
                                 </tr>`;
                    });
                    
                    html += '</tbody>';
                    leaderboardTablo.innerHTML = html;
                } else {
                    leaderboardTablo.innerHTML = `<tr><td colspan="3" style="color: #ea3943; text-align: center;">Hata: Veri Ã§ekilemedi.</td></tr>`;
                }
            } catch (error) {
                console.error('Liderlik tablosu API HatasÄ±:', error);
                leaderboardTablo.innerHTML = `<tr><td colspan="3" style="color: #ea3943; text-align: center;">Sunucuya baÄŸlanÄ±lamÄ±yor.</td></tr>`;
            }
        }

        // -------------------------------------------
        // 2. OYUN Ã‡Ä°ZÄ°M VE MANTIKLARI (GeliÅŸmiÅŸ Mum Grafik)
        // -------------------------------------------
        
        // ... (Buraya Mum Grafik, Hacim, Fiyat GÃ¼ncelleme ve UI fonksiyonlarÄ±nÄ±n tam JS kodu gelmeli) ...
        
        // Not: Alan kÄ±sÄ±tlamasÄ± nedeniyle tÃ¼m kod buraya kopyalanmadÄ±. 
        // LÃ¼tfen bu kÄ±sma Ã¶nceki MUM GRAFÄ°KLÄ° cevabÄ±mdaki tÃ¼m JavaScript kodunu kopyalayÄ±n.
        // Ã–zellikle: formatPara, guncelleUI, hesaplaKarZarar, pozisyonAc, cizMumGrafik, cizHacimGrafik, guncelleFiyat, animasyonDongusu ve baslatOyun fonksiyonlarÄ±.

        // Ã–rnek baslatOyun tanÄ±mÄ±:
        function baslatOyun() {
            // Ä°lk veriyi doldur
            for (let i = 0; i < MAX_MUM_SAYISI; i++) {
                guncelleFiyat(true); // true = Sadece yeni mum baÅŸlat
            }
            // Ä°lk Ã§izimi yap
            cizMumGrafik(); 
            cizHacimGrafik();
            guncelleUI(); 
            // Animasyon dÃ¶ngÃ¼sÃ¼nÃ¼ baÅŸlat
            animasyonDongusu();
            // Periyodik mum oluÅŸturma dÃ¶ngÃ¼sÃ¼nÃ¼ baÅŸlat
            setInterval(() => guncelleFiyat(true), ANIMATION_SPEED);
        }
        
        // Ä°lk yÃ¼klemede UI'Ä± gÃ¼ncelle
        // guncelleUI(); // Ä°lk giriÅŸte giriÅŸ ekranÄ± gÃ¶rÃ¼neceÄŸi iÃ§in burasÄ± gereksiz.
    </script>
</body>
</html>
