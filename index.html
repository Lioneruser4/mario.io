<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Online Dama Oyunu</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>

    <style>
        /* --- Temel Stil ve Animasyonlar (Lobi) --- */
        :root {
            --primary-color: #f39c12; /* AltÄ±n SarÄ±sÄ± */
            --secondary-color: #2ecc71;
            --dark-bg: #2c3e50;
            --square-light: #f5f5dc;
            --square-dark: #8b4513;
        }

        body { font-family: 'Poppins', sans-serif; background: linear-gradient(135deg, #1f2a3a, #2c3e50); color: #fff; margin: 0; height: 100vh; overflow: hidden; display: flex; justify-content: center; align-items: center; }
        
        #app-container { width: 100%; height: 100%; max-width: none; max-height: none; border-radius: 0; padding: 10px; box-sizing: border-box; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        
        .screen { display: none; width: 90%; max-width: 500px; }
        .screen.active { display: block; }
        
        /* LOBÄ° STÄ°LÄ° */
        #lobby { background: #34495e; padding: 30px 20px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); transform: scale(1); transition: transform 0.5s ease-in-out; }
        #lobby.sub-screen { transform: scale(0.9); opacity: 0.5; pointer-events: none; } /* Alt ekran aÃ§Ä±ldÄ±ÄŸÄ±nda kÃ¼Ã§Ã¼l */
        .logo-text { font-size: 3em; margin-bottom: 5px; font-weight: 800; text-shadow: 2px 2px #000; }
        .logo-span { color: var(--primary-color); }
        .info-text { margin-top: 10px; font-size: 0.9em; opacity: 0.8; }
        .status-conn.green { color: var(--secondary-color); }

        /* Butonlar */
        .main-btn, .secondary-btn { padding: 12px 20px; margin: 8px 5px; border: none; border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: 600; transition: all 0.3s; }
        .main-btn { background-color: var(--primary-color); color: var(--dark-bg); }
        .main-btn:hover:not(:disabled) { background-color: #e67e22; transform: translateY(-2px); }
        .main-btn:disabled { background-color: #7f8c8d; cursor: not-allowed; color: #bdc3c7; }
        .main-btn.red-btn { background-color: #e74c3c; color: white; }

        /* Alt Ekranlar (Oda Kur/KatÄ±l) */
        .sub-screen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); display: none; justify-content: center; align-items: center; z-index: 100; }
        .sub-screen-content { background: #34495e; padding: 30px; border-radius: 10px; box-shadow: 0 0 20px rgba(0, 0, 0, 0.9); transform: scale(0.8); opacity: 0; transition: all 0.3s ease-in-out; }
        .sub-screen-overlay.active { display: flex; }
        .sub-screen-overlay.active .sub-screen-content { transform: scale(1); opacity: 1; }

        #roomIdInput { width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 8px; border: 2px solid #bdc3c7; text-align: center; font-size: 1.2em; box-sizing: border-box; }
        
        /* EÅŸleÅŸme Arama Animasyonu */
        #matchmakingOverlay { display: none; flex-direction: column; }
        #matchmakingOverlay.active { display: flex; }
        .spinner { border: 8px solid rgba(255, 255, 255, 0.1); border-top: 8px solid var(--primary-color); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Oyun TahtasÄ± ve Mobil GÃ¶rÃ¼nÃ¼m */
        #board { width: 95vmin; height: 95vmin; max-width: 400px; max-height: 400px; margin: 15px auto; }
        #board.player2-view { transform: rotate(180deg); }
        #board.player2-view .piece { transform: rotate(180deg); }
        .piece.selected { box-shadow: 0 0 15px var(--secondary-color); }

        @media (max-width: 600px) {
            #app-container { padding: 5px; }
            #board { width: 98vmin; height: 98vmin; }
            .logo-text { font-size: 2.5em; }
        }
        
    </style>
</head>
<body>
    <div id="app-container">
        <div id="lobby" class="screen active">
            <h1 class="logo-text">CHEC<span class="logo-span">KERS</span> ONLINE</h1>
            <p id="status" class="info-text status-conn">Sunucuya baÄŸlanÄ±lÄ±yor...</p>
            
            <div id="auth-status">
                <p id="player-name">GiriÅŸ YapÄ±lÄ±yor...</p>
                <script async src="https://telegram.org/js/telegram-widget.js?24" 
                    data-telegram-login="[BOT_KULLANICI_ADINIZ]" 
                    data-size="large" 
                    data-auth-url="[SUNUCU_ADRESÄ°NÄ°Z]/telegram-auth" 
                    data-request-access="write"></script>
            </div>
            
            <div class="lobby-controls">
                <button id="rankedBtn" class="main-btn" disabled>
                    <i class="fas fa-medal"></i> Dereceli EÅŸleÅŸme Bul
                </button>

                <button id="createGameBtn" class="main-btn" disabled>
                    <i class="fas fa-plus-circle"></i> Oda Kur
                </button>
                
                <button id="showJoinBtn" class="main-btn" disabled>
                    <i class="fas fa-sign-in-alt"></i> Odaya KatÄ±l
                </button>
            </div>
        </div>
        
        <div id="game" class="screen">
            <div class="game-header">
                <p id="playerRoleDisplay" class="role-text"></p>
                <h2 id="turnIndicator">SÄ±ra: Bekleniyor...</h2>
                <button id="leaveBtn" class="secondary-btn red-btn"><i class="fas fa-times-circle"></i> Oyundan AyrÄ±l</button>
            </div>
            
            <div class="board-wrapper">
                <div id="board">
                </div>
            </div>
        </div>
    </div>

    <div id="createOverlay" class="sub-screen-overlay">
        <div class="sub-screen-content">
            <h3><i class="fas fa-door-open"></i> Yeni Oda Kuruluyor</h3>
            <p id="currentRoomCode" class="info-text">Oda Kodu: ****</p>
            <p id="createStatus" class="info-text">Rakip bekleniyor...</p>
            <button id="cancelCreateBtn" class="secondary-btn red-btn"><i class="fas fa-times"></i> Ä°ptal Et</button>
        </div>
    </div>

    <div id="joinOverlay" class="sub-screen-overlay">
        <div class="sub-screen-content">
            <h3><i class="fas fa-sign-in-alt"></i> Odaya KatÄ±l</h3>
            <input type="text" id="roomIdInput" placeholder="4 Haneli Oda Kodunu Girin" maxlength="4">
            <button id="joinBtn" class="main-btn"><i class="fas fa-check"></i> KatÄ±l</button>
            <button id="cancelJoinBtn" class="secondary-btn red-btn"><i class="fas fa-times"></i> Ä°ptal</button>
        </div>
    </div>

    <div id="matchmakingOverlay" class="sub-screen-overlay">
        <div class="sub-screen-content">
            <h3><i class="fas fa-search"></i> Dereceli EÅŸleÅŸme AranÄ±yor</h3>
            <div class="spinner"></div>
            <p id="matchmakingStatusText" class="info-text">Kuyrukta bekleniyor...</p>
            <button id="cancelRankedBtn" class="secondary-btn red-btn"><i class="fas fa-times"></i> AramayÄ± Ä°ptal Et</button>
        </div>
    </div>

    <script>
        // Sunucu adresiniz
        const SERVER_URL = 'https://mario-io-1.onrender.com'; // **Kendi adresinizle deÄŸiÅŸtirin!**
        const socket = io(SERVER_URL);

        // --- DOM Elementleri ---
        const lobbyDiv = document.getElementById('lobby');
        const gameDiv = document.getElementById('game');
        const statusDiv = document.getElementById('status');
        const boardDiv = document.getElementById('board');
        const turnIndicator = document.getElementById('turnIndicator');
        const playerNameDisplay = document.getElementById('player-name');

        const rankedBtn = document.getElementById('rankedBtn');
        const createGameBtn = document.getElementById('createGameBtn');
        const showJoinBtn = document.getElementById('showJoinBtn');
        const leaveBtn = document.getElementById('leaveBtn');

        // Overlay Elementleri
        const createOverlay = document.getElementById('createOverlay');
        const currentRoomCode = document.getElementById('currentRoomCode');
        const cancelCreateBtn = document.getElementById('cancelCreateBtn');
        const joinOverlay = document.getElementById('joinOverlay');
        const roomIdInput = document.getElementById('roomIdInput');
        const joinBtn = document.getElementById('joinBtn');
        const cancelJoinBtn = document.getElementById('cancelJoinBtn');
        const matchmakingOverlay = document.getElementById('matchmakingOverlay');
        const cancelRankedBtn = document.getElementById('cancelRankedBtn');
        const matchmakingStatusText = document.getElementById('matchmakingStatusText');


        // --- Oyun Durum DeÄŸiÅŸkenleri ---
        let currentRoomId = null;
        let playerRole = null;
        let currentBoard = null;
        let currentTurn = null;
        let currentUsername = null; 
        let selectedPiece = null; 

        // --- YENÄ°: Misafir AdÄ± OluÅŸturma ---
        function generateGuestName() {
            const randomNumber = Math.floor(Math.random() * 900) + 100;
            return `Guest${randomNumber}`;
        }

        // KullanÄ±cÄ± AdÄ±nÄ± Kontrol Etme (URL veya Guest)
        function checkAndSetUsername() {
            const urlParams = new URLSearchParams(window.location.search);
            const tgUsername = urlParams.get('username');
            const tgId = urlParams.get('id');
            const tgWidget = document.querySelector('[data-telegram-login]');
            
            if (tgUsername) {
                currentUsername = tgUsername;
                playerNameDisplay.textContent = `HoÅŸ Geldin, @${tgUsername}`;
                if(tgWidget) tgWidget.style.display = 'none';
            } else {
                currentUsername = generateGuestName(); 
                playerNameDisplay.textContent = `Misafir: ${currentUsername}`;
                if(tgWidget) tgWidget.style.display = 'none'; 
            }
        }
        checkAndSetUsername(); 

        // --- YARDIMCI FONKSÄ°YONLAR ---

        function toggleOverlay(overlayElement, show) {
            if (show) {
                overlayElement.classList.add('active');
                lobbyDiv.classList.add('sub-screen');
            } else {
                overlayElement.classList.remove('active');
                lobbyDiv.classList.remove('sub-screen');
                // Lobi butonlarÄ±nÄ± tekrar aktif et
                rankedBtn.disabled = false;
                createGameBtn.disabled = false;
                showJoinBtn.disabled = false;
            }
        }

        function resetGame() {
            currentRoomId = null;
            playerRole = null;
            currentBoard = null;
            currentTurn = null;
            clearSelections();
            
            gameDiv.classList.remove('active');
            lobbyDiv.classList.add('active');
            boardDiv.innerHTML = '';
            turnIndicator.textContent = 'SÄ±ra: Bekleniyor...';
            boardDiv.classList.remove('player2-view');
            
            toggleOverlay(matchmakingOverlay, false);
            toggleOverlay(createOverlay, false);
            toggleOverlay(joinOverlay, false);
            
            // Lobi butonlarÄ±nÄ± tekrar aktif et (BaÄŸlantÄ± aÃ§Ä±ksa)
            if(socket.connected) {
                rankedBtn.disabled = false;
                createGameBtn.disabled = false;
                showJoinBtn.disabled = false;
            }
        }

        function clearSelections() {
            selectedPiece = null;
            document.querySelectorAll('.piece.selected').forEach(p => p.classList.remove('selected'));
            document.querySelectorAll('.square.possible-move').forEach(s => s.classList.remove('possible-move'));
        }

        // --- SOCKET BAÄžLANTILARI ---

        socket.on('connect', () => {
            statusDiv.textContent = 'âœ… Sunucuya baÄŸlandÄ±.';
            statusDiv.classList.add('green');
            socket.emit('playerIdentity', { username: currentUsername });
            resetGame(); // BaÄŸlantÄ± yenilenirse lobiyi temizle
        });

        socket.on('disconnect', () => {
            statusDiv.textContent = 'âŒ Sunucu baÄŸlantÄ±sÄ± kesildi.';
            statusDiv.classList.remove('green');
            rankedBtn.disabled = true;
            createGameBtn.disabled = true;
            showJoinBtn.disabled = true;
            // EÄŸer oyundaysak lobiyi gÃ¶ster
            if(gameDiv.classList.contains('active')) {
                alert('Sunucu baÄŸlantÄ±sÄ± kesildi. LÃ¼tfen sayfayÄ± yenileyin.');
                resetGame();
            }
        });
        
        // Dereceli Arama Durum GÃ¼ncellemeleri
        socket.on('matchMakingStatus', (message) => {
            matchmakingStatusText.textContent = message;
        });

        // Dereceli Arama Ä°ptal Edildi
        socket.on('matchMakingCancelled', (message) => {
            matchmakingStatusText.textContent = message;
            toggleOverlay(matchmakingOverlay, false);
        });

        // Dereceli EÅŸleÅŸme Bulundu
        socket.on('matchFound', (data) => {
            currentRoomId = data.roomId;
            playerRole = data.role;
            statusDiv.textContent = `EÅŸleÅŸme bulundu! Oyun baÅŸlÄ±yor... ðŸŽ‰`;
            toggleOverlay(matchmakingOverlay, false);
        });

        // Oyun BaÅŸladÄ±
        socket.on('gameStart', (data) => {
            lobbyDiv.classList.remove('active');
            gameDiv.classList.add('active');
            toggleOverlay(createOverlay, false); // EÄŸer kurma lobisinden gelindiyse
            
            const myColor = playerRole === 'player1' ? 'Siyah' : 'Beyaz';
            const opponentName = playerRole === 'player1' ? data.player2Name : data.player1Name;
            
            playerRoleDisplay.textContent = `Siz: ${myColor} | Rakip: ${opponentName}`;
            currentRoomId = currentRoomId || data.roomId;
            updateBoard(data.board);
            updateTurn(data.turn);

            if (playerRole === 'player2') {
                boardDiv.classList.add('player2-view');
            } else {
                boardDiv.classList.remove('player2-view');
            }
        });

        // Tahta GÃ¼ncellemesi
        socket.on('boardUpdate', (data) => {
            updateBoard(data.board);
            updateTurn(data.turn);
            
            if (data.chained) {
                statusDiv.textContent = 'ZÄ°NCÄ°RLEME VURMA! Hamle SÄ°ZDE!';
            } else {
                statusDiv.textContent = 'Oyun Devam Ediyor.';
            }
        });

        // GeÃ§ersiz Hamle UyarÄ±sÄ±
        socket.on('invalidMove', (data) => {
            // Sunucunun uyarÄ±sÄ±nÄ± al ve kullanÄ±cÄ±ya bildir
            alert("GeÃ§ersiz Hamle: " + data.message);
            clearSelections();
        });

        // Kazanma Durumu
        socket.on('gameOver', (data) => {
            const isMe = data.winner === playerRole;
            alert(isMe ? 'TEBRÄ°KLER! Oyunu KazandÄ±nÄ±z! ðŸŽ‰' : 'ÃœzgÃ¼nÃ¼m, Oyunu Kaybettiniz. ðŸ˜”');
            resetGame();
        });

        // Rakip BaÄŸlantÄ± Koptu
        socket.on('opponentDisconnected', (message) => {
            alert(message);
            resetGame();
        });


        // --- LOBÄ° KONTROL OLAYLARI ---
        
        // Dereceli Arama BaÅŸlat
        rankedBtn.addEventListener('click', () => {
            rankedBtn.disabled = true;
            createGameBtn.disabled = true;
            showJoinBtn.disabled = true;
            matchmakingStatusText.textContent = 'EÅŸleÅŸme aranÄ±yor...';
            toggleOverlay(matchmakingOverlay, true);
            socket.emit('findRankedMatch');
        });

        // Dereceli Arama Ä°ptal Et
        cancelRankedBtn.addEventListener('click', () => {
            socket.emit('cancelMatchmaking');
            // Ä°ptal cevabÄ± 'matchMakingCancelled' olayÄ±nda gelir ve overlay'i kapatÄ±r
        });

        // Oda Kur Butonuna BasÄ±ldÄ± (Overlay AÃ§Ä±lÄ±r)
        createGameBtn.addEventListener('click', () => {
            rankedBtn.disabled = true;
            showJoinBtn.disabled = true;
            createGameBtn.disabled = true;
            toggleOverlay(createOverlay, true);
            
            // Sunucuya oda kurma isteÄŸi gÃ¶nder
            socket.emit('createGame', (response) => {
                if (response.success) {
                    currentRoomId = response.roomId;
                    playerRole = response.role;
                    currentRoomCode.innerHTML = `Oda Kodu: <span style="font-size:1.5em; color:var(--secondary-color);">${currentRoomId}</span>`;
                    document.getElementById('createStatus').textContent = 'Rakip bekleniyor...';
                } else {
                    document.getElementById('createStatus').textContent = 'Oda kurulamadÄ±: ' + response.message;
                    cancelCreateBtn.textContent = 'Kapat';
                }
            });
        });

        // Oda Kurma Ä°ptal Et
        cancelCreateBtn.addEventListener('click', () => {
            if (currentRoomId) {
                // Oda kurucusu ayrÄ±lÄ±nca sunucu odasÄ±nÄ± otomatik siler.
                socket.disconnect(); 
                socket.connect();
            }
            toggleOverlay(createOverlay, false);
            currentRoomId = null;
        });

        // Odaya KatÄ±l Butonuna BasÄ±ldÄ± (Overlay AÃ§Ä±lÄ±r)
        showJoinBtn.addEventListener('click', () => {
            rankedBtn.disabled = true;
            createGameBtn.disabled = true;
            showJoinBtn.disabled = true;
            roomIdInput.value = '';
            toggleOverlay(joinOverlay, true);
        });

        // KatÄ±lma Ä°ptal Et
        cancelJoinBtn.addEventListener('click', () => {
            toggleOverlay(joinOverlay, false);
        });

        // KatÄ±l Butonu (KatÄ±lma Overlay'i Ä°Ã§inde)
        joinBtn.addEventListener('click', () => {
            const roomId = roomIdInput.value.trim();
            if (roomId.length === 4) {
                socket.emit('joinGame', { roomId: roomId }, (response) => {
                    if (response.success) {
                        currentRoomId = response.roomId;
                        playerRole = response.role;
                        statusDiv.textContent = 'Odaya baÅŸarÄ±yla katÄ±ldÄ±nÄ±z.';
                        toggleOverlay(joinOverlay, false);
                        // Oyunun baÅŸlamasÄ± 'gameStart' ile sunucudan gelecek.
                    } else {
                        alert(response.message);
                        roomIdInput.value = '';
                    }
                });
            } else {
                alert('LÃ¼tfen 4 haneli oda kodu girin.');
            }
        });

        // Oyundan AyrÄ±l
        leaveBtn.addEventListener('click', () => {
            // BasitÃ§e yeniden baÄŸlanarak oyundan Ã§Ä±kÄ±ÅŸÄ± simÃ¼le et
            socket.disconnect();
            socket.connect();
            resetGame();
        });

        // --- OYUN ARAYÃœZÃœ VE HAREKET MANTIÄžI ---

        function updateBoard(board) {
            currentBoard = board;
            boardDiv.innerHTML = '';
            clearSelections();
            
            for (let r = 0; r < 8; r++) {
                for (let c = 0; c < 8; c++) {
                    const square = document.createElement('div');
                    // Sadece koyu kareler oyun alanÄ± (Dama kuralÄ±)
                    const isDark = (r + c) % 2 !== 0; 
                    square.className = `square ${isDark ? 'dark' : 'light'}`;
                    square.dataset.row = r;
                    square.dataset.col = c;
                    square.addEventListener('click', handleSquareClick);
                    
                    const pieceType = board[r][c];
                    if (pieceType !== 0) {
                        const piece = document.createElement('div');
                        let pieceClass = '';
                        let isKing = false;

                        if (pieceType === 1 || pieceType === 3) pieceClass = 'black';
                        if (pieceType === 2 || pieceType === 4) pieceClass = 'white';
                        if (pieceType === 3 || pieceType === 4) isKing = true;
                        
                        piece.className = `piece ${pieceClass} ${isKing ? 'king' : ''}`;
                        piece.addEventListener('click', handlePieceClick);
                        square.appendChild(piece);
                    }

                    boardDiv.appendChild(square);
                }
            }
        }

        function updateTurn(turn) {
            currentTurn = turn;
            const isMyTurn = playerRole === turn;
            
            turnIndicator.textContent = isMyTurn ? 'SIRA SÄ°ZDE! ðŸŸ¢' : 'Rakibinizin sÄ±rasÄ±... ðŸ”´';
            turnIndicator.className = isMyTurn ? 'turn-mine' : 'turn-opponent';
        }

        function handlePieceClick(event) {
            event.stopPropagation();
            const piece = event.currentTarget;
            const square = piece.parentElement;
            const clickedPos = { row: parseInt(square.dataset.row), col: parseInt(square.dataset.col) };
            const pieceType = currentBoard[clickedPos.row][clickedPos.col];
            
            const isMyPiece = (playerRole === 'player1' && (pieceType === 1 || pieceType === 3)) ||
                             (playerRole === 'player2' && (pieceType === 2 || pieceType === 4));
            
            if (currentTurn === playerRole && isMyPiece) {
                clearSelections();
                selectedPiece = clickedPos;
                piece.classList.add('selected');

                // Vurgulama: Sadece dark kareleri vurguluyoruz, kuralÄ± sunucu kontrol eder
                document.querySelectorAll('.square.dark').forEach(s => {
                    s.classList.add('possible-move');
                });
            } else {
                clearSelections();
            }
        }
        
        function handleSquareClick(event) {
            const square = event.currentTarget;
            const target = { row: parseInt(square.dataset.row), col: parseInt(square.dataset.col) };

            if (selectedPiece && square.classList.contains('possible-move')) {
                // Hamleyi sunucuya gÃ¶nder (Sunucu tÃ¼m kural ve zorunlu vurmayÄ± kontrol edecek)
                socket.emit('move', { 
                    roomId: currentRoomId, 
                    from: selectedPiece, 
                    to: target 
                });
                clearSelections();
            }
        }
        
        // Ä°lk yÃ¼kleme
        updateBoard(Array(8).fill(0).map(() => Array(8).fill(0)));
    </script>
</body>
</html>
