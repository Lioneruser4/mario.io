<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Online Checkers Game</title>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
            font-family: Arial, sans-serif;
        }
        #game-container {
            text-align: center;
        }
        #board {
            display: grid;
            grid-template-columns: repeat(8, 50px);
            grid-template-rows: repeat(8, 50px);
            border: 2px solid #000;
            margin: 20px auto;
        }
        .cell {
            width: 50px;
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        .black {
            background-color: #333;
        }
        .white {
            background-color: #fff;
        }
        .piece {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            position: absolute;
        }
        .red {
            background-color: red;
            border: 2px solid darkred;
        }
        .black-piece {
            background-color: black;
            border: 2px solid gray;
        }
        .king {
            border: 4px solid gold;
        }
        .highlight {
            background-color: yellow !important;
            opacity: 0.5;
        }
        .possible-move {
            background-color: green !important;
            opacity: 0.5;
        }
        .turn-highlight {
            box-shadow: 0 0 10px 5px yellow;
        }
        #status {
            margin: 10px;
            font-size: 18px;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            margin: 10px;
            cursor: pointer;
        }
        #lobby {
            display: none;
        }
    </style>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
</head>
<body>
    <div id="game-container">
        <h1>Online Checkers</h1>
        <button id="ranked-play">Dereceli Oyna</button>
        <div id="lobby">Eşleşme Aranıyor...</div>
        <div id="board"></div>
        <div id="status"></div>
    </div>

    <script>
        // Socket.io Bağlantısı
        const socket = io('https://mario-io-1.onrender.com', { transports: ['websocket'] });

        // Oyun Durumları
        let board = [];
        let currentPlayer = 'red'; // Kırmızı başlar
        let selectedPiece = null;
        let playerColor = null; // Oyuncunun rengi (red veya black)
        let gameId = null;
        let isMyTurn = false;

        // Tahta Oluştur
        function initBoard() {
            const boardElement = document.getElementById('board');
            boardElement.innerHTML = '';
            board = Array.from({length: 8}, () => Array(8).fill(null));

            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    const cell = document.createElement('div');
                    cell.classList.add('cell', (row + col) % 2 === 0 ? 'white' : 'black');
                    cell.dataset.row = row;
                    cell.dataset.col = col;
                    cell.addEventListener('click', handleCellClick);
                    boardElement.appendChild(cell);

                    // Taşları Yerleştir
                    if (row < 3 && (row + col) % 2 !== 0) {
                        placePiece(row, col, 'black');
                    } else if (row > 4 && (row + col) % 2 !== 0) {
                        placePiece(row, col, 'red');
                    }
                }
            }
        }

        function placePiece(row, col, color) {
            const cell = document.querySelector(`[data-row="${row}"][data-col="${col}"]`);
            const piece = document.createElement('div');
            piece.classList.add('piece', color === 'red' ? 'red' : 'black-piece');
            piece.dataset.color = color;
            piece.dataset.king = 'false';
            piece.addEventListener('click', handlePieceClick);
            cell.appendChild(piece);
            board[row][col] = { color, king: false };
        }

        // Taş Seçimi
        function handlePieceClick(e) {
            e.stopPropagation();
            if (!isMyTurn || e.target.dataset.color !== playerColor) return;

            clearHighlights();
            selectedPiece = e.target;
            const row = parseInt(selectedPiece.parentElement.dataset.row);
            const col = parseInt(selectedPiece.parentElement.dataset.col);
            highlightPossibleMoves(row, col);
        }

        // Hücre Tıklama (Hareket)
        function handleCellClick(e) {
            if (!selectedPiece || !isMyTurn) return;

            const fromRow = parseInt(selectedPiece.parentElement.dataset.row);
            const fromCol = parseInt(selectedPiece.parentElement.dataset.col);
            const toRow = parseInt(e.currentTarget.dataset.row);
            const toCol = parseInt(e.currentTarget.dataset.col);

            if (isValidMove(fromRow, fromCol, toRow, toCol)) {
                movePiece(fromRow, fromCol, toRow, toCol);
                clearHighlights();
                selectedPiece = null;
                switchTurn();
                updateGameState();
                checkWin();
            }
        }

        // Mümkün Hareketleri Göster
        function highlightPossibleMoves(row, col) {
            const piece = board[row][col];
            const direction = piece.color === 'red' ? -1 : 1;
            const moves = getPossibleMoves(row, col, direction, piece.king);

            moves.forEach(([r, c]) => {
                const cell = document.querySelector(`[data-row="${r}"][data-col="${c}"]`);
                cell.classList.add('possible-move');
            });
        }

        function getPossibleMoves(row, col, direction, isKing) {
            const moves = [];
            const dirs = [[direction, -1], [direction, 1]];
            if (isKing) dirs.push([-direction, -1], [-direction, 1]);

            dirs.forEach(([dr, dc]) => {
                let r = row + dr, c = col + dc;
                if (r >= 0 && r < 8 && c >= 0 && c < 8 && !board[r][c]) {
                    moves.push([r, c]); // Normal hareket
                } else if (r >= 0 && r < 8 && c >= 0 && c < 8 && board[r][c] && board[r][c].color !== currentPlayer) {
                    r += dr; c += dc;
                    if (r >= 0 && r < 8 && c >= 0 && c < 8 && !board[r][c]) {
                        moves.push([r, c]); // Yeme
                    }
                }
            });

            // Zorunlu yeme kontrolü
            const captures = moves.filter(m => Math.abs(m[0] - row) === 2);
            return captures.length > 0 ? captures : moves;
        }

        function isValidMove(fromRow, fromCol, toRow, toCol) {
            const piece = board[fromRow][fromCol];
            const direction = piece.color === 'red' ? -1 : 1;
            const moves = getPossibleMoves(fromRow, fromCol, direction, piece.king);
            return moves.some(([r, c]) => r === toRow && c === toCol);
        }

        // Taş Hareket Ettir
        function movePiece(fromRow, fromCol, toRow, toCol) {
            const piece = board[fromRow][fromCol];
            board[toRow][toCol] = piece;
            board[fromRow][fromCol] = null;

            const cellFrom = document.querySelector(`[data-row="${fromRow}"][data-col="${fromCol}"]`);
            const cellTo = document.querySelector(`[data-row="${toRow}"][data-col="${toCol}"]`);
            cellTo.appendChild(cellFrom.firstChild);

            // Yeme
            if (Math.abs(toRow - fromRow) === 2) {
                const midRow = (fromRow + toRow) / 2;
                const midCol = (fromCol + toCol) / 2;
                board[midRow][midCol] = null;
                const midCell = document.querySelector(`[data-row="${midRow}"][data-col="${midCol}"]`);
                midCell.innerHTML = '';
            }

            // Kral Olma
            if ((piece.color === 'red' && toRow === 0) || (piece.color === 'black' && toRow === 7)) {
                piece.king = true;
                cellTo.firstChild.classList.add('king');
                cellTo.firstChild.dataset.king = 'true';
            }
        }

        function clearHighlights() {
            document.querySelectorAll('.possible-move').forEach(el => el.classList.remove('possible-move'));
        }

        // Sıra Değiştir
        function switchTurn() {
            currentPlayer = currentPlayer === 'red' ? 'black' : 'red';
            isMyTurn = currentPlayer === playerColor;
            updateTurnHighlight();
            document.getElementById('status').textContent = isMyTurn ? 'Sıra Sende!' : 'Rakibin Sırası...';
        }

        function updateTurnHighlight() {
            document.querySelectorAll('.cell').forEach(cell => cell.classList.remove('turn-highlight'));
            if (currentPlayer === 'red') {
                for (let row = 5; row < 8; row++) {
                    for (let col = 0; col < 8; col++) {
                        const cell = document.querySelector(`[data-row="${row}"][data-col="${col}"]`);
                        cell.classList.add('turn-highlight');
                    }
                }
            } else {
                for (let row = 0; row < 3; row++) {
                    for (let col = 0; col < 8; col++) {
                        const cell = document.querySelector(`[data-row="${row}"][data-col="${col}"]`);
                        cell.classList.add('turn-highlight');
                    }
                }
            }
        }

        // Kazanma Kontrolü
        function checkWin() {
            const redPieces = board.flat().filter(p => p && p.color === 'red').length;
            const blackPieces = board.flat().filter(p => p && p.color === 'black').length;
            if (redPieces === 0) {
                alert('Siyah Kazandı!');
                endGame();
            } else if (blackPieces === 0) {
                alert('Kırmızı Kazandı!');
                endGame();
            }
        }

        function endGame() {
            // Oyun bitiş işlemleri
            socket.emit('endGame', gameId);
        }

        // Multiplayer İşlemleri (Socket.io)
        document.getElementById('ranked-play').addEventListener('click', startMatchmaking);

        function startMatchmaking() {
            document.getElementById('lobby').style.display = 'block';
            document.getElementById('ranked-play').disabled = true;
            socket.emit('joinQueue');
        }

        socket.on('gameStart', (data) => {
            gameId = data.gameId;
            playerColor = data.color;
            initBoard();
            document.getElementById('lobby').style.display = 'none';
            document.getElementById('board').style.display = 'grid';
            isMyTurn = playerColor === 'red';
            updateTurnHighlight();
            document.getElementById('status').textContent = isMyTurn ? 'Sıra Sende!' : 'Rakibin Sırası...';
        });

        socket.on('updateState', (data) => {
            board = data.board;
            currentPlayer = data.currentPlayer;
            isMyTurn = currentPlayer === playerColor;
            renderBoardFromState();
            updateTurnHighlight();
            document.getElementById('status').textContent = isMyTurn ? 'Sıra Sende!' : 'Rakibin Sırası...';
            checkWin();
        });

        function updateGameState() {
            socket.emit('move', { gameId, board, currentPlayer });
        }

        function renderBoardFromState() {
            document.querySelectorAll('.cell').forEach(cell => {
                cell.innerHTML = '';
                const row = parseInt(cell.dataset.row);
                const col = parseInt(cell.dataset.col);
                if (board[row][col]) {
                    placePiece(row, col, board[row][col].color);
                    if (board[row][col].king) {
                        cell.firstChild.classList.add('king');
                        cell.firstChild.dataset.king = 'true';
                    }
                }
            });
        }

        socket.on('connect', () => {
            console.log('Sunucuya bağlandı!');
        });

        socket.on('disconnect', () => {
            console.log('Sunucudan ayrıldı.');
        });
    </script>
</body>
</html>
