<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matter.js Sword Ball Duel - Professional Edition</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        /* --- Base / Global Styles --- */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #1a2533; /* Darker background */
            color: #ecf0f1;
            flex-direction: column;
            overflow: hidden;
            padding: 5px;
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* --- Game Container (The Arena) --- */
        #game-container {
            position: relative;
            width: 90vmin; /* Responsive square */
            height: 90vmin;
            max-width: 800px; /* Max size for larger screens */
            max-height: 800px;
            border: 8px solid #3498db; /* Thinner, cleaner border */
            border-radius: 8px; /* Slightly rounded corners */
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.8); /* Stronger shadow */
            background-color: #2c3e50; /* Arena background */
            overflow: hidden;
            margin: 10px;
            flex-shrink: 0; /* Prevents shrinking on small screens */
            touch-action: none; /* Prevent browser touch actions */
        }

        /* --- Ball Visuals (Handles Photo and Emoji) --- */
        .ball-display-wrapper {
            position: absolute;
            border-radius: 50%;
            background-size: cover;
            background-position: center;
            transition: transform 0.05s ease-out; /* Smooth movement */
            box-shadow: 0 0 12px rgba(0, 0, 0, 0.6);
            z-index: 5; /* Base z-index for balls */
            background-color: transparent; /* Ensures only photo/emoji shows */
            display: flex; /* For centering emoji */
            justify-content: center;
            align-items: center;
            overflow: hidden; /* Ensure photo stays within circle */
        }
        
        .ball-emoji-fallback {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 40px; /* Default emoji size */
            color: white; /* Emoji color */
            background-color: inherit; /* Inherits color from JS if no photo */
        }

        /* --- Sword Visuals (Attached to Ball) --- */
        .sword-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 120%; /* Slightly larger than ball for rotation */
            height: 120%;
            display: none; /* Hidden by default */
            pointer-events: none; /* Allows clicks/touches to pass through */
            z-index: 6; /* Kƒ±lƒ±√ß topun √ºst√ºnde olmalƒ± */
            animation: sword-spin 1.5s linear infinite; /* Slower spin */
        }

        .sword-icon {
            position: absolute;
            font-size: 30px; /* Sword icon size */
            text-shadow: 0 0 8px #f1c40f, 0 0 5px #e67e22; /* Glow effect */
        }

        /* Positioning of the three swords around the ball */
        .sword-container .sword-1 { transform: rotate(0deg) translate(0, -60px) rotate(0deg); }
        .sword-container .sword-2 { transform: rotate(120deg) translate(0, -60px) rotate(-120deg); }
        .sword-container .sword-3 { transform: rotate(240deg) translate(0, -60px) rotate(-240deg); }
        
        @keyframes sword-spin {
            from { transform: translate(-50%, -50%) rotate(0deg); }
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }

        /* --- Hit Effect --- */
        .hit-effect {
            animation: hit-shake 0.3s ease-in-out;
            box-shadow: 0 0 25px 7px #e74c3c; /* More prominent hit flash */
        }

        @keyframes hit-shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            20% { transform: translate(-3px, 0px) rotate(-2deg); }
            40% { transform: translate(3px, 1px) rotate(2deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            80% { transform: translate(1px, -1px) rotate(2deg); }
            100% { transform: translate(1px, 1px) rotate(0deg); }
        }

        /* --- Item (Dropped Sword) --- */
        #item-emoji {
            position: absolute;
            font-size: 45px; /* Larger dropped sword */
            transform: translate(-50%, -50%);
            text-shadow: 0 0 10px #f1c40f;
            display: none;
            z-index: 7; /* Item should be above balls */
        }

        /* --- Info Panel (Health & Controls) --- */
        .info-panel {
            width: 90vmin;
            max-width: 800px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px; /* More space */
            padding: 10px 0;
        }

        .player-status {
            padding: 10px 15px;
            width: 30%;
            font-size: 15px;
            text-align: center;
            background-color: #2c3e50; /* Consistent background */
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            line-height: 1.4;
        }
        
        .health-display {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            height: 35px; /* Taller for hearts */
            margin-top: 5px;
        }
        
        .heart {
            font-size: 22px; /* Larger hearts */
            margin: 0 3px;
            color: #e74c3c;
            transition: opacity 0.3s ease-in-out;
        }
        
        .heart.lost {
            color: #7f8c8d; /* Faded lost heart */
        }

        #customize-button {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #f39c12;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
            font-weight: bold;
            box-shadow: 0 4px #e67e22; /* 3D effect */
        }
        
        #customize-button:hover {
            background-color: #e67e22;
            transform: translateY(2px);
            box-shadow: 0 2px #d35400;
        }
        #customize-button:active {
            transform: translateY(4px);
            box-shadow: 0 0 #d35400;
        }

        /* --- Modals (Setup & Game Over) --- */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95); /* Darker overlay */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            backdrop-filter: blur(5px); /* Blurred background */
        }

        .modal-content {
            background-color: #2c3e50;
            padding: 40px;
            border-radius: 12px;
            text-align: center;
            width: 90%;
            max-width: 550px;
            box-shadow: 0 0 40px rgba(52, 152, 219, 0.7); /* Stronger glow */
            border: 2px solid #3498db;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        input[type="text"], button:not(#customize-button), .file-upload-label {
            margin: 10px 0;
            padding: 12px;
            width: 100%;
            box-sizing: border-box;
            border-radius: 6px;
            border: 1px solid #7f8c8d;
            background-color: #ecf0f1;
            color: #2c3e50;
            font-size: 16px;
        }

        .file-upload-label {
            display: inline-block;
            background-color: #2ecc71;
            color: white;
            cursor: pointer;
            text-align: center;
            border: none;
            transition: background-color 0.2s ease;
        }
        .file-upload-label:hover { background-color: #27ae60; }
        
        .file-preview {
            width: 70px; /* Larger preview */
            height: 70px;
            border-radius: 50%;
            background-color: #555;
            margin: 12px auto;
            background-size: cover;
            background-position: center;
            border: 3px solid #fff;
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.4);
        }

        #start-custom-game-button {
            background-color: #3498db;
            color: white;
            font-weight: bold;
            margin-top: 20px;
            box-shadow: 0 4px #2980b9;
        }
        #start-custom-game-button:hover { background-color: #2980b9; transform: translateY(2px); box-shadow: 0 2px #2c3e50; }
        #start-custom-game-button:active { transform: translateY(4px); box-shadow: 0 0 #2c3e50; }
        #start-custom-game-button:disabled {
            background-color: #5d7c99;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        .modal-content button {
            background-color: #7f8c8d; /* Grey for general modal buttons */
            color: white;
            font-weight: normal;
            margin-top: 10px;
            box-shadow: 0 4px #6c7a89;
        }
        .modal-content button:hover { background-color: #6c7a89; transform: translateY(2px); box-shadow: 0 2px #5a6671; }
        .modal-content button:active { transform: translateY(4px); box-shadow: 0 0 #5a6671; }

        /* --- Matter.js Canvas Hiding --- */
        #game-container canvas {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1; 
            display: none !important; /* Completely hide Matter.js default rendering */
        }
    </style>
</head>
<body>

    <div class="info-panel">
        <div id="p1-health-status" class="player-status">
            <h3 id="p1-name-display">Player 1 Health: 5/5</h3>
            <div id="p1-health" class="health-display"></div>
        </div>
        <button id="customize-button">New Game / Customize</button>
        <div id="p2-health-status" class="player-status">
            <h3 id="p2-name-display">Player 2 Health: 5/5</h3>
            <div id="p2-health" class="health-display"></div>
        </div>
    </div>

    <div id="game-container">
        <div id="ball1-display" class="ball-display-wrapper">
            <div id="ball1-emoji-fallback" class="ball-emoji-fallback" style="background-color: #FF5252;">üî¥</div>
            <div id="p1-sword-container" class="sword-container">
                 <span class="sword-icon sword-1">‚öîÔ∏è</span>
                 <span class="sword-icon sword-2">‚öîÔ∏è</span>
                 <span class="sword-icon sword-3">‚öîÔ∏è</span>
            </div>
        </div>
        
        <div id="ball2-display" class="ball-display-wrapper">
            <div id="ball2-emoji-fallback" class="ball-emoji-fallback" style="background-color: #2196F3;">üîµ</div>
            <div id="p2-sword-container" class="sword-container">
                <span class="sword-icon sword-1">‚öîÔ∏è</span>
                <span class="sword-icon sword-2">‚öîÔ∏è</span>
                <span class="sword-icon sword-3">‚öîÔ∏è</span>
            </div>
        </div>
        <div id="item-emoji">üó°Ô∏è</div> </div>

    <div id="setup-modal" class="modal" style="display: flex;">
        <div class="modal-content">
            <h2>Customize Game</h2>
            <div class="player-setup">
                <div>
                    <h3>Player 1 (üî¥)</h3>
                    <input type="text" id="p1-name-input" placeholder="Enter Name (e.g., Captain)">
                    <input type="file" id="p1-file" accept="image/*" style="display: none;">
                    <label for="p1-file" class="file-upload-label">Upload Photo</label>
                    <div id="p1-preview" class="file-preview"></div>
                </div>
                <div>
                    <h3>Player 2 (üîµ)</h3>
                    <input type="text" id="p2-name-input" placeholder="Enter Name (e.g., Iron Man)">
                    <input type="file" id="p2-file" accept="image/*" style="display: none;">
                    <label for="p2-file" class="file-upload-label">Upload Photo</label>
                    <div id="p2-preview" class="file-preview"></div>
                </div>
            </div>
            <button id="start-custom-game-button" disabled>Start Game</button>
        </div>
    </div>

    <div id="game-over-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <h2 id="winner-text"></h2>
            <div id="winner-emoji"></div>
            <button id="restart-button">Play Again (Same Settings)</button>
            <button id="new-game-button">Start New Game</button>
        </div>
    </div>

    <script>
        // Matter.js Modules
        const { Engine, Render, Runner, Bodies, Composite, Events, Body, Vector } = Matter;

        // --- GLOBAL CONSTANTS ---
        const MAX_HEALTH = 5;
        const BASE_SPEED = 4; // Default speed
        const KICK_DURATION = 500; // 0.5 seconds of boosted speed
        const KICK_SPEED = 10; // Speed when kicked
        const ITEM_RESPAWN_TIME = 3000; // Time before new item spawns
        let INITIAL_BALL_RADIUS = 40; // Initial ball size, will be responsive
        let arenaWidth = 800;
        let arenaHeight = 800;

        // --- GLOBAL VARIABLES ---
        let engine, runner, world, render;
        let ball1, ball2; // Matter.js bodies for balls
        let currentItem = null; // Matter.js body for the sword item
        let itemSpawnTimer = null; // Timer for item respawn
        let isGameOver = true;
        let kickTimer1 = null; // Timer to track kick duration for ball1
        let kickTimer2 = null; // Timer to track kick duration for ball2

        // --- SOUND FILES (Assumes local in the same directory as index.html) ---
        const knifeSounds = [ 'knife1.mp3', 'knife2.mp3', 'knife3.mp3' ];
        const audioCache = {}; // Cache to prevent re-loading audio

        // --- HTML Elements Mapping ---
        const gameContainer = document.getElementById('game-container');
        const p1NameDisplay = document.getElementById('p1-name-display');
        const p2NameDisplay = document.getElementById('p2-name-display');
        const itemEmojiDiv = document.getElementById('item-emoji');
        const p1HealthDisplay = document.getElementById('p1-health');
        const p2HealthDisplay = document.getElementById('p2-health');
        
        // Player Info Object - Centralized player data
        const playerInfo = {
            ball1: {
                id: 'ball1',
                name: 'Player 1',
                health: MAX_HEALTH,
                hasSword: false,
                texture: null, // Base64 image data
                emoji: 'üî¥',
                color: '#FF5252',
                displayDiv: document.getElementById('ball1-display'), // Outer div for ball visual
                emojiFallbackDiv: document.getElementById('ball1-emoji-fallback'), // Inner div for emoji
                nameDisplay: p1NameDisplay,
                healthDisplay: p1HealthDisplay,
                swordContainer: document.getElementById('p1-sword-container')
            },
            ball2: {
                id: 'ball2',
                name: 'Player 2',
                health: MAX_HEALTH,
                hasSword: false,
                texture: null,
                emoji: 'üîµ',
                color: '#2196F3',
                displayDiv: document.getElementById('ball2-display'),
                emojiFallbackDiv: document.getElementById('ball2-emoji-fallback'),
                nameDisplay: p2NameDisplay,
                healthDisplay: p2HealthDisplay,
                swordContainer: document.getElementById('p2-sword-container')
            }
        };

        // --- SOUND FUNCTIONS ---
        function loadAudio(src) {
            if (!audioCache[src]) {
                const audio = new Audio(src);
                audioCache[src] = audio;
            }
            return audioCache[src];
        }

        function playRandomKnifeSound() {
            const randomIndex = Math.floor(Math.random() * knifeSounds.length);
            const audio = loadAudio(knifeSounds[randomIndex]);
            
            // To ensure sound plays, sometimes it needs to be reset/cloned
            // due to browser autoplay policies or if it's currently playing.
            const clonedAudio = audio.cloneNode(); // Clone to allow multiple rapid plays
            clonedAudio.volume = 0.5;
            clonedAudio.play().catch(e => {
                console.warn("Sound playback prevented (browser policy?). User interaction may be needed for sounds to start.", e);
            });
        }

        // --- HEALTH AND VISUALS MANAGEMENT ---

        function renderHearts(player) {
            player.healthDisplay.innerHTML = '';
            for (let i = 0; i < MAX_HEALTH; i++) {
                const heart = document.createElement('span');
                heart.className = 'heart';
                heart.textContent = '‚ù§Ô∏è';
                if (i >= player.health) {
                    heart.classList.add('lost'); // Gray out lost hearts
                }
                player.healthDisplay.appendChild(heart);
            }
            player.nameDisplay.textContent = `${player.name} Health: ${player.health}/${MAX_HEALTH}`;
        }
        
        function updateHealthBar(p1, p1Health, p2, p2Health) {
            p1.health = p1Health;
            p2.health = p2Health;
            renderHearts(p1);
            renderHearts(p2);

            if (p1Health <= 0) endGame(p2);
            if (p2Health <= 0) endGame(p1);
        }

        function updateBallVisuals(player) {
            const ballDiameter = INITIAL_BALL_RADIUS * 2;
            player.displayDiv.style.width = `${ballDiameter}px`;
            player.displayDiv.style.height = `${ballDiameter}px`;
            
            if (player.texture) {
                player.displayDiv.style.backgroundImage = `url(${player.texture})`;
                player.emojiFallbackDiv.style.display = 'none'; // Hide emoji if photo exists
            } else {
                player.displayDiv.style.backgroundImage = 'none';
                player.emojiFallbackDiv.style.display = 'flex'; // Show emoji if no photo
                player.emojiFallbackDiv.style.backgroundColor = player.color;
            }
        }

        // --- ARENA AND GAME INITIALIZATION ---

        function updateArenaSize() {
            const container = gameContainer;
            const size = Math.min(container.clientWidth, container.clientHeight);
            
            arenaWidth = size;
            arenaHeight = size;
            INITIAL_BALL_RADIUS = size * 0.05; // Ball radius is 5% of arena size
            
            if (render) {
                render.canvas.width = arenaWidth;
                render.canvas.height = arenaHeight;
                render.options.width = arenaWidth;
                render.options.height = arenaHeight;
                Render.setPixelRatio(render, window.devicePixelRatio);
            }

            // Update visual size of balls and swords
            updateBallVisuals(playerInfo.ball1);
            updateBallVisuals(playerInfo.ball2);
            
            if (ball1 && ball2) {
                Body.set(ball1, 'circleRadius', INITIAL_BALL_RADIUS);
                Body.set(ball2, 'circleRadius', INITIAL_BALL_RADIUS);
            }

            if (world) setupWalls();
        }

        function setupWalls() {
            if (!world) return;
            // Remove existing walls to redraw them
            Composite.allBodies(world).forEach(body => {
                if (body.label === 'wall' || body.label === 'sword') {
                     Composite.remove(world, body);
                }
            });

            const wallThickness = 20; // Thickness of the arena walls

            const walls = [
                Bodies.rectangle(arenaWidth / 2, wallThickness / 2, arenaWidth, wallThickness, { isStatic: true, label: 'wall', render: { fillStyle: '#333' } }),
                Bodies.rectangle(arenaWidth / 2, arenaHeight - wallThickness / 2, arenaWidth, wallThickness, { isStatic: true, label: 'wall', render: { fillStyle: '#333' } }),
                Bodies.rectangle(wallThickness / 2, arenaHeight / 2, wallThickness, arenaHeight, { isStatic: true, label: 'wall', render: { fillStyle: '#333' } }),
                Bodies.rectangle(arenaWidth - wallThickness / 2, arenaHeight / 2, wallThickness, arenaHeight, { isStatic: true, label: 'wall', render: { fillStyle: '#333' } })
            ];
            Composite.add(world, walls);
        }

        function initializeGame() {
            // Setup Matter.js engine and world
            if (!engine) {
                engine = Engine.create();
                world = engine.world;
                world.gravity.y = 0; // No gravity
                world.gravity.x = 0;
            } else {
                // Clear existing bodies for a new game
                Engine.clear(engine);
                Composite.clear(world, false);
            }
            
            // Start Matter.js runner
            if (runner) Runner.stop(runner);
            runner = Runner.create();
            Runner.run(runner, engine);

            // Setup event listeners for Matter.js
            Events.off(engine, 'afterUpdate', afterUpdateHandler);
            Events.off(engine, 'collisionStart', collisionStartHandler);
            Events.on(engine, 'afterUpdate', afterUpdateHandler);
            Events.on(engine, 'collisionStart', collisionStartHandler);
            
            updateArenaSize(); // Set arena dimensions and walls
            setupWalls();

            // Setup Matter.js renderer (if not already created)
            if (!render) {
                render = Render.create({
                    element: gameContainer,
                    engine: engine,
                    options: {
                        width: arenaWidth,
                        height: arenaHeight,
                        wireframes: false, // Show textured bodies
                        background: 'transparent',
                        showAngleIndicator: false
                    }
                });
                Render.run(render);
            }
            
            // Reset game state
            ball1 = null; ball2 = null;
            currentItem = null;
            clearTimeout(itemSpawnTimer);
            itemEmojiDiv.style.display = 'none';

            playerInfo.ball1.health = MAX_HEALTH;
            playerInfo.ball2.health = MAX_HEALTH;
            playerInfo.ball1.hasSword = false;
            playerInfo.ball2.hasSword = false;
            
            // Define common ball properties
            const ballOptions = {
                restitution: 1, // High bounciness
                friction: 0, // No friction
                frictionAir: 0, // No air resistance
                density: 0.1, 
                inertia: Infinity, // No rotation from collisions
                label: 'ball', 
                render: { fillStyle: 'transparent', strokeStyle: 'transparent' } // Matter.js will render nothing
            };

            // Create ball bodies
            ball1 = Bodies.circle(arenaWidth / 3, arenaHeight / 2, INITIAL_BALL_RADIUS, { ...ballOptions, label: 'ball1', mass: 1, inverseMass: 1 });
            ball2 = Bodies.circle(arenaWidth * 2 / 3, arenaHeight / 2, INITIAL_BALL_RADIUS, { ...ballOptions, label: 'ball2', mass: 1, inverseMass: 1 });
            
            // Set initial velocities
            const speed = BASE_SPEED;
            const angle1 = Math.random() * Math.PI * 2; 
            const angle2 = Math.PI + Math.random() * Math.PI; 
            
            Body.setVelocity(ball1, { x: Math.cos(angle1) * speed, y: Math.sin(angle1) * speed });
            Body.setVelocity(ball2, { x: Math.cos(angle2) * speed, y: Math.sin(angle2) * speed });

            Composite.add(world, [ball1, ball2]); // Add balls to the world
            isGameOver = false;

            // Update UI
            updateHealthBar(playerInfo.ball1, MAX_HEALTH, playerInfo.ball2, MAX_HEALTH);
            updateBallVisuals(playerInfo.ball1);
            updateBallVisuals(playerInfo.ball2);

            setTimeout(spawnItem, 1000); // Spawn first item after a delay
        }

        // --- GAME LOOP & KICK MECHANICS ---

        function applyKick(ball, duration) {
            const currentVelocity = ball.velocity;
            const currentSpeed = Vector.magnitude(currentVelocity);

            if (currentSpeed > 0) {
                // Set velocity to KICK_SPEED in the current direction
                const newVelocity = Vector.mult(Vector.normalise(currentVelocity), KICK_SPEED);
                Body.setVelocity(ball, newVelocity);
            }
            
            // Clear any existing kick timer for this ball and set a new one
            const player = (ball === ball1) ? playerInfo.ball1 : playerInfo.ball2;
            if (player.id === 'ball1') {
                clearTimeout(kickTimer1);
                kickTimer1 = setTimeout(() => {
                    kickTimer1 = null; // Kick duration ended
                }, duration);
            } else {
                clearTimeout(kickTimer2);
                kickTimer2 = setTimeout(() => {
                    kickTimer2 = null; // Kick duration ended
                }, duration);
            }
        }
        
        // Matter.js `afterUpdate` event handler - Main game loop
        const afterUpdateHandler = function() {
            if (isGameOver || !ball1 || !ball2) return; 

            // Update item emoji position
            if (currentItem) {
                itemEmojiDiv.style.left = `${currentItem.position.x}px`;
                itemEmojiDiv.style.top = `${currentItem.position.y}px`;
            }

            // Update ball visual positions and sword visibility
            const updateBallDisplay = (ball, player) => {
                if (ball) {
                    // Position the HTML div to match Matter.js body
                    player.displayDiv.style.left = `${ball.position.x - INITIAL_BALL_RADIUS}px`;
                    player.displayDiv.style.top = `${ball.position.y - INITIAL_BALL_RADIUS}px
